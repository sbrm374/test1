<html>
<head>
<title>val.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
val.py</font>
</center></td></tr></table>
<pre><span class="s0"># YOLOv5 ðŸš€ by Ultralytics, AGPL-3.0 license</span>
<span class="s2">&quot;&quot;&quot; 
Validate a trained YOLOv5 detection model on a detection dataset. 
 
Usage: 
    $ python val.py --weights yolov5s.pt --data coco128.yaml --img 640 
 
Usage - formats: 
    $ python val.py --weights yolov5s.pt                 # PyTorch 
                              yolov5s.torchscript        # TorchScript 
                              yolov5s.onnx               # ONNX Runtime or OpenCV DNN with --dnn 
                              yolov5s_openvino_model     # OpenVINO 
                              yolov5s.engine             # TensorRT 
                              yolov5s.mlmodel            # CoreML (macOS-only) 
                              yolov5s_saved_model        # TensorFlow SavedModel 
                              yolov5s.pb                 # TensorFlow GraphDef 
                              yolov5s.tflite             # TensorFlow Lite 
                              yolov5s_edgetpu.tflite     # TensorFlow Edge TPU 
                              yolov5s_paddle_model       # PaddlePaddle 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">argparse</span>
<span class="s3">import </span><span class="s1">json</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">subprocess</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">from </span><span class="s1">pathlib </span><span class="s3">import </span><span class="s1">Path</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">torch</span>
<span class="s3">from </span><span class="s1">tqdm </span><span class="s3">import </span><span class="s1">tqdm</span>

<span class="s1">FILE </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">__file__</span><span class="s4">).</span><span class="s1">resolve</span><span class="s4">()</span>
<span class="s1">ROOT </span><span class="s4">= </span><span class="s1">FILE</span><span class="s4">.</span><span class="s1">parents</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]  </span><span class="s0"># YOLOv5 root directory</span>
<span class="s3">if </span><span class="s1">str</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">) </span><span class="s3">not in </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">path</span><span class="s4">:</span>
    <span class="s1">sys</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">))  </span><span class="s0"># add ROOT to PATH</span>
<span class="s1">ROOT </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">relpath</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">, </span><span class="s1">Path</span><span class="s4">.</span><span class="s1">cwd</span><span class="s4">()))  </span><span class="s0"># relative</span>

<span class="s3">from </span><span class="s1">models</span><span class="s4">.</span><span class="s1">common </span><span class="s3">import </span><span class="s1">DetectMultiBackend</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">callbacks </span><span class="s3">import </span><span class="s1">Callbacks</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">dataloaders </span><span class="s3">import </span><span class="s1">create_dataloader</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">general </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">LOGGER</span><span class="s4">,</span>
    <span class="s1">TQDM_BAR_FORMAT</span><span class="s4">,</span>
    <span class="s1">Profile</span><span class="s4">,</span>
    <span class="s1">check_dataset</span><span class="s4">,</span>
    <span class="s1">check_img_size</span><span class="s4">,</span>
    <span class="s1">check_requirements</span><span class="s4">,</span>
    <span class="s1">check_yaml</span><span class="s4">,</span>
    <span class="s1">coco80_to_coco91_class</span><span class="s4">,</span>
    <span class="s1">colorstr</span><span class="s4">,</span>
    <span class="s1">increment_path</span><span class="s4">,</span>
    <span class="s1">non_max_suppression</span><span class="s4">,</span>
    <span class="s1">print_args</span><span class="s4">,</span>
    <span class="s1">scale_boxes</span><span class="s4">,</span>
    <span class="s1">xywh2xyxy</span><span class="s4">,</span>
    <span class="s1">xyxy2xywh</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">metrics </span><span class="s3">import </span><span class="s1">ConfusionMatrix</span><span class="s4">, </span><span class="s1">ap_per_class</span><span class="s4">, </span><span class="s1">box_iou</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">plots </span><span class="s3">import </span><span class="s1">output_to_target</span><span class="s4">, </span><span class="s1">plot_images</span><span class="s4">, </span><span class="s1">plot_val_study</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">torch_utils </span><span class="s3">import </span><span class="s1">select_device</span><span class="s4">, </span><span class="s1">smart_inference_mode</span>


<span class="s3">def </span><span class="s1">save_one_txt</span><span class="s4">(</span><span class="s1">predn</span><span class="s4">, </span><span class="s1">save_conf</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">file</span><span class="s4">):</span>
    <span class="s0"># Save one txt result</span>
    <span class="s1">gn </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">tensor</span><span class="s4">(</span><span class="s1">shape</span><span class="s4">)[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">]]  </span><span class="s0"># normalization gain whwh</span>
    <span class="s3">for </span><span class="s4">*</span><span class="s1">xyxy</span><span class="s4">, </span><span class="s1">conf</span><span class="s4">, </span><span class="s1">cls </span><span class="s3">in </span><span class="s1">predn</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">():</span>
        <span class="s1">xywh </span><span class="s4">= (</span><span class="s1">xyxy2xywh</span><span class="s4">(</span><span class="s1">torch</span><span class="s4">.</span><span class="s1">tensor</span><span class="s4">(</span><span class="s1">xyxy</span><span class="s4">).</span><span class="s1">view</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">)) / </span><span class="s1">gn</span><span class="s4">).</span><span class="s1">view</span><span class="s4">(-</span><span class="s5">1</span><span class="s4">).</span><span class="s1">tolist</span><span class="s4">()  </span><span class="s0"># normalized xywh</span>
        <span class="s1">line </span><span class="s4">= (</span><span class="s1">cls</span><span class="s4">, *</span><span class="s1">xywh</span><span class="s4">, </span><span class="s1">conf</span><span class="s4">) </span><span class="s3">if </span><span class="s1">save_conf </span><span class="s3">else </span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, *</span><span class="s1">xywh</span><span class="s4">)  </span><span class="s0"># label format</span>
        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">file</span><span class="s4">, </span><span class="s6">&quot;a&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">write</span><span class="s4">((</span><span class="s6">&quot;%g &quot; </span><span class="s4">* </span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">)).</span><span class="s1">rstrip</span><span class="s4">() % </span><span class="s1">line </span><span class="s4">+ </span><span class="s6">&quot;</span><span class="s3">\n</span><span class="s6">&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">save_one_json</span><span class="s4">(</span><span class="s1">predn</span><span class="s4">, </span><span class="s1">jdict</span><span class="s4">, </span><span class="s1">path</span><span class="s4">, </span><span class="s1">class_map</span><span class="s4">):</span>
    <span class="s0"># Save one JSON result {&quot;image_id&quot;: 42, &quot;category_id&quot;: 18, &quot;bbox&quot;: [258.15, 41.29, 348.26, 243.78], &quot;score&quot;: 0.236}</span>
    <span class="s1">image_id </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">path</span><span class="s4">.</span><span class="s1">stem</span><span class="s4">) </span><span class="s3">if </span><span class="s1">path</span><span class="s4">.</span><span class="s1">stem</span><span class="s4">.</span><span class="s1">isnumeric</span><span class="s4">() </span><span class="s3">else </span><span class="s1">path</span><span class="s4">.</span><span class="s1">stem</span>
    <span class="s1">box </span><span class="s4">= </span><span class="s1">xyxy2xywh</span><span class="s4">(</span><span class="s1">predn</span><span class="s4">[:, :</span><span class="s5">4</span><span class="s4">])  </span><span class="s0"># xywh</span>
    <span class="s1">box</span><span class="s4">[:, :</span><span class="s5">2</span><span class="s4">] -= </span><span class="s1">box</span><span class="s4">[:, </span><span class="s5">2</span><span class="s4">:] / </span><span class="s5">2  </span><span class="s0"># xy center to top-left corner</span>
    <span class="s3">for </span><span class="s1">p</span><span class="s4">, </span><span class="s1">b </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">predn</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), </span><span class="s1">box</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">()):</span>
        <span class="s1">jdict</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
            <span class="s4">{</span>
                <span class="s6">&quot;image_id&quot;</span><span class="s4">: </span><span class="s1">image_id</span><span class="s4">,</span>
                <span class="s6">&quot;category_id&quot;</span><span class="s4">: </span><span class="s1">class_map</span><span class="s4">[</span><span class="s1">int</span><span class="s4">(</span><span class="s1">p</span><span class="s4">[</span><span class="s5">5</span><span class="s4">])],</span>
                <span class="s6">&quot;bbox&quot;</span><span class="s4">: [</span><span class="s1">round</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s5">3</span><span class="s4">) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">b</span><span class="s4">],</span>
                <span class="s6">&quot;score&quot;</span><span class="s4">: </span><span class="s1">round</span><span class="s4">(</span><span class="s1">p</span><span class="s4">[</span><span class="s5">4</span><span class="s4">], </span><span class="s5">5</span><span class="s4">),</span>
            <span class="s4">}</span>
        <span class="s4">)</span>


<span class="s3">def </span><span class="s1">process_batch</span><span class="s4">(</span><span class="s1">detections</span><span class="s4">, </span><span class="s1">labels</span><span class="s4">, </span><span class="s1">iouv</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Return correct prediction matrix. 
 
    Arguments: 
        detections (array[N, 6]), x1, y1, x2, y2, conf, class 
        labels (array[M, 5]), class, x1, y1, x2, y2 
    Returns: 
        correct (array[N, 10]), for 10 IoU levels 
    &quot;&quot;&quot;</span>
    <span class="s1">correct </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">((</span><span class="s1">detections</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">iouv</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])).</span><span class="s1">astype</span><span class="s4">(</span><span class="s1">bool</span><span class="s4">)</span>
    <span class="s1">iou </span><span class="s4">= </span><span class="s1">box_iou</span><span class="s4">(</span><span class="s1">labels</span><span class="s4">[:, </span><span class="s5">1</span><span class="s4">:], </span><span class="s1">detections</span><span class="s4">[:, :</span><span class="s5">4</span><span class="s4">])</span>
    <span class="s1">correct_class </span><span class="s4">= </span><span class="s1">labels</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">:</span><span class="s5">1</span><span class="s4">] == </span><span class="s1">detections</span><span class="s4">[:, </span><span class="s5">5</span><span class="s4">]</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">iouv</span><span class="s4">)):</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">where</span><span class="s4">((</span><span class="s1">iou </span><span class="s4">&gt;= </span><span class="s1">iouv</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]) &amp; </span><span class="s1">correct_class</span><span class="s4">)  </span><span class="s0"># IoU &gt; threshold and classes match</span>
        <span class="s3">if </span><span class="s1">x</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]:</span>
            <span class="s1">matches </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cat</span><span class="s4">((</span><span class="s1">torch</span><span class="s4">.</span><span class="s1">stack</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s5">1</span><span class="s4">), </span><span class="s1">iou</span><span class="s4">[</span><span class="s1">x</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">x</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]][:, </span><span class="s3">None</span><span class="s4">]), </span><span class="s5">1</span><span class="s4">).</span><span class="s1">cpu</span><span class="s4">().</span><span class="s1">numpy</span><span class="s4">()  </span><span class="s0"># [label, detect, iou]</span>
            <span class="s3">if </span><span class="s1">x</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] &gt; </span><span class="s5">1</span><span class="s4">:</span>
                <span class="s1">matches </span><span class="s4">= </span><span class="s1">matches</span><span class="s4">[</span><span class="s1">matches</span><span class="s4">[:, </span><span class="s5">2</span><span class="s4">].</span><span class="s1">argsort</span><span class="s4">()[::-</span><span class="s5">1</span><span class="s4">]]</span>
                <span class="s1">matches </span><span class="s4">= </span><span class="s1">matches</span><span class="s4">[</span><span class="s1">np</span><span class="s4">.</span><span class="s1">unique</span><span class="s4">(</span><span class="s1">matches</span><span class="s4">[:, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">return_index</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)[</span><span class="s5">1</span><span class="s4">]]</span>
                <span class="s0"># matches = matches[matches[:, 2].argsort()[::-1]]</span>
                <span class="s1">matches </span><span class="s4">= </span><span class="s1">matches</span><span class="s4">[</span><span class="s1">np</span><span class="s4">.</span><span class="s1">unique</span><span class="s4">(</span><span class="s1">matches</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">], </span><span class="s1">return_index</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)[</span><span class="s5">1</span><span class="s4">]]</span>
            <span class="s1">correct</span><span class="s4">[</span><span class="s1">matches</span><span class="s4">[:, </span><span class="s5">1</span><span class="s4">].</span><span class="s1">astype</span><span class="s4">(</span><span class="s1">int</span><span class="s4">), </span><span class="s1">i</span><span class="s4">] = </span><span class="s3">True</span>
    <span class="s3">return </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">tensor</span><span class="s4">(</span><span class="s1">correct</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">torch</span><span class="s4">.</span><span class="s1">bool</span><span class="s4">, </span><span class="s1">device</span><span class="s4">=</span><span class="s1">iouv</span><span class="s4">.</span><span class="s1">device</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">smart_inference_mode</span><span class="s4">()</span>
<span class="s3">def </span><span class="s1">run</span><span class="s4">(</span>
    <span class="s1">data</span><span class="s4">,</span>
    <span class="s1">weights</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,  </span><span class="s0"># model.pt path(s)</span>
    <span class="s1">batch_size</span><span class="s4">=</span><span class="s5">32</span><span class="s4">,  </span><span class="s0"># batch size</span>
    <span class="s1">imgsz</span><span class="s4">=</span><span class="s5">640</span><span class="s4">,  </span><span class="s0"># inference size (pixels)</span>
    <span class="s1">conf_thres</span><span class="s4">=</span><span class="s5">0.001</span><span class="s4">,  </span><span class="s0"># confidence threshold</span>
    <span class="s1">iou_thres</span><span class="s4">=</span><span class="s5">0.6</span><span class="s4">,  </span><span class="s0"># NMS IoU threshold</span>
    <span class="s1">max_det</span><span class="s4">=</span><span class="s5">300</span><span class="s4">,  </span><span class="s0"># maximum detections per image</span>
    <span class="s1">task</span><span class="s4">=</span><span class="s6">&quot;val&quot;</span><span class="s4">,  </span><span class="s0"># train, val, test, speed or study</span>
    <span class="s1">device</span><span class="s4">=</span><span class="s6">&quot;&quot;</span><span class="s4">,  </span><span class="s0"># cuda device, i.e. 0 or 0,1,2,3 or cpu</span>
    <span class="s1">workers</span><span class="s4">=</span><span class="s5">8</span><span class="s4">,  </span><span class="s0"># max dataloader workers (per RANK in DDP mode)</span>
    <span class="s1">single_cls</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># treat as single-class dataset</span>
    <span class="s1">augment</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># augmented inference</span>
    <span class="s1">verbose</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># verbose output</span>
    <span class="s1">save_txt</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># save results to *.txt</span>
    <span class="s1">save_hybrid</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># save label+prediction hybrid results to *.txt</span>
    <span class="s1">save_conf</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># save confidences in --save-txt labels</span>
    <span class="s1">save_json</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># save a COCO-JSON results file</span>
    <span class="s1">project</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;runs/val&quot;</span><span class="s4">,  </span><span class="s0"># save to project/name</span>
    <span class="s1">name</span><span class="s4">=</span><span class="s6">&quot;exp&quot;</span><span class="s4">,  </span><span class="s0"># save to project/name</span>
    <span class="s1">exist_ok</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># existing project/name ok, do not increment</span>
    <span class="s1">half</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,  </span><span class="s0"># use FP16 half-precision inference</span>
    <span class="s1">dnn</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># use OpenCV DNN for ONNX inference</span>
    <span class="s1">model</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">dataloader</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">save_dir</span><span class="s4">=</span><span class="s1">Path</span><span class="s4">(</span><span class="s6">&quot;&quot;</span><span class="s4">),</span>
    <span class="s1">plots</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
    <span class="s1">callbacks</span><span class="s4">=</span><span class="s1">Callbacks</span><span class="s4">(),</span>
    <span class="s1">compute_loss</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">):</span>
    <span class="s0"># Initialize/load model and set device</span>
    <span class="s1">training </span><span class="s4">= </span><span class="s1">model </span><span class="s3">is not None</span>
    <span class="s3">if </span><span class="s1">training</span><span class="s4">:  </span><span class="s0"># called by train.py</span>
        <span class="s1">device</span><span class="s4">, </span><span class="s1">pt</span><span class="s4">, </span><span class="s1">jit</span><span class="s4">, </span><span class="s1">engine </span><span class="s4">= </span><span class="s1">next</span><span class="s4">(</span><span class="s1">model</span><span class="s4">.</span><span class="s1">parameters</span><span class="s4">()).</span><span class="s1">device</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False  </span><span class="s0"># get model device, PyTorch model</span>
        <span class="s1">half </span><span class="s4">&amp;= </span><span class="s1">device</span><span class="s4">.</span><span class="s1">type </span><span class="s4">!= </span><span class="s6">&quot;cpu&quot;  </span><span class="s0"># half precision only supported on CUDA</span>
        <span class="s1">model</span><span class="s4">.</span><span class="s1">half</span><span class="s4">() </span><span class="s3">if </span><span class="s1">half </span><span class="s3">else </span><span class="s1">model</span><span class="s4">.</span><span class="s1">float</span><span class="s4">()</span>
    <span class="s3">else</span><span class="s4">:  </span><span class="s0"># called directly</span>
        <span class="s1">device </span><span class="s4">= </span><span class="s1">select_device</span><span class="s4">(</span><span class="s1">device</span><span class="s4">, </span><span class="s1">batch_size</span><span class="s4">=</span><span class="s1">batch_size</span><span class="s4">)</span>

        <span class="s0"># Directories</span>
        <span class="s1">save_dir </span><span class="s4">= </span><span class="s1">increment_path</span><span class="s4">(</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">project</span><span class="s4">) / </span><span class="s1">name</span><span class="s4">, </span><span class="s1">exist_ok</span><span class="s4">=</span><span class="s1">exist_ok</span><span class="s4">)  </span><span class="s0"># increment run</span>
        <span class="s4">(</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;labels&quot; </span><span class="s3">if </span><span class="s1">save_txt </span><span class="s3">else </span><span class="s1">save_dir</span><span class="s4">).</span><span class="s1">mkdir</span><span class="s4">(</span><span class="s1">parents</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">exist_ok</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)  </span><span class="s0"># make dir</span>

        <span class="s0"># Load model</span>
        <span class="s1">model </span><span class="s4">= </span><span class="s1">DetectMultiBackend</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">, </span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">, </span><span class="s1">dnn</span><span class="s4">=</span><span class="s1">dnn</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">data</span><span class="s4">, </span><span class="s1">fp16</span><span class="s4">=</span><span class="s1">half</span><span class="s4">)</span>
        <span class="s1">stride</span><span class="s4">, </span><span class="s1">pt</span><span class="s4">, </span><span class="s1">jit</span><span class="s4">, </span><span class="s1">engine </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">stride</span><span class="s4">, </span><span class="s1">model</span><span class="s4">.</span><span class="s1">pt</span><span class="s4">, </span><span class="s1">model</span><span class="s4">.</span><span class="s1">jit</span><span class="s4">, </span><span class="s1">model</span><span class="s4">.</span><span class="s1">engine</span>
        <span class="s1">imgsz </span><span class="s4">= </span><span class="s1">check_img_size</span><span class="s4">(</span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">s</span><span class="s4">=</span><span class="s1">stride</span><span class="s4">)  </span><span class="s0"># check image size</span>
        <span class="s1">half </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">fp16  </span><span class="s0"># FP16 supported on limited backends with CUDA</span>
        <span class="s3">if </span><span class="s1">engine</span><span class="s4">:</span>
            <span class="s1">batch_size </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">batch_size</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">device </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">device</span>
            <span class="s3">if not </span><span class="s4">(</span><span class="s1">pt </span><span class="s3">or </span><span class="s1">jit</span><span class="s4">):</span>
                <span class="s1">batch_size </span><span class="s4">= </span><span class="s5">1  </span><span class="s0"># export.py models default to batch-size 1</span>
                <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;Forcing --batch-size 1 square inference (1,3,</span><span class="s3">{</span><span class="s1">imgsz</span><span class="s3">}</span><span class="s6">,</span><span class="s3">{</span><span class="s1">imgsz</span><span class="s3">}</span><span class="s6">) for non-PyTorch models&quot;</span><span class="s4">)</span>

        <span class="s0"># Data</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">check_dataset</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)  </span><span class="s0"># check</span>

    <span class="s0"># Configure</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">eval</span><span class="s4">()</span>
    <span class="s1">cuda </span><span class="s4">= </span><span class="s1">device</span><span class="s4">.</span><span class="s1">type </span><span class="s4">!= </span><span class="s6">&quot;cpu&quot;</span>
    <span class="s1">is_coco </span><span class="s4">= </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">data</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">&quot;val&quot;</span><span class="s4">), </span><span class="s1">str</span><span class="s4">) </span><span class="s3">and </span><span class="s1">data</span><span class="s4">[</span><span class="s6">&quot;val&quot;</span><span class="s4">].</span><span class="s1">endswith</span><span class="s4">(</span><span class="s6">f&quot;coco</span><span class="s3">{</span><span class="s1">os</span><span class="s4">.</span><span class="s1">sep</span><span class="s3">}</span><span class="s6">val2017.txt&quot;</span><span class="s4">)  </span><span class="s0"># COCO dataset</span>
    <span class="s1">nc </span><span class="s4">= </span><span class="s5">1 </span><span class="s3">if </span><span class="s1">single_cls </span><span class="s3">else </span><span class="s1">int</span><span class="s4">(</span><span class="s1">data</span><span class="s4">[</span><span class="s6">&quot;nc&quot;</span><span class="s4">])  </span><span class="s0"># number of classes</span>
    <span class="s1">iouv </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">linspace</span><span class="s4">(</span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">0.95</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">)  </span><span class="s0"># iou vector for mAP@0.5:0.95</span>
    <span class="s1">niou </span><span class="s4">= </span><span class="s1">iouv</span><span class="s4">.</span><span class="s1">numel</span><span class="s4">()</span>

    <span class="s0"># Dataloader</span>
    <span class="s3">if not </span><span class="s1">training</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">pt </span><span class="s3">and not </span><span class="s1">single_cls</span><span class="s4">:  </span><span class="s0"># check --weights are trained on --data</span>
            <span class="s1">ncm </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">model</span><span class="s4">.</span><span class="s1">nc</span>
            <span class="s3">assert </span><span class="s1">ncm </span><span class="s4">== </span><span class="s1">nc</span><span class="s4">, (</span>
                <span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">weights</span><span class="s3">} </span><span class="s6">(</span><span class="s3">{</span><span class="s1">ncm</span><span class="s3">} </span><span class="s6">classes) trained on different --data than what you passed (</span><span class="s3">{</span><span class="s1">nc</span><span class="s3">} </span><span class="s6">&quot;</span>
                <span class="s6">f&quot;classes). Pass correct combination of --weights and --data that are trained together.&quot;</span>
            <span class="s4">)</span>
        <span class="s1">model</span><span class="s4">.</span><span class="s1">warmup</span><span class="s4">(</span><span class="s1">imgsz</span><span class="s4">=(</span><span class="s5">1 </span><span class="s3">if </span><span class="s1">pt </span><span class="s3">else </span><span class="s1">batch_size</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">imgsz</span><span class="s4">))  </span><span class="s0"># warmup</span>
        <span class="s1">pad</span><span class="s4">, </span><span class="s1">rect </span><span class="s4">= (</span><span class="s5">0.0</span><span class="s4">, </span><span class="s3">False</span><span class="s4">) </span><span class="s3">if </span><span class="s1">task </span><span class="s4">== </span><span class="s6">&quot;speed&quot; </span><span class="s3">else </span><span class="s4">(</span><span class="s5">0.5</span><span class="s4">, </span><span class="s1">pt</span><span class="s4">)  </span><span class="s0"># square inference for benchmarks</span>
        <span class="s1">task </span><span class="s4">= </span><span class="s1">task </span><span class="s3">if </span><span class="s1">task </span><span class="s3">in </span><span class="s4">(</span><span class="s6">&quot;train&quot;</span><span class="s4">, </span><span class="s6">&quot;val&quot;</span><span class="s4">, </span><span class="s6">&quot;test&quot;</span><span class="s4">) </span><span class="s3">else </span><span class="s6">&quot;val&quot;  </span><span class="s0"># path to train/val/test images</span>
        <span class="s1">dataloader </span><span class="s4">= </span><span class="s1">create_dataloader</span><span class="s4">(</span>
            <span class="s1">data</span><span class="s4">[</span><span class="s1">task</span><span class="s4">],</span>
            <span class="s1">imgsz</span><span class="s4">,</span>
            <span class="s1">batch_size</span><span class="s4">,</span>
            <span class="s1">stride</span><span class="s4">,</span>
            <span class="s1">single_cls</span><span class="s4">,</span>
            <span class="s1">pad</span><span class="s4">=</span><span class="s1">pad</span><span class="s4">,</span>
            <span class="s1">rect</span><span class="s4">=</span><span class="s1">rect</span><span class="s4">,</span>
            <span class="s1">workers</span><span class="s4">=</span><span class="s1">workers</span><span class="s4">,</span>
            <span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">task</span><span class="s3">}</span><span class="s6">: &quot;</span><span class="s4">),</span>
        <span class="s4">)[</span><span class="s5">0</span><span class="s4">]</span>

    <span class="s1">seen </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">confusion_matrix </span><span class="s4">= </span><span class="s1">ConfusionMatrix</span><span class="s4">(</span><span class="s1">nc</span><span class="s4">=</span><span class="s1">nc</span><span class="s4">)</span>
    <span class="s1">names </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">names </span><span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s6">&quot;names&quot;</span><span class="s4">) </span><span class="s3">else </span><span class="s1">model</span><span class="s4">.</span><span class="s1">module</span><span class="s4">.</span><span class="s1">names  </span><span class="s0"># get class names</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">names</span><span class="s4">, (</span><span class="s1">list</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">)):  </span><span class="s0"># old format</span>
        <span class="s1">names </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">(</span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">names</span><span class="s4">))</span>
    <span class="s1">class_map </span><span class="s4">= </span><span class="s1">coco80_to_coco91_class</span><span class="s4">() </span><span class="s3">if </span><span class="s1">is_coco </span><span class="s3">else </span><span class="s1">list</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s5">1000</span><span class="s4">))</span>
    <span class="s1">s </span><span class="s4">= (</span><span class="s6">&quot;%22s&quot; </span><span class="s4">+ </span><span class="s6">&quot;%11s&quot; </span><span class="s4">* </span><span class="s5">6</span><span class="s4">) % (</span><span class="s6">&quot;Class&quot;</span><span class="s4">, </span><span class="s6">&quot;Images&quot;</span><span class="s4">, </span><span class="s6">&quot;Instances&quot;</span><span class="s4">, </span><span class="s6">&quot;P&quot;</span><span class="s4">, </span><span class="s6">&quot;R&quot;</span><span class="s4">, </span><span class="s6">&quot;mAP50&quot;</span><span class="s4">, </span><span class="s6">&quot;mAP50-95&quot;</span><span class="s4">)</span>
    <span class="s1">tp</span><span class="s4">, </span><span class="s1">fp</span><span class="s4">, </span><span class="s1">p</span><span class="s4">, </span><span class="s1">r</span><span class="s4">, </span><span class="s1">f1</span><span class="s4">, </span><span class="s1">mp</span><span class="s4">, </span><span class="s1">mr</span><span class="s4">, </span><span class="s1">map50</span><span class="s4">, </span><span class="s1">ap50</span><span class="s4">, </span><span class="s1">map </span><span class="s4">= </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.0</span>
    <span class="s1">dt </span><span class="s4">= </span><span class="s1">Profile</span><span class="s4">(</span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">), </span><span class="s1">Profile</span><span class="s4">(</span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">), </span><span class="s1">Profile</span><span class="s4">(</span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">)  </span><span class="s0"># profiling times</span>
    <span class="s1">loss </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">)</span>
    <span class="s1">jdict</span><span class="s4">, </span><span class="s1">stats</span><span class="s4">, </span><span class="s1">ap</span><span class="s4">, </span><span class="s1">ap_class </span><span class="s4">= [], [], [], []</span>
    <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_val_start&quot;</span><span class="s4">)</span>
    <span class="s1">pbar </span><span class="s4">= </span><span class="s1">tqdm</span><span class="s4">(</span><span class="s1">dataloader</span><span class="s4">, </span><span class="s1">desc</span><span class="s4">=</span><span class="s1">s</span><span class="s4">, </span><span class="s1">bar_format</span><span class="s4">=</span><span class="s1">TQDM_BAR_FORMAT</span><span class="s4">)  </span><span class="s0"># progress bar</span>
    <span class="s3">for </span><span class="s1">batch_i</span><span class="s4">, (</span><span class="s1">im</span><span class="s4">, </span><span class="s1">targets</span><span class="s4">, </span><span class="s1">paths</span><span class="s4">, </span><span class="s1">shapes</span><span class="s4">) </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">pbar</span><span class="s4">):</span>
        <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_val_batch_start&quot;</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">dt</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]:</span>
            <span class="s3">if </span><span class="s1">cuda</span><span class="s4">:</span>
                <span class="s1">im </span><span class="s4">= </span><span class="s1">im</span><span class="s4">.</span><span class="s1">to</span><span class="s4">(</span><span class="s1">device</span><span class="s4">, </span><span class="s1">non_blocking</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
                <span class="s1">targets </span><span class="s4">= </span><span class="s1">targets</span><span class="s4">.</span><span class="s1">to</span><span class="s4">(</span><span class="s1">device</span><span class="s4">)</span>
            <span class="s1">im </span><span class="s4">= </span><span class="s1">im</span><span class="s4">.</span><span class="s1">half</span><span class="s4">() </span><span class="s3">if </span><span class="s1">half </span><span class="s3">else </span><span class="s1">im</span><span class="s4">.</span><span class="s1">float</span><span class="s4">()  </span><span class="s0"># uint8 to fp16/32</span>
            <span class="s1">im </span><span class="s4">/= </span><span class="s5">255  </span><span class="s0"># 0 - 255 to 0.0 - 1.0</span>
            <span class="s1">nb</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">height</span><span class="s4">, </span><span class="s1">width </span><span class="s4">= </span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape  </span><span class="s0"># batch size, channels, height, width</span>

        <span class="s0"># Inference</span>
        <span class="s3">with </span><span class="s1">dt</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]:</span>
            <span class="s1">preds</span><span class="s4">, </span><span class="s1">train_out </span><span class="s4">= </span><span class="s1">model</span><span class="s4">(</span><span class="s1">im</span><span class="s4">) </span><span class="s3">if </span><span class="s1">compute_loss </span><span class="s3">else </span><span class="s4">(</span><span class="s1">model</span><span class="s4">(</span><span class="s1">im</span><span class="s4">, </span><span class="s1">augment</span><span class="s4">=</span><span class="s1">augment</span><span class="s4">), </span><span class="s3">None</span><span class="s4">)</span>

        <span class="s0"># Loss</span>
        <span class="s3">if </span><span class="s1">compute_loss</span><span class="s4">:</span>
            <span class="s1">loss </span><span class="s4">+= </span><span class="s1">compute_loss</span><span class="s4">(</span><span class="s1">train_out</span><span class="s4">, </span><span class="s1">targets</span><span class="s4">)[</span><span class="s5">1</span><span class="s4">]  </span><span class="s0"># box, obj, cls</span>

        <span class="s0"># NMS</span>
        <span class="s1">targets</span><span class="s4">[:, </span><span class="s5">2</span><span class="s4">:] *= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">tensor</span><span class="s4">((</span><span class="s1">width</span><span class="s4">, </span><span class="s1">height</span><span class="s4">, </span><span class="s1">width</span><span class="s4">, </span><span class="s1">height</span><span class="s4">), </span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">)  </span><span class="s0"># to pixels</span>
        <span class="s1">lb </span><span class="s4">= [</span><span class="s1">targets</span><span class="s4">[</span><span class="s1">targets</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">] == </span><span class="s1">i</span><span class="s4">, </span><span class="s5">1</span><span class="s4">:] </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">nb</span><span class="s4">)] </span><span class="s3">if </span><span class="s1">save_hybrid </span><span class="s3">else </span><span class="s4">[]  </span><span class="s0"># for autolabelling</span>
        <span class="s3">with </span><span class="s1">dt</span><span class="s4">[</span><span class="s5">2</span><span class="s4">]:</span>
            <span class="s1">preds </span><span class="s4">= </span><span class="s1">non_max_suppression</span><span class="s4">(</span>
                <span class="s1">preds</span><span class="s4">, </span><span class="s1">conf_thres</span><span class="s4">, </span><span class="s1">iou_thres</span><span class="s4">, </span><span class="s1">labels</span><span class="s4">=</span><span class="s1">lb</span><span class="s4">, </span><span class="s1">multi_label</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">agnostic</span><span class="s4">=</span><span class="s1">single_cls</span><span class="s4">, </span><span class="s1">max_det</span><span class="s4">=</span><span class="s1">max_det</span>
            <span class="s4">)</span>

        <span class="s0"># Metrics</span>
        <span class="s3">for </span><span class="s1">si</span><span class="s4">, </span><span class="s1">pred </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">preds</span><span class="s4">):</span>
            <span class="s1">labels </span><span class="s4">= </span><span class="s1">targets</span><span class="s4">[</span><span class="s1">targets</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">] == </span><span class="s1">si</span><span class="s4">, </span><span class="s5">1</span><span class="s4">:]</span>
            <span class="s1">nl</span><span class="s4">, </span><span class="s1">npr </span><span class="s4">= </span><span class="s1">labels</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">pred</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]  </span><span class="s0"># number of labels, predictions</span>
            <span class="s1">path</span><span class="s4">, </span><span class="s1">shape </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">paths</span><span class="s4">[</span><span class="s1">si</span><span class="s4">]), </span><span class="s1">shapes</span><span class="s4">[</span><span class="s1">si</span><span class="s4">][</span><span class="s5">0</span><span class="s4">]</span>
            <span class="s1">correct </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">(</span><span class="s1">npr</span><span class="s4">, </span><span class="s1">niou</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">torch</span><span class="s4">.</span><span class="s1">bool</span><span class="s4">, </span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">)  </span><span class="s0"># init</span>
            <span class="s1">seen </span><span class="s4">+= </span><span class="s5">1</span>

            <span class="s3">if </span><span class="s1">npr </span><span class="s4">== </span><span class="s5">0</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">nl</span><span class="s4">:</span>
                    <span class="s1">stats</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s1">correct</span><span class="s4">, *</span><span class="s1">torch</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">((</span><span class="s5">2</span><span class="s4">, </span><span class="s5">0</span><span class="s4">), </span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">), </span><span class="s1">labels</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">]))</span>
                    <span class="s3">if </span><span class="s1">plots</span><span class="s4">:</span>
                        <span class="s1">confusion_matrix</span><span class="s4">.</span><span class="s1">process_batch</span><span class="s4">(</span><span class="s1">detections</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">labels</span><span class="s4">=</span><span class="s1">labels</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">])</span>
                <span class="s3">continue</span>

            <span class="s0"># Predictions</span>
            <span class="s3">if </span><span class="s1">single_cls</span><span class="s4">:</span>
                <span class="s1">pred</span><span class="s4">[:, </span><span class="s5">5</span><span class="s4">] = </span><span class="s5">0</span>
            <span class="s1">predn </span><span class="s4">= </span><span class="s1">pred</span><span class="s4">.</span><span class="s1">clone</span><span class="s4">()</span>
            <span class="s1">scale_boxes</span><span class="s4">(</span><span class="s1">im</span><span class="s4">[</span><span class="s1">si</span><span class="s4">].</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:], </span><span class="s1">predn</span><span class="s4">[:, :</span><span class="s5">4</span><span class="s4">], </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">shapes</span><span class="s4">[</span><span class="s1">si</span><span class="s4">][</span><span class="s5">1</span><span class="s4">])  </span><span class="s0"># native-space pred</span>

            <span class="s0"># Evaluate</span>
            <span class="s3">if </span><span class="s1">nl</span><span class="s4">:</span>
                <span class="s1">tbox </span><span class="s4">= </span><span class="s1">xywh2xyxy</span><span class="s4">(</span><span class="s1">labels</span><span class="s4">[:, </span><span class="s5">1</span><span class="s4">:</span><span class="s5">5</span><span class="s4">])  </span><span class="s0"># target boxes</span>
                <span class="s1">scale_boxes</span><span class="s4">(</span><span class="s1">im</span><span class="s4">[</span><span class="s1">si</span><span class="s4">].</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:], </span><span class="s1">tbox</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">shapes</span><span class="s4">[</span><span class="s1">si</span><span class="s4">][</span><span class="s5">1</span><span class="s4">])  </span><span class="s0"># native-space labels</span>
                <span class="s1">labelsn </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cat</span><span class="s4">((</span><span class="s1">labels</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">:</span><span class="s5">1</span><span class="s4">], </span><span class="s1">tbox</span><span class="s4">), </span><span class="s5">1</span><span class="s4">)  </span><span class="s0"># native-space labels</span>
                <span class="s1">correct </span><span class="s4">= </span><span class="s1">process_batch</span><span class="s4">(</span><span class="s1">predn</span><span class="s4">, </span><span class="s1">labelsn</span><span class="s4">, </span><span class="s1">iouv</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">plots</span><span class="s4">:</span>
                    <span class="s1">confusion_matrix</span><span class="s4">.</span><span class="s1">process_batch</span><span class="s4">(</span><span class="s1">predn</span><span class="s4">, </span><span class="s1">labelsn</span><span class="s4">)</span>
            <span class="s1">stats</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s1">correct</span><span class="s4">, </span><span class="s1">pred</span><span class="s4">[:, </span><span class="s5">4</span><span class="s4">], </span><span class="s1">pred</span><span class="s4">[:, </span><span class="s5">5</span><span class="s4">], </span><span class="s1">labels</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">]))  </span><span class="s0"># (correct, conf, pcls, tcls)</span>

            <span class="s0"># Save/log</span>
            <span class="s3">if </span><span class="s1">save_txt</span><span class="s4">:</span>
                <span class="s4">(</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;labels&quot;</span><span class="s4">).</span><span class="s1">mkdir</span><span class="s4">(</span><span class="s1">parents</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">exist_ok</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
                <span class="s1">save_one_txt</span><span class="s4">(</span><span class="s1">predn</span><span class="s4">, </span><span class="s1">save_conf</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">file</span><span class="s4">=</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;labels&quot; </span><span class="s4">/ </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">path</span><span class="s4">.</span><span class="s1">stem</span><span class="s3">}</span><span class="s6">.txt&quot;</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">save_json</span><span class="s4">:</span>
                <span class="s1">save_one_json</span><span class="s4">(</span><span class="s1">predn</span><span class="s4">, </span><span class="s1">jdict</span><span class="s4">, </span><span class="s1">path</span><span class="s4">, </span><span class="s1">class_map</span><span class="s4">)  </span><span class="s0"># append to COCO-JSON dictionary</span>
            <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_val_image_end&quot;</span><span class="s4">, </span><span class="s1">pred</span><span class="s4">, </span><span class="s1">predn</span><span class="s4">, </span><span class="s1">path</span><span class="s4">, </span><span class="s1">names</span><span class="s4">, </span><span class="s1">im</span><span class="s4">[</span><span class="s1">si</span><span class="s4">])</span>

        <span class="s0"># Plot images</span>
        <span class="s3">if </span><span class="s1">plots </span><span class="s3">and </span><span class="s1">batch_i </span><span class="s4">&lt; </span><span class="s5">3</span><span class="s4">:</span>
            <span class="s1">plot_images</span><span class="s4">(</span><span class="s1">im</span><span class="s4">, </span><span class="s1">targets</span><span class="s4">, </span><span class="s1">paths</span><span class="s4">, </span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">f&quot;val_batch</span><span class="s3">{</span><span class="s1">batch_i</span><span class="s3">}</span><span class="s6">_labels.jpg&quot;</span><span class="s4">, </span><span class="s1">names</span><span class="s4">)  </span><span class="s0"># labels</span>
            <span class="s1">plot_images</span><span class="s4">(</span><span class="s1">im</span><span class="s4">, </span><span class="s1">output_to_target</span><span class="s4">(</span><span class="s1">preds</span><span class="s4">), </span><span class="s1">paths</span><span class="s4">, </span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">f&quot;val_batch</span><span class="s3">{</span><span class="s1">batch_i</span><span class="s3">}</span><span class="s6">_pred.jpg&quot;</span><span class="s4">, </span><span class="s1">names</span><span class="s4">)  </span><span class="s0"># pred</span>

        <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_val_batch_end&quot;</span><span class="s4">, </span><span class="s1">batch_i</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">targets</span><span class="s4">, </span><span class="s1">paths</span><span class="s4">, </span><span class="s1">shapes</span><span class="s4">, </span><span class="s1">preds</span><span class="s4">)</span>

    <span class="s0"># Compute metrics</span>
    <span class="s1">stats </span><span class="s4">= [</span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cat</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s5">0</span><span class="s4">).</span><span class="s1">cpu</span><span class="s4">().</span><span class="s1">numpy</span><span class="s4">() </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(*</span><span class="s1">stats</span><span class="s4">)]  </span><span class="s0"># to numpy</span>
    <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">stats</span><span class="s4">) </span><span class="s3">and </span><span class="s1">stats</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">any</span><span class="s4">():</span>
        <span class="s1">tp</span><span class="s4">, </span><span class="s1">fp</span><span class="s4">, </span><span class="s1">p</span><span class="s4">, </span><span class="s1">r</span><span class="s4">, </span><span class="s1">f1</span><span class="s4">, </span><span class="s1">ap</span><span class="s4">, </span><span class="s1">ap_class </span><span class="s4">= </span><span class="s1">ap_per_class</span><span class="s4">(*</span><span class="s1">stats</span><span class="s4">, </span><span class="s1">plot</span><span class="s4">=</span><span class="s1">plots</span><span class="s4">, </span><span class="s1">save_dir</span><span class="s4">=</span><span class="s1">save_dir</span><span class="s4">, </span><span class="s1">names</span><span class="s4">=</span><span class="s1">names</span><span class="s4">)</span>
        <span class="s1">ap50</span><span class="s4">, </span><span class="s1">ap </span><span class="s4">= </span><span class="s1">ap</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">], </span><span class="s1">ap</span><span class="s4">.</span><span class="s1">mean</span><span class="s4">(</span><span class="s5">1</span><span class="s4">)  </span><span class="s0"># AP@0.5, AP@0.5:0.95</span>
        <span class="s1">mp</span><span class="s4">, </span><span class="s1">mr</span><span class="s4">, </span><span class="s1">map50</span><span class="s4">, </span><span class="s1">map </span><span class="s4">= </span><span class="s1">p</span><span class="s4">.</span><span class="s1">mean</span><span class="s4">(), </span><span class="s1">r</span><span class="s4">.</span><span class="s1">mean</span><span class="s4">(), </span><span class="s1">ap50</span><span class="s4">.</span><span class="s1">mean</span><span class="s4">(), </span><span class="s1">ap</span><span class="s4">.</span><span class="s1">mean</span><span class="s4">()</span>
    <span class="s1">nt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">bincount</span><span class="s4">(</span><span class="s1">stats</span><span class="s4">[</span><span class="s5">3</span><span class="s4">].</span><span class="s1">astype</span><span class="s4">(</span><span class="s1">int</span><span class="s4">), </span><span class="s1">minlength</span><span class="s4">=</span><span class="s1">nc</span><span class="s4">)  </span><span class="s0"># number of targets per class</span>

    <span class="s0"># Print results</span>
    <span class="s1">pf </span><span class="s4">= </span><span class="s6">&quot;%22s&quot; </span><span class="s4">+ </span><span class="s6">&quot;%11i&quot; </span><span class="s4">* </span><span class="s5">2 </span><span class="s4">+ </span><span class="s6">&quot;%11.3g&quot; </span><span class="s4">* </span><span class="s5">4  </span><span class="s0"># print format</span>
    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s1">pf </span><span class="s4">% (</span><span class="s6">&quot;all&quot;</span><span class="s4">, </span><span class="s1">seen</span><span class="s4">, </span><span class="s1">nt</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">(), </span><span class="s1">mp</span><span class="s4">, </span><span class="s1">mr</span><span class="s4">, </span><span class="s1">map50</span><span class="s4">, </span><span class="s1">map</span><span class="s4">))</span>
    <span class="s3">if </span><span class="s1">nt</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">() == </span><span class="s5">0</span><span class="s4">:</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">warning</span><span class="s4">(</span><span class="s6">f&quot;WARNING âš ï¸ no labels found in </span><span class="s3">{</span><span class="s1">task</span><span class="s3">} </span><span class="s6">set, can not compute metrics without labels&quot;</span><span class="s4">)</span>

    <span class="s0"># Print results per class</span>
    <span class="s3">if </span><span class="s4">(</span><span class="s1">verbose </span><span class="s3">or </span><span class="s4">(</span><span class="s1">nc </span><span class="s4">&lt; </span><span class="s5">50 </span><span class="s3">and not </span><span class="s1">training</span><span class="s4">)) </span><span class="s3">and </span><span class="s1">nc </span><span class="s4">&gt; </span><span class="s5">1 </span><span class="s3">and </span><span class="s1">len</span><span class="s4">(</span><span class="s1">stats</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">c </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">ap_class</span><span class="s4">):</span>
            <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s1">pf </span><span class="s4">% (</span><span class="s1">names</span><span class="s4">[</span><span class="s1">c</span><span class="s4">], </span><span class="s1">seen</span><span class="s4">, </span><span class="s1">nt</span><span class="s4">[</span><span class="s1">c</span><span class="s4">], </span><span class="s1">p</span><span class="s4">[</span><span class="s1">i</span><span class="s4">], </span><span class="s1">r</span><span class="s4">[</span><span class="s1">i</span><span class="s4">], </span><span class="s1">ap50</span><span class="s4">[</span><span class="s1">i</span><span class="s4">], </span><span class="s1">ap</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]))</span>

    <span class="s0"># Print speeds</span>
    <span class="s1">t </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">x</span><span class="s4">.</span><span class="s1">t </span><span class="s4">/ </span><span class="s1">seen </span><span class="s4">* </span><span class="s5">1e3 </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">dt</span><span class="s4">)  </span><span class="s0"># speeds per image</span>
    <span class="s3">if not </span><span class="s1">training</span><span class="s4">:</span>
        <span class="s1">shape </span><span class="s4">= (</span><span class="s1">batch_size</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">imgsz</span><span class="s4">)</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;Speed: %.1fms pre-process, %.1fms inference, %.1fms NMS per image at shape </span><span class="s3">{</span><span class="s1">shape</span><span class="s3">}</span><span class="s6">&quot; </span><span class="s4">% </span><span class="s1">t</span><span class="s4">)</span>

    <span class="s0"># Plots</span>
    <span class="s3">if </span><span class="s1">plots</span><span class="s4">:</span>
        <span class="s1">confusion_matrix</span><span class="s4">.</span><span class="s1">plot</span><span class="s4">(</span><span class="s1">save_dir</span><span class="s4">=</span><span class="s1">save_dir</span><span class="s4">, </span><span class="s1">names</span><span class="s4">=</span><span class="s1">list</span><span class="s4">(</span><span class="s1">names</span><span class="s4">.</span><span class="s1">values</span><span class="s4">()))</span>
        <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_val_end&quot;</span><span class="s4">, </span><span class="s1">nt</span><span class="s4">, </span><span class="s1">tp</span><span class="s4">, </span><span class="s1">fp</span><span class="s4">, </span><span class="s1">p</span><span class="s4">, </span><span class="s1">r</span><span class="s4">, </span><span class="s1">f1</span><span class="s4">, </span><span class="s1">ap</span><span class="s4">, </span><span class="s1">ap50</span><span class="s4">, </span><span class="s1">ap_class</span><span class="s4">, </span><span class="s1">confusion_matrix</span><span class="s4">)</span>

    <span class="s0"># Save JSON</span>
    <span class="s3">if </span><span class="s1">save_json </span><span class="s3">and </span><span class="s1">len</span><span class="s4">(</span><span class="s1">jdict</span><span class="s4">):</span>
        <span class="s1">w </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">, </span><span class="s1">list</span><span class="s4">) </span><span class="s3">else </span><span class="s1">weights</span><span class="s4">).</span><span class="s1">stem </span><span class="s3">if </span><span class="s1">weights </span><span class="s3">is not None else </span><span class="s6">&quot;&quot;  </span><span class="s0"># weights</span>
        <span class="s1">anno_json </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">Path</span><span class="s4">(</span><span class="s6">&quot;../datasets/coco/annotations/instances_val2017.json&quot;</span><span class="s4">))  </span><span class="s0"># annotations</span>
        <span class="s3">if not </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">exists</span><span class="s4">(</span><span class="s1">anno_json</span><span class="s4">):</span>
            <span class="s1">anno_json </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">data</span><span class="s4">[</span><span class="s6">&quot;path&quot;</span><span class="s4">], </span><span class="s6">&quot;annotations&quot;</span><span class="s4">, </span><span class="s6">&quot;instances_val2017.json&quot;</span><span class="s4">)</span>
        <span class="s1">pred_json </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">w</span><span class="s3">}</span><span class="s6">_predictions.json&quot;</span><span class="s4">)  </span><span class="s0"># predictions</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n</span><span class="s6">Evaluating pycocotools mAP... saving </span><span class="s3">{</span><span class="s1">pred_json</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">pred_json</span><span class="s4">, </span><span class="s6">&quot;w&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">json</span><span class="s4">.</span><span class="s1">dump</span><span class="s4">(</span><span class="s1">jdict</span><span class="s4">, </span><span class="s1">f</span><span class="s4">)</span>

        <span class="s3">try</span><span class="s4">:  </span><span class="s0"># https://github.com/cocodataset/cocoapi/blob/master/PythonAPI/pycocoEvalDemo.ipynb</span>
            <span class="s1">check_requirements</span><span class="s4">(</span><span class="s6">&quot;pycocotools&gt;=2.0.6&quot;</span><span class="s4">)</span>
            <span class="s3">from </span><span class="s1">pycocotools</span><span class="s4">.</span><span class="s1">coco </span><span class="s3">import </span><span class="s1">COCO</span>
            <span class="s3">from </span><span class="s1">pycocotools</span><span class="s4">.</span><span class="s1">cocoeval </span><span class="s3">import </span><span class="s1">COCOeval</span>

            <span class="s1">anno </span><span class="s4">= </span><span class="s1">COCO</span><span class="s4">(</span><span class="s1">anno_json</span><span class="s4">)  </span><span class="s0"># init annotations api</span>
            <span class="s1">pred </span><span class="s4">= </span><span class="s1">anno</span><span class="s4">.</span><span class="s1">loadRes</span><span class="s4">(</span><span class="s1">pred_json</span><span class="s4">)  </span><span class="s0"># init predictions api</span>
            <span class="s1">eval </span><span class="s4">= </span><span class="s1">COCOeval</span><span class="s4">(</span><span class="s1">anno</span><span class="s4">, </span><span class="s1">pred</span><span class="s4">, </span><span class="s6">&quot;bbox&quot;</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">is_coco</span><span class="s4">:</span>
                <span class="s1">eval</span><span class="s4">.</span><span class="s1">params</span><span class="s4">.</span><span class="s1">imgIds </span><span class="s4">= [</span><span class="s1">int</span><span class="s4">(</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">x</span><span class="s4">).</span><span class="s1">stem</span><span class="s4">) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">dataloader</span><span class="s4">.</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">im_files</span><span class="s4">]  </span><span class="s0"># image IDs to evaluate</span>
            <span class="s1">eval</span><span class="s4">.</span><span class="s1">evaluate</span><span class="s4">()</span>
            <span class="s1">eval</span><span class="s4">.</span><span class="s1">accumulate</span><span class="s4">()</span>
            <span class="s1">eval</span><span class="s4">.</span><span class="s1">summarize</span><span class="s4">()</span>
            <span class="s1">map</span><span class="s4">, </span><span class="s1">map50 </span><span class="s4">= </span><span class="s1">eval</span><span class="s4">.</span><span class="s1">stats</span><span class="s4">[:</span><span class="s5">2</span><span class="s4">]  </span><span class="s0"># update results (mAP@0.5:0.95, mAP@0.5)</span>
        <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;pycocotools unable to run: </span><span class="s3">{</span><span class="s1">e</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>

    <span class="s0"># Return results</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">float</span><span class="s4">()  </span><span class="s0"># for training</span>
    <span class="s3">if not </span><span class="s1">training</span><span class="s4">:</span>
        <span class="s1">s </span><span class="s4">= </span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">len</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">save_dir</span><span class="s4">.</span><span class="s1">glob</span><span class="s4">(</span><span class="s6">'labels/*.txt'</span><span class="s4">)))</span><span class="s3">} </span><span class="s6">labels saved to </span><span class="s3">{</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">'labels'</span><span class="s3">}</span><span class="s6">&quot; </span><span class="s3">if </span><span class="s1">save_txt </span><span class="s3">else </span><span class="s6">&quot;&quot;</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;Results saved to </span><span class="s3">{</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">'bold'</span><span class="s4">, </span><span class="s1">save_dir</span><span class="s4">)</span><span class="s3">}{</span><span class="s1">s</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>
    <span class="s1">maps </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">(</span><span class="s1">nc</span><span class="s4">) + </span><span class="s1">map</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">c </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">ap_class</span><span class="s4">):</span>
        <span class="s1">maps</span><span class="s4">[</span><span class="s1">c</span><span class="s4">] = </span><span class="s1">ap</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">mp</span><span class="s4">, </span><span class="s1">mr</span><span class="s4">, </span><span class="s1">map50</span><span class="s4">, </span><span class="s1">map</span><span class="s4">, *(</span><span class="s1">loss</span><span class="s4">.</span><span class="s1">cpu</span><span class="s4">() / </span><span class="s1">len</span><span class="s4">(</span><span class="s1">dataloader</span><span class="s4">)).</span><span class="s1">tolist</span><span class="s4">()), </span><span class="s1">maps</span><span class="s4">, </span><span class="s1">t</span>


<span class="s3">def </span><span class="s1">parse_opt</span><span class="s4">():</span>
    <span class="s1">parser </span><span class="s4">= </span><span class="s1">argparse</span><span class="s4">.</span><span class="s1">ArgumentParser</span><span class="s4">()</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--data&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;data/coco128.yaml&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;dataset.yaml path&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--weights&quot;</span><span class="s4">, </span><span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;+&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;yolov5s.pt&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;model path(s)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--batch-size&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">32</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;batch size&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--imgsz&quot;</span><span class="s4">, </span><span class="s6">&quot;--img&quot;</span><span class="s4">, </span><span class="s6">&quot;--img-size&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">640</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;inference size (pixels)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--conf-thres&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">float</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">0.001</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;confidence threshold&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--iou-thres&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">float</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">0.6</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;NMS IoU threshold&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--max-det&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">300</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;maximum detections per image&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--task&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;val&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;train, val, test, speed or study&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--device&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;cuda device, i.e. 0 or 0,1,2,3 or cpu&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--workers&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">8</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;max dataloader workers (per RANK in DDP mode)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--single-cls&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;treat as single-class dataset&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--augment&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;augmented inference&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--verbose&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;report mAP by class&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--save-txt&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save results to *.txt&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--save-hybrid&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save label+prediction hybrid results to *.txt&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--save-conf&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save confidences in --save-txt labels&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--save-json&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save a COCO-JSON results file&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--project&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;runs/val&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save to project/name&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--name&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;exp&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save to project/name&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--exist-ok&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;existing project/name ok, do not increment&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--half&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;use FP16 half-precision inference&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--dnn&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;use OpenCV DNN for ONNX inference&quot;</span><span class="s4">)</span>
    <span class="s1">opt </span><span class="s4">= </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse_args</span><span class="s4">()</span>
    <span class="s1">opt</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= </span><span class="s1">check_yaml</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">data</span><span class="s4">)  </span><span class="s0"># check YAML</span>
    <span class="s1">opt</span><span class="s4">.</span><span class="s1">save_json </span><span class="s4">|= </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">data</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span><span class="s6">&quot;coco.yaml&quot;</span><span class="s4">)</span>
    <span class="s1">opt</span><span class="s4">.</span><span class="s1">save_txt </span><span class="s4">|= </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">save_hybrid</span>
    <span class="s1">print_args</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">))</span>
    <span class="s3">return </span><span class="s1">opt</span>


<span class="s3">def </span><span class="s1">main</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">):</span>
    <span class="s1">check_requirements</span><span class="s4">(</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;requirements.txt&quot;</span><span class="s4">, </span><span class="s1">exclude</span><span class="s4">=(</span><span class="s6">&quot;tensorboard&quot;</span><span class="s4">, </span><span class="s6">&quot;thop&quot;</span><span class="s4">))</span>

    <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">task </span><span class="s3">in </span><span class="s4">(</span><span class="s6">&quot;train&quot;</span><span class="s4">, </span><span class="s6">&quot;val&quot;</span><span class="s4">, </span><span class="s6">&quot;test&quot;</span><span class="s4">):  </span><span class="s0"># run normally</span>
        <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">conf_thres </span><span class="s4">&gt; </span><span class="s5">0.001</span><span class="s4">:  </span><span class="s0"># https://github.com/ultralytics/yolov5/issues/1466</span>
            <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;WARNING âš ï¸ confidence threshold </span><span class="s3">{</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">conf_thres</span><span class="s3">} </span><span class="s6">&gt; 0.001 produces invalid results&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">save_hybrid</span><span class="s4">:</span>
            <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">&quot;WARNING âš ï¸ --save-hybrid will return high mAP from hybrid labels, not from predictions alone&quot;</span><span class="s4">)</span>
        <span class="s1">run</span><span class="s4">(**</span><span class="s1">vars</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">))</span>

    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">weights </span><span class="s4">= </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights</span><span class="s4">, </span><span class="s1">list</span><span class="s4">) </span><span class="s3">else </span><span class="s4">[</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights</span><span class="s4">]</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">half </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cuda</span><span class="s4">.</span><span class="s1">is_available</span><span class="s4">() </span><span class="s3">and </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">device </span><span class="s4">!= </span><span class="s6">&quot;cpu&quot;  </span><span class="s0"># FP16 for fastest results</span>
        <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">task </span><span class="s4">== </span><span class="s6">&quot;speed&quot;</span><span class="s4">:  </span><span class="s0"># speed benchmarks</span>
            <span class="s0"># python val.py --task speed --data coco.yaml --batch 1 --weights yolov5n.pt yolov5s.pt...</span>
            <span class="s1">opt</span><span class="s4">.</span><span class="s1">conf_thres</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">iou_thres</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">save_json </span><span class="s4">= </span><span class="s5">0.25</span><span class="s4">, </span><span class="s5">0.45</span><span class="s4">, </span><span class="s3">False</span>
            <span class="s3">for </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights </span><span class="s3">in </span><span class="s1">weights</span><span class="s4">:</span>
                <span class="s1">run</span><span class="s4">(**</span><span class="s1">vars</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">), </span><span class="s1">plots</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

        <span class="s3">elif </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">task </span><span class="s4">== </span><span class="s6">&quot;study&quot;</span><span class="s4">:  </span><span class="s0"># speed vs mAP benchmarks</span>
            <span class="s0"># python val.py --task study --data coco.yaml --iou 0.7 --weights yolov5n.pt yolov5s.pt...</span>
            <span class="s3">for </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights </span><span class="s3">in </span><span class="s1">weights</span><span class="s4">:</span>
                <span class="s1">f </span><span class="s4">= </span><span class="s6">f&quot;study_</span><span class="s3">{</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">data</span><span class="s4">).</span><span class="s1">stem</span><span class="s3">}</span><span class="s6">_</span><span class="s3">{</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights</span><span class="s4">).</span><span class="s1">stem</span><span class="s3">}</span><span class="s6">.txt&quot;  </span><span class="s0"># filename to save to</span>
                <span class="s1">x</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s5">256</span><span class="s4">, </span><span class="s5">1536 </span><span class="s4">+ </span><span class="s5">128</span><span class="s4">, </span><span class="s5">128</span><span class="s4">)), []  </span><span class="s0"># x axis (image sizes), y axis</span>
                <span class="s3">for </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">imgsz </span><span class="s3">in </span><span class="s1">x</span><span class="s4">:  </span><span class="s0"># img-size</span>
                    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n</span><span class="s6">Running </span><span class="s3">{</span><span class="s1">f</span><span class="s3">} </span><span class="s6">--imgsz </span><span class="s3">{</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">imgsz</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
                    <span class="s1">r</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">t </span><span class="s4">= </span><span class="s1">run</span><span class="s4">(**</span><span class="s1">vars</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">), </span><span class="s1">plots</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
                    <span class="s1">y</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">r </span><span class="s4">+ </span><span class="s1">t</span><span class="s4">)  </span><span class="s0"># results and times</span>
                <span class="s1">np</span><span class="s4">.</span><span class="s1">savetxt</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">fmt</span><span class="s4">=</span><span class="s6">&quot;%10.4g&quot;</span><span class="s4">)  </span><span class="s0"># save</span>
            <span class="s1">subprocess</span><span class="s4">.</span><span class="s1">run</span><span class="s4">([</span><span class="s6">&quot;zip&quot;</span><span class="s4">, </span><span class="s6">&quot;-r&quot;</span><span class="s4">, </span><span class="s6">&quot;study.zip&quot;</span><span class="s4">, </span><span class="s6">&quot;study_*.txt&quot;</span><span class="s4">])</span>
            <span class="s1">plot_val_study</span><span class="s4">(</span><span class="s1">x</span><span class="s4">=</span><span class="s1">x</span><span class="s4">)  </span><span class="s0"># plot</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">(</span><span class="s6">f'--task </span><span class="s3">{</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">task</span><span class="s3">} </span><span class="s6">not in (&quot;train&quot;, &quot;val&quot;, &quot;test&quot;, &quot;speed&quot;, &quot;study&quot;)'</span><span class="s4">)</span>


<span class="s3">if </span><span class="s1">__name__ </span><span class="s4">== </span><span class="s6">&quot;__main__&quot;</span><span class="s4">:</span>
    <span class="s1">opt </span><span class="s4">= </span><span class="s1">parse_opt</span><span class="s4">()</span>
    <span class="s1">main</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">)</span>
</pre>
</body>
</html>