<html>
<head>
<title>detect.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
detect.py</font>
</center></td></tr></table>
<pre><span class="s0"># YOLOv5 ðŸš€ by Ultralytics, AGPL-3.0 license</span>
<span class="s2">&quot;&quot;&quot; 
Run YOLOv5 detection inference on images, videos, directories, globs, YouTube, webcam, streams, etc. 
 
Usage - sources: 
    $ python detect.py --weights yolov5s.pt --source 0                               # webcam 
                                                     img.jpg                         # image 
                                                     vid.mp4                         # video 
                                                     screen                          # screenshot 
                                                     path/                           # directory 
                                                     list.txt                        # list of images 
                                                     list.streams                    # list of streams 
                                                     'path/*.jpg'                    # glob 
                                                     'https://youtu.be/LNwODJXcvt4'  # YouTube 
                                                     'rtsp://example.com/media.mp4'  # RTSP, RTMP, HTTP stream 
 
Usage - formats: 
    $ python detect.py --weights yolov5s.pt                 # PyTorch 
                                 yolov5s.torchscript        # TorchScript 
                                 yolov5s.onnx               # ONNX Runtime or OpenCV DNN with --dnn 
                                 yolov5s_openvino_model     # OpenVINO 
                                 yolov5s.engine             # TensorRT 
                                 yolov5s.mlmodel            # CoreML (macOS-only) 
                                 yolov5s_saved_model        # TensorFlow SavedModel 
                                 yolov5s.pb                 # TensorFlow GraphDef 
                                 yolov5s.tflite             # TensorFlow Lite 
                                 yolov5s_edgetpu.tflite     # TensorFlow Edge TPU 
                                 yolov5s_paddle_model       # PaddlePaddle 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">argparse</span>
<span class="s3">import </span><span class="s1">csv</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">platform</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">from </span><span class="s1">pathlib </span><span class="s3">import </span><span class="s1">Path</span>

<span class="s3">import </span><span class="s1">torch</span>

<span class="s1">FILE </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">__file__</span><span class="s4">).</span><span class="s1">resolve</span><span class="s4">()</span>
<span class="s1">ROOT </span><span class="s4">= </span><span class="s1">FILE</span><span class="s4">.</span><span class="s1">parents</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]  </span><span class="s0"># YOLOv5 root directory</span>
<span class="s3">if </span><span class="s1">str</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">) </span><span class="s3">not in </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">path</span><span class="s4">:</span>
    <span class="s1">sys</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">))  </span><span class="s0"># add ROOT to PATH</span>
<span class="s1">ROOT </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">relpath</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">, </span><span class="s1">Path</span><span class="s4">.</span><span class="s1">cwd</span><span class="s4">()))  </span><span class="s0"># relative</span>

<span class="s3">from </span><span class="s1">ultralytics</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">plotting </span><span class="s3">import </span><span class="s1">Annotator</span><span class="s4">, </span><span class="s1">colors</span><span class="s4">, </span><span class="s1">save_one_box</span>

<span class="s3">from </span><span class="s1">models</span><span class="s4">.</span><span class="s1">common </span><span class="s3">import </span><span class="s1">DetectMultiBackend</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">dataloaders </span><span class="s3">import </span><span class="s1">IMG_FORMATS</span><span class="s4">, </span><span class="s1">VID_FORMATS</span><span class="s4">, </span><span class="s1">LoadImages</span><span class="s4">, </span><span class="s1">LoadScreenshots</span><span class="s4">, </span><span class="s1">LoadStreams</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">general </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">LOGGER</span><span class="s4">,</span>
    <span class="s1">Profile</span><span class="s4">,</span>
    <span class="s1">check_file</span><span class="s4">,</span>
    <span class="s1">check_img_size</span><span class="s4">,</span>
    <span class="s1">check_imshow</span><span class="s4">,</span>
    <span class="s1">check_requirements</span><span class="s4">,</span>
    <span class="s1">colorstr</span><span class="s4">,</span>
    <span class="s1">cv2</span><span class="s4">,</span>
    <span class="s1">increment_path</span><span class="s4">,</span>
    <span class="s1">non_max_suppression</span><span class="s4">,</span>
    <span class="s1">print_args</span><span class="s4">,</span>
    <span class="s1">scale_boxes</span><span class="s4">,</span>
    <span class="s1">strip_optimizer</span><span class="s4">,</span>
    <span class="s1">xyxy2xywh</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">torch_utils </span><span class="s3">import </span><span class="s1">select_device</span><span class="s4">, </span><span class="s1">smart_inference_mode</span>


<span class="s4">@</span><span class="s1">smart_inference_mode</span><span class="s4">()</span>
<span class="s3">def </span><span class="s1">run</span><span class="s4">(</span>
    <span class="s1">weights</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;yolov5s.pt&quot;</span><span class="s4">,  </span><span class="s0"># model path or triton URL</span>
    <span class="s1">source</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;data/images&quot;</span><span class="s4">,  </span><span class="s0"># file/dir/URL/glob/screen/0(webcam)</span>
    <span class="s1">data</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;data/coco128.yaml&quot;</span><span class="s4">,  </span><span class="s0"># dataset.yaml path</span>
    <span class="s1">imgsz</span><span class="s4">=(</span><span class="s5">640</span><span class="s4">, </span><span class="s5">640</span><span class="s4">),  </span><span class="s0"># inference size (height, width)</span>
    <span class="s1">conf_thres</span><span class="s4">=</span><span class="s5">0.25</span><span class="s4">,  </span><span class="s0"># confidence threshold</span>
    <span class="s1">iou_thres</span><span class="s4">=</span><span class="s5">0.45</span><span class="s4">,  </span><span class="s0"># NMS IOU threshold</span>
    <span class="s1">max_det</span><span class="s4">=</span><span class="s5">1000</span><span class="s4">,  </span><span class="s0"># maximum detections per image</span>
    <span class="s1">device</span><span class="s4">=</span><span class="s6">&quot;&quot;</span><span class="s4">,  </span><span class="s0"># cuda device, i.e. 0 or 0,1,2,3 or cpu</span>
    <span class="s1">view_img</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># show results</span>
    <span class="s1">save_txt</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># save results to *.txt</span>
    <span class="s1">save_csv</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># save results in CSV format</span>
    <span class="s1">save_conf</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># save confidences in --save-txt labels</span>
    <span class="s1">save_crop</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># save cropped prediction boxes</span>
    <span class="s1">nosave</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># do not save images/videos</span>
    <span class="s1">classes</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,  </span><span class="s0"># filter by class: --class 0, or --class 0 2 3</span>
    <span class="s1">agnostic_nms</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># class-agnostic NMS</span>
    <span class="s1">augment</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># augmented inference</span>
    <span class="s1">visualize</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># visualize features</span>
    <span class="s1">update</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># update all models</span>
    <span class="s1">project</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;runs/detect&quot;</span><span class="s4">,  </span><span class="s0"># save results to project/name</span>
    <span class="s1">name</span><span class="s4">=</span><span class="s6">&quot;exp&quot;</span><span class="s4">,  </span><span class="s0"># save results to project/name</span>
    <span class="s1">exist_ok</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># existing project/name ok, do not increment</span>
    <span class="s1">line_thickness</span><span class="s4">=</span><span class="s5">3</span><span class="s4">,  </span><span class="s0"># bounding box thickness (pixels)</span>
    <span class="s1">hide_labels</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># hide labels</span>
    <span class="s1">hide_conf</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># hide confidences</span>
    <span class="s1">half</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># use FP16 half-precision inference</span>
    <span class="s1">dnn</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># use OpenCV DNN for ONNX inference</span>
    <span class="s1">vid_stride</span><span class="s4">=</span><span class="s5">1</span><span class="s4">,  </span><span class="s0"># video frame-rate stride</span>
<span class="s4">):</span>
    <span class="s1">source </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">source</span><span class="s4">)</span>
    <span class="s1">save_img </span><span class="s4">= </span><span class="s3">not </span><span class="s1">nosave </span><span class="s3">and not </span><span class="s1">source</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span><span class="s6">&quot;.txt&quot;</span><span class="s4">)  </span><span class="s0"># save inference images</span>
    <span class="s1">is_file </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">source</span><span class="s4">).</span><span class="s1">suffix</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:] </span><span class="s3">in </span><span class="s4">(</span><span class="s1">IMG_FORMATS </span><span class="s4">+ </span><span class="s1">VID_FORMATS</span><span class="s4">)</span>
    <span class="s1">is_url </span><span class="s4">= </span><span class="s1">source</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">().</span><span class="s1">startswith</span><span class="s4">((</span><span class="s6">&quot;rtsp://&quot;</span><span class="s4">, </span><span class="s6">&quot;rtmp://&quot;</span><span class="s4">, </span><span class="s6">&quot;http://&quot;</span><span class="s4">, </span><span class="s6">&quot;https://&quot;</span><span class="s4">))</span>
    <span class="s1">webcam </span><span class="s4">= </span><span class="s1">source</span><span class="s4">.</span><span class="s1">isnumeric</span><span class="s4">() </span><span class="s3">or </span><span class="s1">source</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span><span class="s6">&quot;.streams&quot;</span><span class="s4">) </span><span class="s3">or </span><span class="s4">(</span><span class="s1">is_url </span><span class="s3">and not </span><span class="s1">is_file</span><span class="s4">)</span>
    <span class="s1">screenshot </span><span class="s4">= </span><span class="s1">source</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">().</span><span class="s1">startswith</span><span class="s4">(</span><span class="s6">&quot;screen&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">is_url </span><span class="s3">and </span><span class="s1">is_file</span><span class="s4">:</span>
        <span class="s1">source </span><span class="s4">= </span><span class="s1">check_file</span><span class="s4">(</span><span class="s1">source</span><span class="s4">)  </span><span class="s0"># download</span>

    <span class="s0"># Directories</span>
    <span class="s1">save_dir </span><span class="s4">= </span><span class="s1">increment_path</span><span class="s4">(</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">project</span><span class="s4">) / </span><span class="s1">name</span><span class="s4">, </span><span class="s1">exist_ok</span><span class="s4">=</span><span class="s1">exist_ok</span><span class="s4">)  </span><span class="s0"># increment run</span>
    <span class="s4">(</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;labels&quot; </span><span class="s3">if </span><span class="s1">save_txt </span><span class="s3">else </span><span class="s1">save_dir</span><span class="s4">).</span><span class="s1">mkdir</span><span class="s4">(</span><span class="s1">parents</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">exist_ok</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)  </span><span class="s0"># make dir</span>

    <span class="s0"># Load model</span>
    <span class="s1">device </span><span class="s4">= </span><span class="s1">select_device</span><span class="s4">(</span><span class="s1">device</span><span class="s4">)</span>
    <span class="s1">model </span><span class="s4">= </span><span class="s1">DetectMultiBackend</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">, </span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">, </span><span class="s1">dnn</span><span class="s4">=</span><span class="s1">dnn</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">data</span><span class="s4">, </span><span class="s1">fp16</span><span class="s4">=</span><span class="s1">half</span><span class="s4">)</span>
    <span class="s1">stride</span><span class="s4">, </span><span class="s1">names</span><span class="s4">, </span><span class="s1">pt </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">stride</span><span class="s4">, </span><span class="s1">model</span><span class="s4">.</span><span class="s1">names</span><span class="s4">, </span><span class="s1">model</span><span class="s4">.</span><span class="s1">pt</span>
    <span class="s1">imgsz </span><span class="s4">= </span><span class="s1">check_img_size</span><span class="s4">(</span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">s</span><span class="s4">=</span><span class="s1">stride</span><span class="s4">)  </span><span class="s0"># check image size</span>

    <span class="s0"># Dataloader</span>
    <span class="s1">bs </span><span class="s4">= </span><span class="s5">1  </span><span class="s0"># batch_size</span>
    <span class="s3">if </span><span class="s1">webcam</span><span class="s4">:</span>
        <span class="s1">view_img </span><span class="s4">= </span><span class="s1">check_imshow</span><span class="s4">(</span><span class="s1">warn</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">dataset </span><span class="s4">= </span><span class="s1">LoadStreams</span><span class="s4">(</span><span class="s1">source</span><span class="s4">, </span><span class="s1">img_size</span><span class="s4">=</span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">stride</span><span class="s4">=</span><span class="s1">stride</span><span class="s4">, </span><span class="s1">auto</span><span class="s4">=</span><span class="s1">pt</span><span class="s4">, </span><span class="s1">vid_stride</span><span class="s4">=</span><span class="s1">vid_stride</span><span class="s4">)</span>
        <span class="s1">bs </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">dataset</span><span class="s4">)</span>
    <span class="s3">elif </span><span class="s1">screenshot</span><span class="s4">:</span>
        <span class="s1">dataset </span><span class="s4">= </span><span class="s1">LoadScreenshots</span><span class="s4">(</span><span class="s1">source</span><span class="s4">, </span><span class="s1">img_size</span><span class="s4">=</span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">stride</span><span class="s4">=</span><span class="s1">stride</span><span class="s4">, </span><span class="s1">auto</span><span class="s4">=</span><span class="s1">pt</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">dataset </span><span class="s4">= </span><span class="s1">LoadImages</span><span class="s4">(</span><span class="s1">source</span><span class="s4">, </span><span class="s1">img_size</span><span class="s4">=</span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">stride</span><span class="s4">=</span><span class="s1">stride</span><span class="s4">, </span><span class="s1">auto</span><span class="s4">=</span><span class="s1">pt</span><span class="s4">, </span><span class="s1">vid_stride</span><span class="s4">=</span><span class="s1">vid_stride</span><span class="s4">)</span>
    <span class="s1">vid_path</span><span class="s4">, </span><span class="s1">vid_writer </span><span class="s4">= [</span><span class="s3">None</span><span class="s4">] * </span><span class="s1">bs</span><span class="s4">, [</span><span class="s3">None</span><span class="s4">] * </span><span class="s1">bs</span>

    <span class="s0"># Run inference</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">warmup</span><span class="s4">(</span><span class="s1">imgsz</span><span class="s4">=(</span><span class="s5">1 </span><span class="s3">if </span><span class="s1">pt </span><span class="s3">or </span><span class="s1">model</span><span class="s4">.</span><span class="s1">triton </span><span class="s3">else </span><span class="s1">bs</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, *</span><span class="s1">imgsz</span><span class="s4">))  </span><span class="s0"># warmup</span>
    <span class="s1">seen</span><span class="s4">, </span><span class="s1">windows</span><span class="s4">, </span><span class="s1">dt </span><span class="s4">= </span><span class="s5">0</span><span class="s4">, [], (</span><span class="s1">Profile</span><span class="s4">(</span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">), </span><span class="s1">Profile</span><span class="s4">(</span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">), </span><span class="s1">Profile</span><span class="s4">(</span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">))</span>
    <span class="s3">for </span><span class="s1">path</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">im0s</span><span class="s4">, </span><span class="s1">vid_cap</span><span class="s4">, </span><span class="s1">s </span><span class="s3">in </span><span class="s1">dataset</span><span class="s4">:</span>
        <span class="s3">with </span><span class="s1">dt</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]:</span>
            <span class="s1">im </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">from_numpy</span><span class="s4">(</span><span class="s1">im</span><span class="s4">).</span><span class="s1">to</span><span class="s4">(</span><span class="s1">model</span><span class="s4">.</span><span class="s1">device</span><span class="s4">)</span>
            <span class="s1">im </span><span class="s4">= </span><span class="s1">im</span><span class="s4">.</span><span class="s1">half</span><span class="s4">() </span><span class="s3">if </span><span class="s1">model</span><span class="s4">.</span><span class="s1">fp16 </span><span class="s3">else </span><span class="s1">im</span><span class="s4">.</span><span class="s1">float</span><span class="s4">()  </span><span class="s0"># uint8 to fp16/32</span>
            <span class="s1">im </span><span class="s4">/= </span><span class="s5">255  </span><span class="s0"># 0 - 255 to 0.0 - 1.0</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">) == </span><span class="s5">3</span><span class="s4">:</span>
                <span class="s1">im </span><span class="s4">= </span><span class="s1">im</span><span class="s4">[</span><span class="s3">None</span><span class="s4">]  </span><span class="s0"># expand for batch dim</span>
            <span class="s3">if </span><span class="s1">model</span><span class="s4">.</span><span class="s1">xml </span><span class="s3">and </span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] &gt; </span><span class="s5">1</span><span class="s4">:</span>
                <span class="s1">ims </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">chunk</span><span class="s4">(</span><span class="s1">im</span><span class="s4">, </span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s5">0</span><span class="s4">)</span>

        <span class="s0"># Inference</span>
        <span class="s3">with </span><span class="s1">dt</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]:</span>
            <span class="s1">visualize </span><span class="s4">= </span><span class="s1">increment_path</span><span class="s4">(</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">path</span><span class="s4">).</span><span class="s1">stem</span><span class="s4">, </span><span class="s1">mkdir</span><span class="s4">=</span><span class="s3">True</span><span class="s4">) </span><span class="s3">if </span><span class="s1">visualize </span><span class="s3">else False</span>
            <span class="s3">if </span><span class="s1">model</span><span class="s4">.</span><span class="s1">xml </span><span class="s3">and </span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] &gt; </span><span class="s5">1</span><span class="s4">:</span>
                <span class="s1">pred </span><span class="s4">= </span><span class="s3">None</span>
                <span class="s3">for </span><span class="s1">image </span><span class="s3">in </span><span class="s1">ims</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">pred </span><span class="s3">is None</span><span class="s4">:</span>
                        <span class="s1">pred </span><span class="s4">= </span><span class="s1">model</span><span class="s4">(</span><span class="s1">image</span><span class="s4">, </span><span class="s1">augment</span><span class="s4">=</span><span class="s1">augment</span><span class="s4">, </span><span class="s1">visualize</span><span class="s4">=</span><span class="s1">visualize</span><span class="s4">).</span><span class="s1">unsqueeze</span><span class="s4">(</span><span class="s5">0</span><span class="s4">)</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s1">pred </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cat</span><span class="s4">((</span><span class="s1">pred</span><span class="s4">, </span><span class="s1">model</span><span class="s4">(</span><span class="s1">image</span><span class="s4">, </span><span class="s1">augment</span><span class="s4">=</span><span class="s1">augment</span><span class="s4">, </span><span class="s1">visualize</span><span class="s4">=</span><span class="s1">visualize</span><span class="s4">).</span><span class="s1">unsqueeze</span><span class="s4">(</span><span class="s5">0</span><span class="s4">)), </span><span class="s1">dim</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
                <span class="s1">pred </span><span class="s4">= [</span><span class="s1">pred</span><span class="s4">, </span><span class="s3">None</span><span class="s4">]</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">pred </span><span class="s4">= </span><span class="s1">model</span><span class="s4">(</span><span class="s1">im</span><span class="s4">, </span><span class="s1">augment</span><span class="s4">=</span><span class="s1">augment</span><span class="s4">, </span><span class="s1">visualize</span><span class="s4">=</span><span class="s1">visualize</span><span class="s4">)</span>
        <span class="s0"># NMS</span>
        <span class="s3">with </span><span class="s1">dt</span><span class="s4">[</span><span class="s5">2</span><span class="s4">]:</span>
            <span class="s1">pred </span><span class="s4">= </span><span class="s1">non_max_suppression</span><span class="s4">(</span><span class="s1">pred</span><span class="s4">, </span><span class="s1">conf_thres</span><span class="s4">, </span><span class="s1">iou_thres</span><span class="s4">, </span><span class="s1">classes</span><span class="s4">, </span><span class="s1">agnostic_nms</span><span class="s4">, </span><span class="s1">max_det</span><span class="s4">=</span><span class="s1">max_det</span><span class="s4">)</span>

        <span class="s0"># Second-stage classifier (optional)</span>
        <span class="s0"># pred = utils.general.apply_classifier(pred, classifier_model, im, im0s)</span>

        <span class="s0"># Define the path for the CSV file</span>
        <span class="s1">csv_path </span><span class="s4">= </span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;predictions.csv&quot;</span>

        <span class="s0"># Create or append to the CSV file</span>
        <span class="s3">def </span><span class="s1">write_to_csv</span><span class="s4">(</span><span class="s1">image_name</span><span class="s4">, </span><span class="s1">prediction</span><span class="s4">, </span><span class="s1">confidence</span><span class="s4">):</span>
            <span class="s1">data </span><span class="s4">= {</span><span class="s6">&quot;Image Name&quot;</span><span class="s4">: </span><span class="s1">image_name</span><span class="s4">, </span><span class="s6">&quot;Prediction&quot;</span><span class="s4">: </span><span class="s1">prediction</span><span class="s4">, </span><span class="s6">&quot;Confidence&quot;</span><span class="s4">: </span><span class="s1">confidence</span><span class="s4">}</span>
            <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">csv_path</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s6">&quot;a&quot;</span><span class="s4">, </span><span class="s1">newline</span><span class="s4">=</span><span class="s6">&quot;&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
                <span class="s1">writer </span><span class="s4">= </span><span class="s1">csv</span><span class="s4">.</span><span class="s1">DictWriter</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">fieldnames</span><span class="s4">=</span><span class="s1">data</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">())</span>
                <span class="s3">if not </span><span class="s1">csv_path</span><span class="s4">.</span><span class="s1">is_file</span><span class="s4">():</span>
                    <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeheader</span><span class="s4">()</span>
                <span class="s1">writer</span><span class="s4">.</span><span class="s1">writerow</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)</span>

        <span class="s0"># Process predictions</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">det </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">pred</span><span class="s4">):  </span><span class="s0"># per image</span>
            <span class="s1">seen </span><span class="s4">+= </span><span class="s5">1</span>
            <span class="s3">if </span><span class="s1">webcam</span><span class="s4">:  </span><span class="s0"># batch_size &gt;= 1</span>
                <span class="s1">p</span><span class="s4">, </span><span class="s1">im0</span><span class="s4">, </span><span class="s1">frame </span><span class="s4">= </span><span class="s1">path</span><span class="s4">[</span><span class="s1">i</span><span class="s4">], </span><span class="s1">im0s</span><span class="s4">[</span><span class="s1">i</span><span class="s4">].</span><span class="s1">copy</span><span class="s4">(), </span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">count</span>
                <span class="s1">s </span><span class="s4">+= </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">i</span><span class="s3">}</span><span class="s6">: &quot;</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">p</span><span class="s4">, </span><span class="s1">im0</span><span class="s4">, </span><span class="s1">frame </span><span class="s4">= </span><span class="s1">path</span><span class="s4">, </span><span class="s1">im0s</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(), </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">dataset</span><span class="s4">, </span><span class="s6">&quot;frame&quot;</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)</span>

            <span class="s1">p </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">p</span><span class="s4">)  </span><span class="s0"># to Path</span>
            <span class="s1">save_path </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s1">p</span><span class="s4">.</span><span class="s1">name</span><span class="s4">)  </span><span class="s0"># im.jpg</span>
            <span class="s1">txt_path </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;labels&quot; </span><span class="s4">/ </span><span class="s1">p</span><span class="s4">.</span><span class="s1">stem</span><span class="s4">) + (</span><span class="s6">&quot;&quot; </span><span class="s3">if </span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">mode </span><span class="s4">== </span><span class="s6">&quot;image&quot; </span><span class="s3">else </span><span class="s6">f&quot;_</span><span class="s3">{</span><span class="s1">frame</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)  </span><span class="s0"># im.txt</span>
            <span class="s1">s </span><span class="s4">+= </span><span class="s6">&quot;%gx%g &quot; </span><span class="s4">% </span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">2</span><span class="s4">:]  </span><span class="s0"># print string</span>
            <span class="s1">gn </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">tensor</span><span class="s4">(</span><span class="s1">im0</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">)[[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">]]  </span><span class="s0"># normalization gain whwh</span>
            <span class="s1">imc </span><span class="s4">= </span><span class="s1">im0</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">() </span><span class="s3">if </span><span class="s1">save_crop </span><span class="s3">else </span><span class="s1">im0  </span><span class="s0"># for save_crop</span>
            <span class="s1">annotator </span><span class="s4">= </span><span class="s1">Annotator</span><span class="s4">(</span><span class="s1">im0</span><span class="s4">, </span><span class="s1">line_width</span><span class="s4">=</span><span class="s1">line_thickness</span><span class="s4">, </span><span class="s1">example</span><span class="s4">=</span><span class="s1">str</span><span class="s4">(</span><span class="s1">names</span><span class="s4">))</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">det</span><span class="s4">):</span>
                <span class="s0"># Rescale boxes from img_size to im0 size</span>
                <span class="s1">det</span><span class="s4">[:, :</span><span class="s5">4</span><span class="s4">] = </span><span class="s1">scale_boxes</span><span class="s4">(</span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">2</span><span class="s4">:], </span><span class="s1">det</span><span class="s4">[:, :</span><span class="s5">4</span><span class="s4">], </span><span class="s1">im0</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">).</span><span class="s1">round</span><span class="s4">()</span>

                <span class="s0"># Print results</span>
                <span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">det</span><span class="s4">[:, </span><span class="s5">5</span><span class="s4">].</span><span class="s1">unique</span><span class="s4">():</span>
                    <span class="s1">n </span><span class="s4">= (</span><span class="s1">det</span><span class="s4">[:, </span><span class="s5">5</span><span class="s4">] == </span><span class="s1">c</span><span class="s4">).</span><span class="s1">sum</span><span class="s4">()  </span><span class="s0"># detections per class</span>
                    <span class="s1">s </span><span class="s4">+= </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">n</span><span class="s3">} {</span><span class="s1">names</span><span class="s4">[</span><span class="s1">int</span><span class="s4">(</span><span class="s1">c</span><span class="s4">)]</span><span class="s3">}{</span><span class="s6">'s' </span><span class="s4">* (</span><span class="s1">n </span><span class="s4">&gt; </span><span class="s5">1</span><span class="s4">)</span><span class="s3">}</span><span class="s6">, &quot;  </span><span class="s0"># add to string</span>

                <span class="s0"># Write results</span>
                <span class="s3">for </span><span class="s4">*</span><span class="s1">xyxy</span><span class="s4">, </span><span class="s1">conf</span><span class="s4">, </span><span class="s1">cls </span><span class="s3">in </span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">det</span><span class="s4">):</span>
                    <span class="s1">c </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">)  </span><span class="s0"># integer class</span>
                    <span class="s1">label </span><span class="s4">= </span><span class="s1">names</span><span class="s4">[</span><span class="s1">c</span><span class="s4">] </span><span class="s3">if </span><span class="s1">hide_conf </span><span class="s3">else </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">names</span><span class="s4">[</span><span class="s1">c</span><span class="s4">]</span><span class="s3">}</span><span class="s6">&quot;</span>
                    <span class="s1">confidence </span><span class="s4">= </span><span class="s1">float</span><span class="s4">(</span><span class="s1">conf</span><span class="s4">)</span>
                    <span class="s1">confidence_str </span><span class="s4">= </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">confidence</span><span class="s3">:</span><span class="s6">.2f</span><span class="s3">}</span><span class="s6">&quot;</span>

                    <span class="s3">if </span><span class="s1">save_csv</span><span class="s4">:</span>
                        <span class="s1">write_to_csv</span><span class="s4">(</span><span class="s1">p</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">label</span><span class="s4">, </span><span class="s1">confidence_str</span><span class="s4">)</span>

                    <span class="s3">if </span><span class="s1">save_txt</span><span class="s4">:  </span><span class="s0"># Write to file</span>
                        <span class="s1">xywh </span><span class="s4">= (</span><span class="s1">xyxy2xywh</span><span class="s4">(</span><span class="s1">torch</span><span class="s4">.</span><span class="s1">tensor</span><span class="s4">(</span><span class="s1">xyxy</span><span class="s4">).</span><span class="s1">view</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">4</span><span class="s4">)) / </span><span class="s1">gn</span><span class="s4">).</span><span class="s1">view</span><span class="s4">(-</span><span class="s5">1</span><span class="s4">).</span><span class="s1">tolist</span><span class="s4">()  </span><span class="s0"># normalized xywh</span>
                        <span class="s1">line </span><span class="s4">= (</span><span class="s1">cls</span><span class="s4">, *</span><span class="s1">xywh</span><span class="s4">, </span><span class="s1">conf</span><span class="s4">) </span><span class="s3">if </span><span class="s1">save_conf </span><span class="s3">else </span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, *</span><span class="s1">xywh</span><span class="s4">)  </span><span class="s0"># label format</span>
                        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">txt_path</span><span class="s3">}</span><span class="s6">.txt&quot;</span><span class="s4">, </span><span class="s6">&quot;a&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
                            <span class="s1">f</span><span class="s4">.</span><span class="s1">write</span><span class="s4">((</span><span class="s6">&quot;%g &quot; </span><span class="s4">* </span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">)).</span><span class="s1">rstrip</span><span class="s4">() % </span><span class="s1">line </span><span class="s4">+ </span><span class="s6">&quot;</span><span class="s3">\n</span><span class="s6">&quot;</span><span class="s4">)</span>

                    <span class="s3">if </span><span class="s1">save_img </span><span class="s3">or </span><span class="s1">save_crop </span><span class="s3">or </span><span class="s1">view_img</span><span class="s4">:  </span><span class="s0"># Add bbox to image</span>
                        <span class="s1">c </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">)  </span><span class="s0"># integer class</span>
                        <span class="s1">label </span><span class="s4">= </span><span class="s3">None if </span><span class="s1">hide_labels </span><span class="s3">else </span><span class="s4">(</span><span class="s1">names</span><span class="s4">[</span><span class="s1">c</span><span class="s4">] </span><span class="s3">if </span><span class="s1">hide_conf </span><span class="s3">else </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">names</span><span class="s4">[</span><span class="s1">c</span><span class="s4">]</span><span class="s3">} {</span><span class="s1">conf</span><span class="s3">:</span><span class="s6">.2f</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>
                        <span class="s1">annotator</span><span class="s4">.</span><span class="s1">box_label</span><span class="s4">(</span><span class="s1">xyxy</span><span class="s4">, </span><span class="s1">label</span><span class="s4">, </span><span class="s1">color</span><span class="s4">=</span><span class="s1">colors</span><span class="s4">(</span><span class="s1">c</span><span class="s4">, </span><span class="s3">True</span><span class="s4">))</span>
                    <span class="s3">if </span><span class="s1">save_crop</span><span class="s4">:</span>
                        <span class="s1">save_one_box</span><span class="s4">(</span><span class="s1">xyxy</span><span class="s4">, </span><span class="s1">imc</span><span class="s4">, </span><span class="s1">file</span><span class="s4">=</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;crops&quot; </span><span class="s4">/ </span><span class="s1">names</span><span class="s4">[</span><span class="s1">c</span><span class="s4">] / </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">p</span><span class="s4">.</span><span class="s1">stem</span><span class="s3">}</span><span class="s6">.jpg&quot;</span><span class="s4">, </span><span class="s1">BGR</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

            <span class="s0"># Stream results</span>
            <span class="s1">im0 </span><span class="s4">= </span><span class="s1">annotator</span><span class="s4">.</span><span class="s1">result</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">view_img</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">platform</span><span class="s4">.</span><span class="s1">system</span><span class="s4">() == </span><span class="s6">&quot;Linux&quot; </span><span class="s3">and </span><span class="s1">p </span><span class="s3">not in </span><span class="s1">windows</span><span class="s4">:</span>
                    <span class="s1">windows</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">p</span><span class="s4">)</span>
                    <span class="s1">cv2</span><span class="s4">.</span><span class="s1">namedWindow</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">p</span><span class="s4">), </span><span class="s1">cv2</span><span class="s4">.</span><span class="s1">WINDOW_NORMAL </span><span class="s4">| </span><span class="s1">cv2</span><span class="s4">.</span><span class="s1">WINDOW_KEEPRATIO</span><span class="s4">)  </span><span class="s0"># allow window resize (Linux)</span>
                    <span class="s1">cv2</span><span class="s4">.</span><span class="s1">resizeWindow</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">p</span><span class="s4">), </span><span class="s1">im0</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], </span><span class="s1">im0</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])</span>
                <span class="s1">cv2</span><span class="s4">.</span><span class="s1">imshow</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">p</span><span class="s4">), </span><span class="s1">im0</span><span class="s4">)</span>
                <span class="s1">cv2</span><span class="s4">.</span><span class="s1">waitKey</span><span class="s4">(</span><span class="s5">1</span><span class="s4">)  </span><span class="s0"># 1 millisecond</span>

            <span class="s0"># Save results (image with detections)</span>
            <span class="s3">if </span><span class="s1">save_img</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">mode </span><span class="s4">== </span><span class="s6">&quot;image&quot;</span><span class="s4">:</span>
                    <span class="s1">cv2</span><span class="s4">.</span><span class="s1">imwrite</span><span class="s4">(</span><span class="s1">save_path</span><span class="s4">, </span><span class="s1">im0</span><span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:  </span><span class="s0"># 'video' or 'stream'</span>
                    <span class="s3">if </span><span class="s1">vid_path</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] != </span><span class="s1">save_path</span><span class="s4">:  </span><span class="s0"># new video</span>
                        <span class="s1">vid_path</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">save_path</span>
                        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">vid_writer</span><span class="s4">[</span><span class="s1">i</span><span class="s4">], </span><span class="s1">cv2</span><span class="s4">.</span><span class="s1">VideoWriter</span><span class="s4">):</span>
                            <span class="s1">vid_writer</span><span class="s4">[</span><span class="s1">i</span><span class="s4">].</span><span class="s1">release</span><span class="s4">()  </span><span class="s0"># release previous video writer</span>
                        <span class="s3">if </span><span class="s1">vid_cap</span><span class="s4">:  </span><span class="s0"># video</span>
                            <span class="s1">fps </span><span class="s4">= </span><span class="s1">vid_cap</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">cv2</span><span class="s4">.</span><span class="s1">CAP_PROP_FPS</span><span class="s4">)</span>
                            <span class="s1">w </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">vid_cap</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">cv2</span><span class="s4">.</span><span class="s1">CAP_PROP_FRAME_WIDTH</span><span class="s4">))</span>
                            <span class="s1">h </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">vid_cap</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">cv2</span><span class="s4">.</span><span class="s1">CAP_PROP_FRAME_HEIGHT</span><span class="s4">))</span>
                        <span class="s3">else</span><span class="s4">:  </span><span class="s0"># stream</span>
                            <span class="s1">fps</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">h </span><span class="s4">= </span><span class="s5">30</span><span class="s4">, </span><span class="s1">im0</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], </span><span class="s1">im0</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
                        <span class="s1">save_path </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">save_path</span><span class="s4">).</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.mp4&quot;</span><span class="s4">))  </span><span class="s0"># force *.mp4 suffix on results videos</span>
                        <span class="s1">vid_writer</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">cv2</span><span class="s4">.</span><span class="s1">VideoWriter</span><span class="s4">(</span><span class="s1">save_path</span><span class="s4">, </span><span class="s1">cv2</span><span class="s4">.</span><span class="s1">VideoWriter_fourcc</span><span class="s4">(*</span><span class="s6">&quot;mp4v&quot;</span><span class="s4">), </span><span class="s1">fps</span><span class="s4">, (</span><span class="s1">w</span><span class="s4">, </span><span class="s1">h</span><span class="s4">))</span>
                    <span class="s1">vid_writer</span><span class="s4">[</span><span class="s1">i</span><span class="s4">].</span><span class="s1">write</span><span class="s4">(</span><span class="s1">im0</span><span class="s4">)</span>

        <span class="s0"># Print time (inference-only)</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">s</span><span class="s3">}{</span><span class="s6">'' </span><span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">det</span><span class="s4">) </span><span class="s3">else </span><span class="s6">'(no detections), '</span><span class="s3">}{</span><span class="s1">dt</span><span class="s4">[</span><span class="s5">1</span><span class="s4">].</span><span class="s1">dt </span><span class="s4">* </span><span class="s5">1E3</span><span class="s3">:</span><span class="s6">.1f</span><span class="s3">}</span><span class="s6">ms&quot;</span><span class="s4">)</span>

    <span class="s0"># Print results</span>
    <span class="s1">t </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">x</span><span class="s4">.</span><span class="s1">t </span><span class="s4">/ </span><span class="s1">seen </span><span class="s4">* </span><span class="s5">1e3 </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">dt</span><span class="s4">)  </span><span class="s0"># speeds per image</span>
    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;Speed: %.1fms pre-process, %.1fms inference, %.1fms NMS per image at shape </span><span class="s3">{</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, *</span><span class="s1">imgsz</span><span class="s4">)</span><span class="s3">}</span><span class="s6">&quot; </span><span class="s4">% </span><span class="s1">t</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">save_txt </span><span class="s3">or </span><span class="s1">save_img</span><span class="s4">:</span>
        <span class="s1">s </span><span class="s4">= </span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">len</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">save_dir</span><span class="s4">.</span><span class="s1">glob</span><span class="s4">(</span><span class="s6">'labels/*.txt'</span><span class="s4">)))</span><span class="s3">} </span><span class="s6">labels saved to </span><span class="s3">{</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">'labels'</span><span class="s3">}</span><span class="s6">&quot; </span><span class="s3">if </span><span class="s1">save_txt </span><span class="s3">else </span><span class="s6">&quot;&quot;</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;Results saved to </span><span class="s3">{</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">'bold'</span><span class="s4">, </span><span class="s1">save_dir</span><span class="s4">)</span><span class="s3">}{</span><span class="s1">s</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">update</span><span class="s4">:</span>
        <span class="s1">strip_optimizer</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])  </span><span class="s0"># update model (to fix SourceChangeWarning)</span>


<span class="s3">def </span><span class="s1">parse_opt</span><span class="s4">():</span>
    <span class="s1">parser </span><span class="s4">= </span><span class="s1">argparse</span><span class="s4">.</span><span class="s1">ArgumentParser</span><span class="s4">()</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--weights&quot;</span><span class="s4">, </span><span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;+&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;yolov5s.pt&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;model path or triton URL&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--source&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;data/images&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;file/dir/URL/glob/screen/0(webcam)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--data&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;data/coco128.yaml&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;(optional) dataset.yaml path&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--imgsz&quot;</span><span class="s4">, </span><span class="s6">&quot;--img&quot;</span><span class="s4">, </span><span class="s6">&quot;--img-size&quot;</span><span class="s4">, </span><span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;+&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=[</span><span class="s5">640</span><span class="s4">], </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;inference size h,w&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--conf-thres&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">float</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">0.25</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;confidence threshold&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--iou-thres&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">float</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">0.45</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;NMS IoU threshold&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--max-det&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">1000</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;maximum detections per image&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--device&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;cuda device, i.e. 0 or 0,1,2,3 or cpu&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--view-img&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;show results&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--save-txt&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save results to *.txt&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--save-csv&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save results in CSV format&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--save-conf&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save confidences in --save-txt labels&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--save-crop&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save cropped prediction boxes&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--nosave&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;do not save images/videos&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--classes&quot;</span><span class="s4">, </span><span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;+&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;filter by class: --classes 0, or --classes 0 2 3&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--agnostic-nms&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;class-agnostic NMS&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--augment&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;augmented inference&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--visualize&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;visualize features&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--update&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;update all models&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--project&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;runs/detect&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save results to project/name&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--name&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;exp&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save results to project/name&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--exist-ok&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;existing project/name ok, do not increment&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--line-thickness&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">3</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;bounding box thickness (pixels)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--hide-labels&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;hide labels&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--hide-conf&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;hide confidences&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--half&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;use FP16 half-precision inference&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--dnn&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;use OpenCV DNN for ONNX inference&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--vid-stride&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;video frame-rate stride&quot;</span><span class="s4">)</span>
    <span class="s1">opt </span><span class="s4">= </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse_args</span><span class="s4">()</span>
    <span class="s1">opt</span><span class="s4">.</span><span class="s1">imgsz </span><span class="s4">*= </span><span class="s5">2 </span><span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">imgsz</span><span class="s4">) == </span><span class="s5">1 </span><span class="s3">else </span><span class="s5">1  </span><span class="s0"># expand</span>
    <span class="s1">print_args</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">))</span>
    <span class="s3">return </span><span class="s1">opt</span>


<span class="s3">def </span><span class="s1">main</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">):</span>
    <span class="s1">check_requirements</span><span class="s4">(</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;requirements.txt&quot;</span><span class="s4">, </span><span class="s1">exclude</span><span class="s4">=(</span><span class="s6">&quot;tensorboard&quot;</span><span class="s4">, </span><span class="s6">&quot;thop&quot;</span><span class="s4">))</span>
    <span class="s1">run</span><span class="s4">(**</span><span class="s1">vars</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">))</span>


<span class="s3">if </span><span class="s1">__name__ </span><span class="s4">== </span><span class="s6">&quot;__main__&quot;</span><span class="s4">:</span>
    <span class="s1">opt </span><span class="s4">= </span><span class="s1">parse_opt</span><span class="s4">()</span>
    <span class="s1">main</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">)</span>
</pre>
</body>
</html>