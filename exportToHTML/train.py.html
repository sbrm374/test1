<html>
<head>
<title>train.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
train.py</font>
</center></td></tr></table>
<pre><span class="s0"># YOLOv5 üöÄ by Ultralytics, AGPL-3.0 license</span>
<span class="s2">&quot;&quot;&quot; 
Train a YOLOv5 model on a custom dataset. Models and datasets download automatically from the latest YOLOv5 release. 
 
Usage - Single-GPU training: 
    $ python train.py --data coco128.yaml --weights yolov5s.pt --img 640  # from pretrained (recommended) 
    $ python train.py --data coco128.yaml --weights '' --cfg yolov5s.yaml --img 640  # from scratch 
 
Usage - Multi-GPU DDP training: 
    $ python -m torch.distributed.run --nproc_per_node 4 --master_port 1 train.py --data coco128.yaml --weights yolov5s.pt --img 640 --device 0,1,2,3 
 
Models:     https://github.com/ultralytics/yolov5/tree/master/models 
Datasets:   https://github.com/ultralytics/yolov5/tree/master/data 
Tutorial:   https://docs.ultralytics.com/yolov5/tutorials/train_custom_data 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">argparse</span>
<span class="s3">import </span><span class="s1">math</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">random</span>
<span class="s3">import </span><span class="s1">subprocess</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">import </span><span class="s1">time</span>
<span class="s3">from </span><span class="s1">copy </span><span class="s3">import </span><span class="s1">deepcopy</span>
<span class="s3">from </span><span class="s1">datetime </span><span class="s3">import </span><span class="s1">datetime</span><span class="s4">, </span><span class="s1">timedelta</span>
<span class="s3">from </span><span class="s1">pathlib </span><span class="s3">import </span><span class="s1">Path</span>

<span class="s3">try</span><span class="s4">:</span>
    <span class="s3">import </span><span class="s1">comet_ml  </span><span class="s0"># must be imported before torch (if installed)</span>
<span class="s3">except </span><span class="s1">ImportError</span><span class="s4">:</span>
    <span class="s1">comet_ml </span><span class="s4">= </span><span class="s3">None</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">torch</span>
<span class="s3">import </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">distributed </span><span class="s3">as </span><span class="s1">dist</span>
<span class="s3">import </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">nn </span><span class="s3">as </span><span class="s1">nn</span>
<span class="s3">import </span><span class="s1">yaml</span>
<span class="s3">from </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">optim </span><span class="s3">import </span><span class="s1">lr_scheduler</span>
<span class="s3">from </span><span class="s1">tqdm </span><span class="s3">import </span><span class="s1">tqdm</span>

<span class="s1">FILE </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">__file__</span><span class="s4">).</span><span class="s1">resolve</span><span class="s4">()</span>
<span class="s1">ROOT </span><span class="s4">= </span><span class="s1">FILE</span><span class="s4">.</span><span class="s1">parents</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]  </span><span class="s0"># YOLOv5 root directory</span>
<span class="s3">if </span><span class="s1">str</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">) </span><span class="s3">not in </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">path</span><span class="s4">:</span>
    <span class="s1">sys</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">))  </span><span class="s0"># add ROOT to PATH</span>
<span class="s1">ROOT </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">relpath</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">, </span><span class="s1">Path</span><span class="s4">.</span><span class="s1">cwd</span><span class="s4">()))  </span><span class="s0"># relative</span>

<span class="s3">import </span><span class="s1">val </span><span class="s3">as </span><span class="s1">validate  </span><span class="s0"># for end-of-epoch mAP</span>
<span class="s3">from </span><span class="s1">models</span><span class="s4">.</span><span class="s1">experimental </span><span class="s3">import </span><span class="s1">attempt_load</span>
<span class="s3">from </span><span class="s1">models</span><span class="s4">.</span><span class="s1">yolo </span><span class="s3">import </span><span class="s1">Model</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">autoanchor </span><span class="s3">import </span><span class="s1">check_anchors</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">autobatch </span><span class="s3">import </span><span class="s1">check_train_batch_size</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">callbacks </span><span class="s3">import </span><span class="s1">Callbacks</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">dataloaders </span><span class="s3">import </span><span class="s1">create_dataloader</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">downloads </span><span class="s3">import </span><span class="s1">attempt_download</span><span class="s4">, </span><span class="s1">is_url</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">general </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">LOGGER</span><span class="s4">,</span>
    <span class="s1">TQDM_BAR_FORMAT</span><span class="s4">,</span>
    <span class="s1">check_amp</span><span class="s4">,</span>
    <span class="s1">check_dataset</span><span class="s4">,</span>
    <span class="s1">check_file</span><span class="s4">,</span>
    <span class="s1">check_git_info</span><span class="s4">,</span>
    <span class="s1">check_git_status</span><span class="s4">,</span>
    <span class="s1">check_img_size</span><span class="s4">,</span>
    <span class="s1">check_requirements</span><span class="s4">,</span>
    <span class="s1">check_suffix</span><span class="s4">,</span>
    <span class="s1">check_yaml</span><span class="s4">,</span>
    <span class="s1">colorstr</span><span class="s4">,</span>
    <span class="s1">get_latest_run</span><span class="s4">,</span>
    <span class="s1">increment_path</span><span class="s4">,</span>
    <span class="s1">init_seeds</span><span class="s4">,</span>
    <span class="s1">intersect_dicts</span><span class="s4">,</span>
    <span class="s1">labels_to_class_weights</span><span class="s4">,</span>
    <span class="s1">labels_to_image_weights</span><span class="s4">,</span>
    <span class="s1">methods</span><span class="s4">,</span>
    <span class="s1">one_cycle</span><span class="s4">,</span>
    <span class="s1">print_args</span><span class="s4">,</span>
    <span class="s1">print_mutation</span><span class="s4">,</span>
    <span class="s1">strip_optimizer</span><span class="s4">,</span>
    <span class="s1">yaml_save</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">loggers </span><span class="s3">import </span><span class="s1">LOGGERS</span><span class="s4">, </span><span class="s1">Loggers</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">loggers</span><span class="s4">.</span><span class="s1">comet</span><span class="s4">.</span><span class="s1">comet_utils </span><span class="s3">import </span><span class="s1">check_comet_resume</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">loss </span><span class="s3">import </span><span class="s1">ComputeLoss</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">metrics </span><span class="s3">import </span><span class="s1">fitness</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">plots </span><span class="s3">import </span><span class="s1">plot_evolve</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">torch_utils </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">EarlyStopping</span><span class="s4">,</span>
    <span class="s1">ModelEMA</span><span class="s4">,</span>
    <span class="s1">de_parallel</span><span class="s4">,</span>
    <span class="s1">select_device</span><span class="s4">,</span>
    <span class="s1">smart_DDP</span><span class="s4">,</span>
    <span class="s1">smart_optimizer</span><span class="s4">,</span>
    <span class="s1">smart_resume</span><span class="s4">,</span>
    <span class="s1">torch_distributed_zero_first</span><span class="s4">,</span>
<span class="s4">)</span>

<span class="s1">LOCAL_RANK </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">getenv</span><span class="s4">(</span><span class="s6">&quot;LOCAL_RANK&quot;</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">))  </span><span class="s0"># https://pytorch.org/docs/stable/elastic/run.html</span>
<span class="s1">RANK </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">getenv</span><span class="s4">(</span><span class="s6">&quot;RANK&quot;</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">))</span>
<span class="s1">WORLD_SIZE </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">getenv</span><span class="s4">(</span><span class="s6">&quot;WORLD_SIZE&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">))</span>
<span class="s1">GIT_INFO </span><span class="s4">= </span><span class="s1">check_git_info</span><span class="s4">()</span>


<span class="s3">def </span><span class="s1">train</span><span class="s4">(</span><span class="s1">hyp</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">, </span><span class="s1">device</span><span class="s4">, </span><span class="s1">callbacks</span><span class="s4">):  </span><span class="s0"># hyp is path/to/hyp.yaml or hyp dictionary</span>
    <span class="s1">save_dir</span><span class="s4">, </span><span class="s1">epochs</span><span class="s4">, </span><span class="s1">batch_size</span><span class="s4">, </span><span class="s1">weights</span><span class="s4">, </span><span class="s1">single_cls</span><span class="s4">, </span><span class="s1">evolve</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">cfg</span><span class="s4">, </span><span class="s1">resume</span><span class="s4">, </span><span class="s1">noval</span><span class="s4">, </span><span class="s1">nosave</span><span class="s4">, </span><span class="s1">workers</span><span class="s4">, </span><span class="s1">freeze </span><span class="s4">= (</span>
        <span class="s1">Path</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">save_dir</span><span class="s4">),</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">epochs</span><span class="s4">,</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">batch_size</span><span class="s4">,</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">weights</span><span class="s4">,</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">single_cls</span><span class="s4">,</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve</span><span class="s4">,</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">data</span><span class="s4">,</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">cfg</span><span class="s4">,</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">resume</span><span class="s4">,</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">noval</span><span class="s4">,</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">nosave</span><span class="s4">,</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">workers</span><span class="s4">,</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">freeze</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_pretrain_routine_start&quot;</span><span class="s4">)</span>

    <span class="s0"># Directories</span>
    <span class="s1">w </span><span class="s4">= </span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;weights&quot;  </span><span class="s0"># weights dir</span>
    <span class="s4">(</span><span class="s1">w</span><span class="s4">.</span><span class="s1">parent </span><span class="s3">if </span><span class="s1">evolve </span><span class="s3">else </span><span class="s1">w</span><span class="s4">).</span><span class="s1">mkdir</span><span class="s4">(</span><span class="s1">parents</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">exist_ok</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)  </span><span class="s0"># make dir</span>
    <span class="s1">last</span><span class="s4">, </span><span class="s1">best </span><span class="s4">= </span><span class="s1">w </span><span class="s4">/ </span><span class="s6">&quot;last.pt&quot;</span><span class="s4">, </span><span class="s1">w </span><span class="s4">/ </span><span class="s6">&quot;best.pt&quot;</span>

    <span class="s0"># Hyperparameters</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">hyp</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">hyp</span><span class="s4">, </span><span class="s1">errors</span><span class="s4">=</span><span class="s6">&quot;ignore&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">hyp </span><span class="s4">= </span><span class="s1">yaml</span><span class="s4">.</span><span class="s1">safe_load</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)  </span><span class="s0"># load hyps dict</span>
    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;hyperparameters: &quot;</span><span class="s4">) + </span><span class="s6">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">k</span><span class="s3">}</span><span class="s6">=</span><span class="s3">{</span><span class="s1">v</span><span class="s3">}</span><span class="s6">&quot; </span><span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">hyp</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()))</span>
    <span class="s1">opt</span><span class="s4">.</span><span class="s1">hyp </span><span class="s4">= </span><span class="s1">hyp</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()  </span><span class="s0"># for saving hyps to checkpoints</span>

    <span class="s0"># Save run settings</span>
    <span class="s3">if not </span><span class="s1">evolve</span><span class="s4">:</span>
        <span class="s1">yaml_save</span><span class="s4">(</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;hyp.yaml&quot;</span><span class="s4">, </span><span class="s1">hyp</span><span class="s4">)</span>
        <span class="s1">yaml_save</span><span class="s4">(</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;opt.yaml&quot;</span><span class="s4">, </span><span class="s1">vars</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">))</span>

    <span class="s0"># Loggers</span>
    <span class="s1">data_dict </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">if </span><span class="s1">RANK </span><span class="s3">in </span><span class="s4">{-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">}:</span>
        <span class="s1">include_loggers </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">LOGGERS</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">, </span><span class="s6">&quot;ndjson_console&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
            <span class="s1">include_loggers</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s6">&quot;ndjson_console&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">, </span><span class="s6">&quot;ndjson_file&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
            <span class="s1">include_loggers</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s6">&quot;ndjson_file&quot;</span><span class="s4">)</span>

        <span class="s1">loggers </span><span class="s4">= </span><span class="s1">Loggers</span><span class="s4">(</span>
            <span class="s1">save_dir</span><span class="s4">=</span><span class="s1">save_dir</span><span class="s4">,</span>
            <span class="s1">weights</span><span class="s4">=</span><span class="s1">weights</span><span class="s4">,</span>
            <span class="s1">opt</span><span class="s4">=</span><span class="s1">opt</span><span class="s4">,</span>
            <span class="s1">hyp</span><span class="s4">=</span><span class="s1">hyp</span><span class="s4">,</span>
            <span class="s1">logger</span><span class="s4">=</span><span class="s1">LOGGER</span><span class="s4">,</span>
            <span class="s1">include</span><span class="s4">=</span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">include_loggers</span><span class="s4">),</span>
        <span class="s4">)</span>

        <span class="s0"># Register actions</span>
        <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">methods</span><span class="s4">(</span><span class="s1">loggers</span><span class="s4">):</span>
            <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">register_action</span><span class="s4">(</span><span class="s1">k</span><span class="s4">, </span><span class="s1">callback</span><span class="s4">=</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">loggers</span><span class="s4">, </span><span class="s1">k</span><span class="s4">))</span>

        <span class="s0"># Process custom dataset artifact link</span>
        <span class="s1">data_dict </span><span class="s4">= </span><span class="s1">loggers</span><span class="s4">.</span><span class="s1">remote_dataset</span>
        <span class="s3">if </span><span class="s1">resume</span><span class="s4">:  </span><span class="s0"># If resuming runs from remote artifact</span>
            <span class="s1">weights</span><span class="s4">, </span><span class="s1">epochs</span><span class="s4">, </span><span class="s1">hyp</span><span class="s4">, </span><span class="s1">batch_size </span><span class="s4">= </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">epochs</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">hyp</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">batch_size</span>

    <span class="s0"># Config</span>
    <span class="s1">plots </span><span class="s4">= </span><span class="s3">not </span><span class="s1">evolve </span><span class="s3">and not </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">noplots  </span><span class="s0"># create plots</span>
    <span class="s1">cuda </span><span class="s4">= </span><span class="s1">device</span><span class="s4">.</span><span class="s1">type </span><span class="s4">!= </span><span class="s6">&quot;cpu&quot;</span>
    <span class="s1">init_seeds</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">seed </span><span class="s4">+ </span><span class="s5">1 </span><span class="s4">+ </span><span class="s1">RANK</span><span class="s4">, </span><span class="s1">deterministic</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">torch_distributed_zero_first</span><span class="s4">(</span><span class="s1">LOCAL_RANK</span><span class="s4">):</span>
        <span class="s1">data_dict </span><span class="s4">= </span><span class="s1">data_dict </span><span class="s3">or </span><span class="s1">check_dataset</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)  </span><span class="s0"># check if None</span>
    <span class="s1">train_path</span><span class="s4">, </span><span class="s1">val_path </span><span class="s4">= </span><span class="s1">data_dict</span><span class="s4">[</span><span class="s6">&quot;train&quot;</span><span class="s4">], </span><span class="s1">data_dict</span><span class="s4">[</span><span class="s6">&quot;val&quot;</span><span class="s4">]</span>
    <span class="s1">nc </span><span class="s4">= </span><span class="s5">1 </span><span class="s3">if </span><span class="s1">single_cls </span><span class="s3">else </span><span class="s1">int</span><span class="s4">(</span><span class="s1">data_dict</span><span class="s4">[</span><span class="s6">&quot;nc&quot;</span><span class="s4">])  </span><span class="s0"># number of classes</span>
    <span class="s1">names </span><span class="s4">= {</span><span class="s5">0</span><span class="s4">: </span><span class="s6">&quot;item&quot;</span><span class="s4">} </span><span class="s3">if </span><span class="s1">single_cls </span><span class="s3">and </span><span class="s1">len</span><span class="s4">(</span><span class="s1">data_dict</span><span class="s4">[</span><span class="s6">&quot;names&quot;</span><span class="s4">]) != </span><span class="s5">1 </span><span class="s3">else </span><span class="s1">data_dict</span><span class="s4">[</span><span class="s6">&quot;names&quot;</span><span class="s4">]  </span><span class="s0"># class names</span>
    <span class="s1">is_coco </span><span class="s4">= </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">val_path</span><span class="s4">, </span><span class="s1">str</span><span class="s4">) </span><span class="s3">and </span><span class="s1">val_path</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span><span class="s6">&quot;coco/val2017.txt&quot;</span><span class="s4">)  </span><span class="s0"># COCO dataset</span>

    <span class="s0"># Model</span>
    <span class="s1">check_suffix</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">, </span><span class="s6">&quot;.pt&quot;</span><span class="s4">)  </span><span class="s0"># check weights</span>
    <span class="s1">pretrained </span><span class="s4">= </span><span class="s1">weights</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span><span class="s6">&quot;.pt&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">pretrained</span><span class="s4">:</span>
        <span class="s3">with </span><span class="s1">torch_distributed_zero_first</span><span class="s4">(</span><span class="s1">LOCAL_RANK</span><span class="s4">):</span>
            <span class="s1">weights </span><span class="s4">= </span><span class="s1">attempt_download</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">)  </span><span class="s0"># download if not found locally</span>
        <span class="s1">ckpt </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">load</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">, </span><span class="s1">map_location</span><span class="s4">=</span><span class="s6">&quot;cpu&quot;</span><span class="s4">)  </span><span class="s0"># load checkpoint to CPU to avoid CUDA memory leak</span>
        <span class="s1">model </span><span class="s4">= </span><span class="s1">Model</span><span class="s4">(</span><span class="s1">cfg </span><span class="s3">or </span><span class="s1">ckpt</span><span class="s4">[</span><span class="s6">&quot;model&quot;</span><span class="s4">].</span><span class="s1">yaml</span><span class="s4">, </span><span class="s1">ch</span><span class="s4">=</span><span class="s5">3</span><span class="s4">, </span><span class="s1">nc</span><span class="s4">=</span><span class="s1">nc</span><span class="s4">, </span><span class="s1">anchors</span><span class="s4">=</span><span class="s1">hyp</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">&quot;anchors&quot;</span><span class="s4">)).</span><span class="s1">to</span><span class="s4">(</span><span class="s1">device</span><span class="s4">)  </span><span class="s0"># create</span>
        <span class="s1">exclude </span><span class="s4">= [</span><span class="s6">&quot;anchor&quot;</span><span class="s4">] </span><span class="s3">if </span><span class="s4">(</span><span class="s1">cfg </span><span class="s3">or </span><span class="s1">hyp</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">&quot;anchors&quot;</span><span class="s4">)) </span><span class="s3">and not </span><span class="s1">resume </span><span class="s3">else </span><span class="s4">[]  </span><span class="s0"># exclude keys</span>
        <span class="s1">csd </span><span class="s4">= </span><span class="s1">ckpt</span><span class="s4">[</span><span class="s6">&quot;model&quot;</span><span class="s4">].</span><span class="s1">float</span><span class="s4">().</span><span class="s1">state_dict</span><span class="s4">()  </span><span class="s0"># checkpoint state_dict as FP32</span>
        <span class="s1">csd </span><span class="s4">= </span><span class="s1">intersect_dicts</span><span class="s4">(</span><span class="s1">csd</span><span class="s4">, </span><span class="s1">model</span><span class="s4">.</span><span class="s1">state_dict</span><span class="s4">(), </span><span class="s1">exclude</span><span class="s4">=</span><span class="s1">exclude</span><span class="s4">)  </span><span class="s0"># intersect</span>
        <span class="s1">model</span><span class="s4">.</span><span class="s1">load_state_dict</span><span class="s4">(</span><span class="s1">csd</span><span class="s4">, </span><span class="s1">strict</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)  </span><span class="s0"># load</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;Transferred </span><span class="s3">{</span><span class="s1">len</span><span class="s4">(</span><span class="s1">csd</span><span class="s4">)</span><span class="s3">}</span><span class="s6">/</span><span class="s3">{</span><span class="s1">len</span><span class="s4">(</span><span class="s1">model</span><span class="s4">.</span><span class="s1">state_dict</span><span class="s4">())</span><span class="s3">} </span><span class="s6">items from </span><span class="s3">{</span><span class="s1">weights</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)  </span><span class="s0"># report</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">model </span><span class="s4">= </span><span class="s1">Model</span><span class="s4">(</span><span class="s1">cfg</span><span class="s4">, </span><span class="s1">ch</span><span class="s4">=</span><span class="s5">3</span><span class="s4">, </span><span class="s1">nc</span><span class="s4">=</span><span class="s1">nc</span><span class="s4">, </span><span class="s1">anchors</span><span class="s4">=</span><span class="s1">hyp</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">&quot;anchors&quot;</span><span class="s4">)).</span><span class="s1">to</span><span class="s4">(</span><span class="s1">device</span><span class="s4">)  </span><span class="s0"># create</span>
    <span class="s1">amp </span><span class="s4">= </span><span class="s1">check_amp</span><span class="s4">(</span><span class="s1">model</span><span class="s4">)  </span><span class="s0"># check AMP</span>

    <span class="s0"># Freeze</span>
    <span class="s1">freeze </span><span class="s4">= [</span><span class="s6">f&quot;model.</span><span class="s3">{</span><span class="s1">x</span><span class="s3">}</span><span class="s6">.&quot; </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s4">(</span><span class="s1">freeze </span><span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">freeze</span><span class="s4">) &gt; </span><span class="s5">1 </span><span class="s3">else </span><span class="s1">range</span><span class="s4">(</span><span class="s1">freeze</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]))]  </span><span class="s0"># layers to freeze</span>
    <span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">model</span><span class="s4">.</span><span class="s1">named_parameters</span><span class="s4">():</span>
        <span class="s1">v</span><span class="s4">.</span><span class="s1">requires_grad </span><span class="s4">= </span><span class="s3">True  </span><span class="s0"># train all layers</span>
        <span class="s0"># v.register_hook(lambda x: torch.nan_to_num(x))  # NaN to 0 (commented for erratic training results)</span>
        <span class="s3">if </span><span class="s1">any</span><span class="s4">(</span><span class="s1">x </span><span class="s3">in </span><span class="s1">k </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">freeze</span><span class="s4">):</span>
            <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;freezing </span><span class="s3">{</span><span class="s1">k</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>
            <span class="s1">v</span><span class="s4">.</span><span class="s1">requires_grad </span><span class="s4">= </span><span class="s3">False</span>

    <span class="s0"># Image size</span>
    <span class="s1">gs </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span><span class="s1">int</span><span class="s4">(</span><span class="s1">model</span><span class="s4">.</span><span class="s1">stride</span><span class="s4">.</span><span class="s1">max</span><span class="s4">()), </span><span class="s5">32</span><span class="s4">)  </span><span class="s0"># grid size (max stride)</span>
    <span class="s1">imgsz </span><span class="s4">= </span><span class="s1">check_img_size</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">gs</span><span class="s4">, </span><span class="s1">floor</span><span class="s4">=</span><span class="s1">gs </span><span class="s4">* </span><span class="s5">2</span><span class="s4">)  </span><span class="s0"># verify imgsz is gs-multiple</span>

    <span class="s0"># Batch size</span>
    <span class="s3">if </span><span class="s1">RANK </span><span class="s4">== -</span><span class="s5">1 </span><span class="s3">and </span><span class="s1">batch_size </span><span class="s4">== -</span><span class="s5">1</span><span class="s4">:  </span><span class="s0"># single-GPU only, estimate best batch size</span>
        <span class="s1">batch_size </span><span class="s4">= </span><span class="s1">check_train_batch_size</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">amp</span><span class="s4">)</span>
        <span class="s1">loggers</span><span class="s4">.</span><span class="s1">on_params_update</span><span class="s4">({</span><span class="s6">&quot;batch_size&quot;</span><span class="s4">: </span><span class="s1">batch_size</span><span class="s4">})</span>

    <span class="s0"># Optimizer</span>
    <span class="s1">nbs </span><span class="s4">= </span><span class="s5">64  </span><span class="s0"># nominal batch size</span>
    <span class="s1">accumulate </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span><span class="s1">round</span><span class="s4">(</span><span class="s1">nbs </span><span class="s4">/ </span><span class="s1">batch_size</span><span class="s4">), </span><span class="s5">1</span><span class="s4">)  </span><span class="s0"># accumulate loss before optimizing</span>
    <span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;weight_decay&quot;</span><span class="s4">] *= </span><span class="s1">batch_size </span><span class="s4">* </span><span class="s1">accumulate </span><span class="s4">/ </span><span class="s1">nbs  </span><span class="s0"># scale weight_decay</span>
    <span class="s1">optimizer </span><span class="s4">= </span><span class="s1">smart_optimizer</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">optimizer</span><span class="s4">, </span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;lr0&quot;</span><span class="s4">], </span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;momentum&quot;</span><span class="s4">], </span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;weight_decay&quot;</span><span class="s4">])</span>

    <span class="s0"># Scheduler</span>
    <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">cos_lr</span><span class="s4">:</span>
        <span class="s1">lf </span><span class="s4">= </span><span class="s1">one_cycle</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;lrf&quot;</span><span class="s4">], </span><span class="s1">epochs</span><span class="s4">)  </span><span class="s0"># cosine 1-&gt;hyp['lrf']</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">lf </span><span class="s4">= </span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">: (</span><span class="s5">1 </span><span class="s4">- </span><span class="s1">x </span><span class="s4">/ </span><span class="s1">epochs</span><span class="s4">) * (</span><span class="s5">1.0 </span><span class="s4">- </span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;lrf&quot;</span><span class="s4">]) + </span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;lrf&quot;</span><span class="s4">]  </span><span class="s0"># linear</span>
    <span class="s1">scheduler </span><span class="s4">= </span><span class="s1">lr_scheduler</span><span class="s4">.</span><span class="s1">LambdaLR</span><span class="s4">(</span><span class="s1">optimizer</span><span class="s4">, </span><span class="s1">lr_lambda</span><span class="s4">=</span><span class="s1">lf</span><span class="s4">)  </span><span class="s0"># plot_lr_scheduler(optimizer, scheduler, epochs)</span>

    <span class="s0"># EMA</span>
    <span class="s1">ema </span><span class="s4">= </span><span class="s1">ModelEMA</span><span class="s4">(</span><span class="s1">model</span><span class="s4">) </span><span class="s3">if </span><span class="s1">RANK </span><span class="s3">in </span><span class="s4">{-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">} </span><span class="s3">else None</span>

    <span class="s0"># Resume</span>
    <span class="s1">best_fitness</span><span class="s4">, </span><span class="s1">start_epoch </span><span class="s4">= </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0</span>
    <span class="s3">if </span><span class="s1">pretrained</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">resume</span><span class="s4">:</span>
            <span class="s1">best_fitness</span><span class="s4">, </span><span class="s1">start_epoch</span><span class="s4">, </span><span class="s1">epochs </span><span class="s4">= </span><span class="s1">smart_resume</span><span class="s4">(</span><span class="s1">ckpt</span><span class="s4">, </span><span class="s1">optimizer</span><span class="s4">, </span><span class="s1">ema</span><span class="s4">, </span><span class="s1">weights</span><span class="s4">, </span><span class="s1">epochs</span><span class="s4">, </span><span class="s1">resume</span><span class="s4">)</span>
        <span class="s3">del </span><span class="s1">ckpt</span><span class="s4">, </span><span class="s1">csd</span>

    <span class="s0"># DP mode</span>
    <span class="s3">if </span><span class="s1">cuda </span><span class="s3">and </span><span class="s1">RANK </span><span class="s4">== -</span><span class="s5">1 </span><span class="s3">and </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cuda</span><span class="s4">.</span><span class="s1">device_count</span><span class="s4">() &gt; </span><span class="s5">1</span><span class="s4">:</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">warning</span><span class="s4">(</span>
            <span class="s6">&quot;WARNING ‚ö†Ô∏è DP not recommended, use torch.distributed.run for best DDP Multi-GPU results.</span><span class="s3">\n</span><span class="s6">&quot;</span>
            <span class="s6">&quot;See Multi-GPU Tutorial at https://docs.ultralytics.com/yolov5/tutorials/multi_gpu_training to get started.&quot;</span>
        <span class="s4">)</span>
        <span class="s1">model </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">nn</span><span class="s4">.</span><span class="s1">DataParallel</span><span class="s4">(</span><span class="s1">model</span><span class="s4">)</span>

    <span class="s0"># SyncBatchNorm</span>
    <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">sync_bn </span><span class="s3">and </span><span class="s1">cuda </span><span class="s3">and </span><span class="s1">RANK </span><span class="s4">!= -</span><span class="s5">1</span><span class="s4">:</span>
        <span class="s1">model </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">nn</span><span class="s4">.</span><span class="s1">SyncBatchNorm</span><span class="s4">.</span><span class="s1">convert_sync_batchnorm</span><span class="s4">(</span><span class="s1">model</span><span class="s4">).</span><span class="s1">to</span><span class="s4">(</span><span class="s1">device</span><span class="s4">)</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">&quot;Using SyncBatchNorm()&quot;</span><span class="s4">)</span>

    <span class="s0"># Trainloader</span>
    <span class="s1">train_loader</span><span class="s4">, </span><span class="s1">dataset </span><span class="s4">= </span><span class="s1">create_dataloader</span><span class="s4">(</span>
        <span class="s1">train_path</span><span class="s4">,</span>
        <span class="s1">imgsz</span><span class="s4">,</span>
        <span class="s1">batch_size </span><span class="s4">// </span><span class="s1">WORLD_SIZE</span><span class="s4">,</span>
        <span class="s1">gs</span><span class="s4">,</span>
        <span class="s1">single_cls</span><span class="s4">,</span>
        <span class="s1">hyp</span><span class="s4">=</span><span class="s1">hyp</span><span class="s4">,</span>
        <span class="s1">augment</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">cache</span><span class="s4">=</span><span class="s3">None if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">cache </span><span class="s4">== </span><span class="s6">&quot;val&quot; </span><span class="s3">else </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">cache</span><span class="s4">,</span>
        <span class="s1">rect</span><span class="s4">=</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">rect</span><span class="s4">,</span>
        <span class="s1">rank</span><span class="s4">=</span><span class="s1">LOCAL_RANK</span><span class="s4">,</span>
        <span class="s1">workers</span><span class="s4">=</span><span class="s1">workers</span><span class="s4">,</span>
        <span class="s1">image_weights</span><span class="s4">=</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">image_weights</span><span class="s4">,</span>
        <span class="s1">quad</span><span class="s4">=</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">quad</span><span class="s4">,</span>
        <span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;train: &quot;</span><span class="s4">),</span>
        <span class="s1">shuffle</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">seed</span><span class="s4">=</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">seed</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">labels </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">concatenate</span><span class="s4">(</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">labels</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">mlc </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">labels</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">].</span><span class="s1">max</span><span class="s4">())  </span><span class="s0"># max label class</span>
    <span class="s3">assert </span><span class="s1">mlc </span><span class="s4">&lt; </span><span class="s1">nc</span><span class="s4">, </span><span class="s6">f&quot;Label class </span><span class="s3">{</span><span class="s1">mlc</span><span class="s3">} </span><span class="s6">exceeds nc=</span><span class="s3">{</span><span class="s1">nc</span><span class="s3">} </span><span class="s6">in </span><span class="s3">{</span><span class="s1">data</span><span class="s3">}</span><span class="s6">. Possible class labels are 0-</span><span class="s3">{</span><span class="s1">nc </span><span class="s4">- </span><span class="s5">1</span><span class="s3">}</span><span class="s6">&quot;</span>

    <span class="s0"># Process 0</span>
    <span class="s3">if </span><span class="s1">RANK </span><span class="s3">in </span><span class="s4">{-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">}:</span>
        <span class="s1">val_loader </span><span class="s4">= </span><span class="s1">create_dataloader</span><span class="s4">(</span>
            <span class="s1">val_path</span><span class="s4">,</span>
            <span class="s1">imgsz</span><span class="s4">,</span>
            <span class="s1">batch_size </span><span class="s4">// </span><span class="s1">WORLD_SIZE </span><span class="s4">* </span><span class="s5">2</span><span class="s4">,</span>
            <span class="s1">gs</span><span class="s4">,</span>
            <span class="s1">single_cls</span><span class="s4">,</span>
            <span class="s1">hyp</span><span class="s4">=</span><span class="s1">hyp</span><span class="s4">,</span>
            <span class="s1">cache</span><span class="s4">=</span><span class="s3">None if </span><span class="s1">noval </span><span class="s3">else </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">cache</span><span class="s4">,</span>
            <span class="s1">rect</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
            <span class="s1">rank</span><span class="s4">=-</span><span class="s5">1</span><span class="s4">,</span>
            <span class="s1">workers</span><span class="s4">=</span><span class="s1">workers </span><span class="s4">* </span><span class="s5">2</span><span class="s4">,</span>
            <span class="s1">pad</span><span class="s4">=</span><span class="s5">0.5</span><span class="s4">,</span>
            <span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;val: &quot;</span><span class="s4">),</span>
        <span class="s4">)[</span><span class="s5">0</span><span class="s4">]</span>

        <span class="s3">if not </span><span class="s1">resume</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">noautoanchor</span><span class="s4">:</span>
                <span class="s1">check_anchors</span><span class="s4">(</span><span class="s1">dataset</span><span class="s4">, </span><span class="s1">model</span><span class="s4">=</span><span class="s1">model</span><span class="s4">, </span><span class="s1">thr</span><span class="s4">=</span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;anchor_t&quot;</span><span class="s4">], </span><span class="s1">imgsz</span><span class="s4">=</span><span class="s1">imgsz</span><span class="s4">)  </span><span class="s0"># run AutoAnchor</span>
            <span class="s1">model</span><span class="s4">.</span><span class="s1">half</span><span class="s4">().</span><span class="s1">float</span><span class="s4">()  </span><span class="s0"># pre-reduce anchor precision</span>

        <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_pretrain_routine_end&quot;</span><span class="s4">, </span><span class="s1">labels</span><span class="s4">, </span><span class="s1">names</span><span class="s4">)</span>

    <span class="s0"># DDP mode</span>
    <span class="s3">if </span><span class="s1">cuda </span><span class="s3">and </span><span class="s1">RANK </span><span class="s4">!= -</span><span class="s5">1</span><span class="s4">:</span>
        <span class="s1">model </span><span class="s4">= </span><span class="s1">smart_DDP</span><span class="s4">(</span><span class="s1">model</span><span class="s4">)</span>

    <span class="s0"># Model attributes</span>
    <span class="s1">nl </span><span class="s4">= </span><span class="s1">de_parallel</span><span class="s4">(</span><span class="s1">model</span><span class="s4">).</span><span class="s1">model</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">nl  </span><span class="s0"># number of detection layers (to scale hyps)</span>
    <span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;box&quot;</span><span class="s4">] *= </span><span class="s5">3 </span><span class="s4">/ </span><span class="s1">nl  </span><span class="s0"># scale to layers</span>
    <span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;cls&quot;</span><span class="s4">] *= </span><span class="s1">nc </span><span class="s4">/ </span><span class="s5">80 </span><span class="s4">* </span><span class="s5">3 </span><span class="s4">/ </span><span class="s1">nl  </span><span class="s0"># scale to classes and layers</span>
    <span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;obj&quot;</span><span class="s4">] *= (</span><span class="s1">imgsz </span><span class="s4">/ </span><span class="s5">640</span><span class="s4">) ** </span><span class="s5">2 </span><span class="s4">* </span><span class="s5">3 </span><span class="s4">/ </span><span class="s1">nl  </span><span class="s0"># scale to image size and layers</span>
    <span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;label_smoothing&quot;</span><span class="s4">] = </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">label_smoothing</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">nc </span><span class="s4">= </span><span class="s1">nc  </span><span class="s0"># attach number of classes to model</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">hyp </span><span class="s4">= </span><span class="s1">hyp  </span><span class="s0"># attach hyperparameters to model</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">class_weights </span><span class="s4">= </span><span class="s1">labels_to_class_weights</span><span class="s4">(</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">labels</span><span class="s4">, </span><span class="s1">nc</span><span class="s4">).</span><span class="s1">to</span><span class="s4">(</span><span class="s1">device</span><span class="s4">) * </span><span class="s1">nc  </span><span class="s0"># attach class weights</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">names </span><span class="s4">= </span><span class="s1">names</span>

    <span class="s0"># Start training</span>
    <span class="s1">t0 </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
    <span class="s1">nb </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">train_loader</span><span class="s4">)  </span><span class="s0"># number of batches</span>
    <span class="s1">nw </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span><span class="s1">round</span><span class="s4">(</span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;warmup_epochs&quot;</span><span class="s4">] * </span><span class="s1">nb</span><span class="s4">), </span><span class="s5">100</span><span class="s4">)  </span><span class="s0"># number of warmup iterations, max(3 epochs, 100 iterations)</span>
    <span class="s0"># nw = min(nw, (epochs - start_epoch) / 2 * nb)  # limit warmup to &lt; 1/2 of training</span>
    <span class="s1">last_opt_step </span><span class="s4">= -</span><span class="s5">1</span>
    <span class="s1">maps </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">(</span><span class="s1">nc</span><span class="s4">)  </span><span class="s0"># mAP per class</span>
    <span class="s1">results </span><span class="s4">= (</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)  </span><span class="s0"># P, R, mAP@.5, mAP@.5-.95, val_loss(box, obj, cls)</span>
    <span class="s1">scheduler</span><span class="s4">.</span><span class="s1">last_epoch </span><span class="s4">= </span><span class="s1">start_epoch </span><span class="s4">- </span><span class="s5">1  </span><span class="s0"># do not move</span>
    <span class="s1">scaler </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cuda</span><span class="s4">.</span><span class="s1">amp</span><span class="s4">.</span><span class="s1">GradScaler</span><span class="s4">(</span><span class="s1">enabled</span><span class="s4">=</span><span class="s1">amp</span><span class="s4">)</span>
    <span class="s1">stopper</span><span class="s4">, </span><span class="s1">stop </span><span class="s4">= </span><span class="s1">EarlyStopping</span><span class="s4">(</span><span class="s1">patience</span><span class="s4">=</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">patience</span><span class="s4">), </span><span class="s3">False</span>
    <span class="s1">compute_loss </span><span class="s4">= </span><span class="s1">ComputeLoss</span><span class="s4">(</span><span class="s1">model</span><span class="s4">)  </span><span class="s0"># init loss class</span>
    <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_train_start&quot;</span><span class="s4">)</span>
    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span>
        <span class="s6">f'Image sizes </span><span class="s3">{</span><span class="s1">imgsz</span><span class="s3">} </span><span class="s6">train, </span><span class="s3">{</span><span class="s1">imgsz</span><span class="s3">} </span><span class="s6">val</span><span class="s3">\n</span><span class="s6">'</span>
        <span class="s6">f'Using </span><span class="s3">{</span><span class="s1">train_loader</span><span class="s4">.</span><span class="s1">num_workers </span><span class="s4">* </span><span class="s1">WORLD_SIZE</span><span class="s3">} </span><span class="s6">dataloader workers</span><span class="s3">\n</span><span class="s6">'</span>
        <span class="s6">f&quot;Logging results to </span><span class="s3">{</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">'bold'</span><span class="s4">, </span><span class="s1">save_dir</span><span class="s4">)</span><span class="s3">}\n</span><span class="s6">&quot;</span>
        <span class="s6">f'Starting training for </span><span class="s3">{</span><span class="s1">epochs</span><span class="s3">} </span><span class="s6">epochs...'</span>
    <span class="s4">)</span>
    <span class="s3">for </span><span class="s1">epoch </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">start_epoch</span><span class="s4">, </span><span class="s1">epochs</span><span class="s4">):  </span><span class="s0"># epoch ------------------------------------------------------------------</span>
        <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_train_epoch_start&quot;</span><span class="s4">)</span>
        <span class="s1">model</span><span class="s4">.</span><span class="s1">train</span><span class="s4">()</span>

        <span class="s0"># Update image weights (optional, single-GPU only)</span>
        <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">image_weights</span><span class="s4">:</span>
            <span class="s1">cw </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">class_weights</span><span class="s4">.</span><span class="s1">cpu</span><span class="s4">().</span><span class="s1">numpy</span><span class="s4">() * (</span><span class="s5">1 </span><span class="s4">- </span><span class="s1">maps</span><span class="s4">) ** </span><span class="s5">2 </span><span class="s4">/ </span><span class="s1">nc  </span><span class="s0"># class weights</span>
            <span class="s1">iw </span><span class="s4">= </span><span class="s1">labels_to_image_weights</span><span class="s4">(</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">labels</span><span class="s4">, </span><span class="s1">nc</span><span class="s4">=</span><span class="s1">nc</span><span class="s4">, </span><span class="s1">class_weights</span><span class="s4">=</span><span class="s1">cw</span><span class="s4">)  </span><span class="s0"># image weights</span>
            <span class="s1">dataset</span><span class="s4">.</span><span class="s1">indices </span><span class="s4">= </span><span class="s1">random</span><span class="s4">.</span><span class="s1">choices</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">n</span><span class="s4">), </span><span class="s1">weights</span><span class="s4">=</span><span class="s1">iw</span><span class="s4">, </span><span class="s1">k</span><span class="s4">=</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">n</span><span class="s4">)  </span><span class="s0"># rand weighted idx</span>

        <span class="s0"># Update mosaic border (optional)</span>
        <span class="s0"># b = int(random.uniform(0.25 * imgsz, 0.75 * imgsz + gs) // gs * gs)</span>
        <span class="s0"># dataset.mosaic_border = [b - imgsz, -b]  # height, width borders</span>

        <span class="s1">mloss </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">)  </span><span class="s0"># mean losses</span>
        <span class="s3">if </span><span class="s1">RANK </span><span class="s4">!= -</span><span class="s5">1</span><span class="s4">:</span>
            <span class="s1">train_loader</span><span class="s4">.</span><span class="s1">sampler</span><span class="s4">.</span><span class="s1">set_epoch</span><span class="s4">(</span><span class="s1">epoch</span><span class="s4">)</span>
        <span class="s1">pbar </span><span class="s4">= </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">train_loader</span><span class="s4">)</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">((</span><span class="s6">&quot;</span><span class="s3">\n</span><span class="s6">&quot; </span><span class="s4">+ </span><span class="s6">&quot;%11s&quot; </span><span class="s4">* </span><span class="s5">7</span><span class="s4">) % (</span><span class="s6">&quot;Epoch&quot;</span><span class="s4">, </span><span class="s6">&quot;GPU_mem&quot;</span><span class="s4">, </span><span class="s6">&quot;box_loss&quot;</span><span class="s4">, </span><span class="s6">&quot;obj_loss&quot;</span><span class="s4">, </span><span class="s6">&quot;cls_loss&quot;</span><span class="s4">, </span><span class="s6">&quot;Instances&quot;</span><span class="s4">, </span><span class="s6">&quot;Size&quot;</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">RANK </span><span class="s3">in </span><span class="s4">{-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">}:</span>
            <span class="s1">pbar </span><span class="s4">= </span><span class="s1">tqdm</span><span class="s4">(</span><span class="s1">pbar</span><span class="s4">, </span><span class="s1">total</span><span class="s4">=</span><span class="s1">nb</span><span class="s4">, </span><span class="s1">bar_format</span><span class="s4">=</span><span class="s1">TQDM_BAR_FORMAT</span><span class="s4">)  </span><span class="s0"># progress bar</span>
        <span class="s1">optimizer</span><span class="s4">.</span><span class="s1">zero_grad</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, (</span><span class="s1">imgs</span><span class="s4">, </span><span class="s1">targets</span><span class="s4">, </span><span class="s1">paths</span><span class="s4">, </span><span class="s1">_</span><span class="s4">) </span><span class="s3">in </span><span class="s1">pbar</span><span class="s4">:  </span><span class="s0"># batch -------------------------------------------------------------</span>
            <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_train_batch_start&quot;</span><span class="s4">)</span>
            <span class="s1">ni </span><span class="s4">= </span><span class="s1">i </span><span class="s4">+ </span><span class="s1">nb </span><span class="s4">* </span><span class="s1">epoch  </span><span class="s0"># number integrated batches (since train start)</span>
            <span class="s1">imgs </span><span class="s4">= </span><span class="s1">imgs</span><span class="s4">.</span><span class="s1">to</span><span class="s4">(</span><span class="s1">device</span><span class="s4">, </span><span class="s1">non_blocking</span><span class="s4">=</span><span class="s3">True</span><span class="s4">).</span><span class="s1">float</span><span class="s4">() / </span><span class="s5">255  </span><span class="s0"># uint8 to float32, 0-255 to 0.0-1.0</span>

            <span class="s0"># Warmup</span>
            <span class="s3">if </span><span class="s1">ni </span><span class="s4">&lt;= </span><span class="s1">nw</span><span class="s4">:</span>
                <span class="s1">xi </span><span class="s4">= [</span><span class="s5">0</span><span class="s4">, </span><span class="s1">nw</span><span class="s4">]  </span><span class="s0"># x interp</span>
                <span class="s0"># compute_loss.gr = np.interp(ni, xi, [0.0, 1.0])  # iou loss ratio (obj_loss = 1.0 or iou)</span>
                <span class="s1">accumulate </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">interp</span><span class="s4">(</span><span class="s1">ni</span><span class="s4">, </span><span class="s1">xi</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s1">nbs </span><span class="s4">/ </span><span class="s1">batch_size</span><span class="s4">]).</span><span class="s1">round</span><span class="s4">())</span>
                <span class="s3">for </span><span class="s1">j</span><span class="s4">, </span><span class="s1">x </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">optimizer</span><span class="s4">.</span><span class="s1">param_groups</span><span class="s4">):</span>
                    <span class="s0"># bias lr falls from 0.1 to lr0, all other lrs rise from 0.0 to lr0</span>
                    <span class="s1">x</span><span class="s4">[</span><span class="s6">&quot;lr&quot;</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">interp</span><span class="s4">(</span><span class="s1">ni</span><span class="s4">, </span><span class="s1">xi</span><span class="s4">, [</span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;warmup_bias_lr&quot;</span><span class="s4">] </span><span class="s3">if </span><span class="s1">j </span><span class="s4">== </span><span class="s5">0 </span><span class="s3">else </span><span class="s5">0.0</span><span class="s4">, </span><span class="s1">x</span><span class="s4">[</span><span class="s6">&quot;initial_lr&quot;</span><span class="s4">] * </span><span class="s1">lf</span><span class="s4">(</span><span class="s1">epoch</span><span class="s4">)])</span>
                    <span class="s3">if </span><span class="s6">&quot;momentum&quot; </span><span class="s3">in </span><span class="s1">x</span><span class="s4">:</span>
                        <span class="s1">x</span><span class="s4">[</span><span class="s6">&quot;momentum&quot;</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">interp</span><span class="s4">(</span><span class="s1">ni</span><span class="s4">, </span><span class="s1">xi</span><span class="s4">, [</span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;warmup_momentum&quot;</span><span class="s4">], </span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;momentum&quot;</span><span class="s4">]])</span>

            <span class="s0"># Multi-scale</span>
            <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">multi_scale</span><span class="s4">:</span>
                <span class="s1">sz </span><span class="s4">= </span><span class="s1">random</span><span class="s4">.</span><span class="s1">randrange</span><span class="s4">(</span><span class="s1">int</span><span class="s4">(</span><span class="s1">imgsz </span><span class="s4">* </span><span class="s5">0.5</span><span class="s4">), </span><span class="s1">int</span><span class="s4">(</span><span class="s1">imgsz </span><span class="s4">* </span><span class="s5">1.5</span><span class="s4">) + </span><span class="s1">gs</span><span class="s4">) // </span><span class="s1">gs </span><span class="s4">* </span><span class="s1">gs  </span><span class="s0"># size</span>
                <span class="s1">sf </span><span class="s4">= </span><span class="s1">sz </span><span class="s4">/ </span><span class="s1">max</span><span class="s4">(</span><span class="s1">imgs</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">2</span><span class="s4">:])  </span><span class="s0"># scale factor</span>
                <span class="s3">if </span><span class="s1">sf </span><span class="s4">!= </span><span class="s5">1</span><span class="s4">:</span>
                    <span class="s1">ns </span><span class="s4">= [</span><span class="s1">math</span><span class="s4">.</span><span class="s1">ceil</span><span class="s4">(</span><span class="s1">x </span><span class="s4">* </span><span class="s1">sf </span><span class="s4">/ </span><span class="s1">gs</span><span class="s4">) * </span><span class="s1">gs </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">imgs</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">2</span><span class="s4">:]]  </span><span class="s0"># new shape (stretched to gs-multiple)</span>
                    <span class="s1">imgs </span><span class="s4">= </span><span class="s1">nn</span><span class="s4">.</span><span class="s1">functional</span><span class="s4">.</span><span class="s1">interpolate</span><span class="s4">(</span><span class="s1">imgs</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s1">ns</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s6">&quot;bilinear&quot;</span><span class="s4">, </span><span class="s1">align_corners</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

            <span class="s0"># Forward</span>
            <span class="s3">with </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cuda</span><span class="s4">.</span><span class="s1">amp</span><span class="s4">.</span><span class="s1">autocast</span><span class="s4">(</span><span class="s1">amp</span><span class="s4">):</span>
                <span class="s1">pred </span><span class="s4">= </span><span class="s1">model</span><span class="s4">(</span><span class="s1">imgs</span><span class="s4">)  </span><span class="s0"># forward</span>
                <span class="s1">loss</span><span class="s4">, </span><span class="s1">loss_items </span><span class="s4">= </span><span class="s1">compute_loss</span><span class="s4">(</span><span class="s1">pred</span><span class="s4">, </span><span class="s1">targets</span><span class="s4">.</span><span class="s1">to</span><span class="s4">(</span><span class="s1">device</span><span class="s4">))  </span><span class="s0"># loss scaled by batch_size</span>
                <span class="s3">if </span><span class="s1">RANK </span><span class="s4">!= -</span><span class="s5">1</span><span class="s4">:</span>
                    <span class="s1">loss </span><span class="s4">*= </span><span class="s1">WORLD_SIZE  </span><span class="s0"># gradient averaged between devices in DDP mode</span>
                <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">quad</span><span class="s4">:</span>
                    <span class="s1">loss </span><span class="s4">*= </span><span class="s5">4.0</span>

            <span class="s0"># Backward</span>
            <span class="s1">scaler</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">(</span><span class="s1">loss</span><span class="s4">).</span><span class="s1">backward</span><span class="s4">()</span>

            <span class="s0"># Optimize - https://pytorch.org/docs/master/notes/amp_examples.html</span>
            <span class="s3">if </span><span class="s1">ni </span><span class="s4">- </span><span class="s1">last_opt_step </span><span class="s4">&gt;= </span><span class="s1">accumulate</span><span class="s4">:</span>
                <span class="s1">scaler</span><span class="s4">.</span><span class="s1">unscale_</span><span class="s4">(</span><span class="s1">optimizer</span><span class="s4">)  </span><span class="s0"># unscale gradients</span>
                <span class="s1">torch</span><span class="s4">.</span><span class="s1">nn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">clip_grad_norm_</span><span class="s4">(</span><span class="s1">model</span><span class="s4">.</span><span class="s1">parameters</span><span class="s4">(), </span><span class="s1">max_norm</span><span class="s4">=</span><span class="s5">10.0</span><span class="s4">)  </span><span class="s0"># clip gradients</span>
                <span class="s1">scaler</span><span class="s4">.</span><span class="s1">step</span><span class="s4">(</span><span class="s1">optimizer</span><span class="s4">)  </span><span class="s0"># optimizer.step</span>
                <span class="s1">scaler</span><span class="s4">.</span><span class="s1">update</span><span class="s4">()</span>
                <span class="s1">optimizer</span><span class="s4">.</span><span class="s1">zero_grad</span><span class="s4">()</span>
                <span class="s3">if </span><span class="s1">ema</span><span class="s4">:</span>
                    <span class="s1">ema</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">model</span><span class="s4">)</span>
                <span class="s1">last_opt_step </span><span class="s4">= </span><span class="s1">ni</span>

            <span class="s0"># Log</span>
            <span class="s3">if </span><span class="s1">RANK </span><span class="s3">in </span><span class="s4">{-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">}:</span>
                <span class="s1">mloss </span><span class="s4">= (</span><span class="s1">mloss </span><span class="s4">* </span><span class="s1">i </span><span class="s4">+ </span><span class="s1">loss_items</span><span class="s4">) / (</span><span class="s1">i </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">)  </span><span class="s0"># update mean losses</span>
                <span class="s1">mem </span><span class="s4">= </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cuda</span><span class="s4">.</span><span class="s1">memory_reserved</span><span class="s4">() / </span><span class="s5">1E9 </span><span class="s3">if </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cuda</span><span class="s4">.</span><span class="s1">is_available</span><span class="s4">() </span><span class="s3">else </span><span class="s5">0</span><span class="s3">:</span><span class="s6">.3g</span><span class="s3">}</span><span class="s6">G&quot;  </span><span class="s0"># (GB)</span>
                <span class="s1">pbar</span><span class="s4">.</span><span class="s1">set_description</span><span class="s4">(</span>
                    <span class="s4">(</span><span class="s6">&quot;%11s&quot; </span><span class="s4">* </span><span class="s5">2 </span><span class="s4">+ </span><span class="s6">&quot;%11.4g&quot; </span><span class="s4">* </span><span class="s5">5</span><span class="s4">)</span>
                    <span class="s4">% (</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">epoch</span><span class="s3">}</span><span class="s6">/</span><span class="s3">{</span><span class="s1">epochs </span><span class="s4">- </span><span class="s5">1</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">, </span><span class="s1">mem</span><span class="s4">, *</span><span class="s1">mloss</span><span class="s4">, </span><span class="s1">targets</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">imgs</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">])</span>
                <span class="s4">)</span>
                <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_train_batch_end&quot;</span><span class="s4">, </span><span class="s1">model</span><span class="s4">, </span><span class="s1">ni</span><span class="s4">, </span><span class="s1">imgs</span><span class="s4">, </span><span class="s1">targets</span><span class="s4">, </span><span class="s1">paths</span><span class="s4">, </span><span class="s1">list</span><span class="s4">(</span><span class="s1">mloss</span><span class="s4">))</span>
                <span class="s3">if </span><span class="s1">callbacks</span><span class="s4">.</span><span class="s1">stop_training</span><span class="s4">:</span>
                    <span class="s3">return</span>
            <span class="s0"># end batch ------------------------------------------------------------------------------------------------</span>

        <span class="s0"># Scheduler</span>
        <span class="s1">lr </span><span class="s4">= [</span><span class="s1">x</span><span class="s4">[</span><span class="s6">&quot;lr&quot;</span><span class="s4">] </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">optimizer</span><span class="s4">.</span><span class="s1">param_groups</span><span class="s4">]  </span><span class="s0"># for loggers</span>
        <span class="s1">scheduler</span><span class="s4">.</span><span class="s1">step</span><span class="s4">()</span>

        <span class="s3">if </span><span class="s1">RANK </span><span class="s3">in </span><span class="s4">{-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">}:</span>
            <span class="s0"># mAP</span>
            <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_train_epoch_end&quot;</span><span class="s4">, </span><span class="s1">epoch</span><span class="s4">=</span><span class="s1">epoch</span><span class="s4">)</span>
            <span class="s1">ema</span><span class="s4">.</span><span class="s1">update_attr</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">include</span><span class="s4">=[</span><span class="s6">&quot;yaml&quot;</span><span class="s4">, </span><span class="s6">&quot;nc&quot;</span><span class="s4">, </span><span class="s6">&quot;hyp&quot;</span><span class="s4">, </span><span class="s6">&quot;names&quot;</span><span class="s4">, </span><span class="s6">&quot;stride&quot;</span><span class="s4">, </span><span class="s6">&quot;class_weights&quot;</span><span class="s4">])</span>
            <span class="s1">final_epoch </span><span class="s4">= (</span><span class="s1">epoch </span><span class="s4">+ </span><span class="s5">1 </span><span class="s4">== </span><span class="s1">epochs</span><span class="s4">) </span><span class="s3">or </span><span class="s1">stopper</span><span class="s4">.</span><span class="s1">possible_stop</span>
            <span class="s3">if not </span><span class="s1">noval </span><span class="s3">or </span><span class="s1">final_epoch</span><span class="s4">:  </span><span class="s0"># Calculate mAP</span>
                <span class="s1">results</span><span class="s4">, </span><span class="s1">maps</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">validate</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span>
                    <span class="s1">data_dict</span><span class="s4">,</span>
                    <span class="s1">batch_size</span><span class="s4">=</span><span class="s1">batch_size </span><span class="s4">// </span><span class="s1">WORLD_SIZE </span><span class="s4">* </span><span class="s5">2</span><span class="s4">,</span>
                    <span class="s1">imgsz</span><span class="s4">=</span><span class="s1">imgsz</span><span class="s4">,</span>
                    <span class="s1">half</span><span class="s4">=</span><span class="s1">amp</span><span class="s4">,</span>
                    <span class="s1">model</span><span class="s4">=</span><span class="s1">ema</span><span class="s4">.</span><span class="s1">ema</span><span class="s4">,</span>
                    <span class="s1">single_cls</span><span class="s4">=</span><span class="s1">single_cls</span><span class="s4">,</span>
                    <span class="s1">dataloader</span><span class="s4">=</span><span class="s1">val_loader</span><span class="s4">,</span>
                    <span class="s1">save_dir</span><span class="s4">=</span><span class="s1">save_dir</span><span class="s4">,</span>
                    <span class="s1">plots</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s1">callbacks</span><span class="s4">=</span><span class="s1">callbacks</span><span class="s4">,</span>
                    <span class="s1">compute_loss</span><span class="s4">=</span><span class="s1">compute_loss</span><span class="s4">,</span>
                <span class="s4">)</span>

            <span class="s0"># Update best mAP</span>
            <span class="s1">fi </span><span class="s4">= </span><span class="s1">fitness</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">results</span><span class="s4">).</span><span class="s1">reshape</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">))  </span><span class="s0"># weighted combination of [P, R, mAP@.5, mAP@.5-.95]</span>
            <span class="s1">stop </span><span class="s4">= </span><span class="s1">stopper</span><span class="s4">(</span><span class="s1">epoch</span><span class="s4">=</span><span class="s1">epoch</span><span class="s4">, </span><span class="s1">fitness</span><span class="s4">=</span><span class="s1">fi</span><span class="s4">)  </span><span class="s0"># early stop check</span>
            <span class="s3">if </span><span class="s1">fi </span><span class="s4">&gt; </span><span class="s1">best_fitness</span><span class="s4">:</span>
                <span class="s1">best_fitness </span><span class="s4">= </span><span class="s1">fi</span>
            <span class="s1">log_vals </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">mloss</span><span class="s4">) + </span><span class="s1">list</span><span class="s4">(</span><span class="s1">results</span><span class="s4">) + </span><span class="s1">lr</span>
            <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_fit_epoch_end&quot;</span><span class="s4">, </span><span class="s1">log_vals</span><span class="s4">, </span><span class="s1">epoch</span><span class="s4">, </span><span class="s1">best_fitness</span><span class="s4">, </span><span class="s1">fi</span><span class="s4">)</span>

            <span class="s0"># Save model</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s3">not </span><span class="s1">nosave</span><span class="s4">) </span><span class="s3">or </span><span class="s4">(</span><span class="s1">final_epoch </span><span class="s3">and not </span><span class="s1">evolve</span><span class="s4">):  </span><span class="s0"># if save</span>
                <span class="s1">ckpt </span><span class="s4">= {</span>
                    <span class="s6">&quot;epoch&quot;</span><span class="s4">: </span><span class="s1">epoch</span><span class="s4">,</span>
                    <span class="s6">&quot;best_fitness&quot;</span><span class="s4">: </span><span class="s1">best_fitness</span><span class="s4">,</span>
                    <span class="s6">&quot;model&quot;</span><span class="s4">: </span><span class="s1">deepcopy</span><span class="s4">(</span><span class="s1">de_parallel</span><span class="s4">(</span><span class="s1">model</span><span class="s4">)).</span><span class="s1">half</span><span class="s4">(),</span>
                    <span class="s6">&quot;ema&quot;</span><span class="s4">: </span><span class="s1">deepcopy</span><span class="s4">(</span><span class="s1">ema</span><span class="s4">.</span><span class="s1">ema</span><span class="s4">).</span><span class="s1">half</span><span class="s4">(),</span>
                    <span class="s6">&quot;updates&quot;</span><span class="s4">: </span><span class="s1">ema</span><span class="s4">.</span><span class="s1">updates</span><span class="s4">,</span>
                    <span class="s6">&quot;optimizer&quot;</span><span class="s4">: </span><span class="s1">optimizer</span><span class="s4">.</span><span class="s1">state_dict</span><span class="s4">(),</span>
                    <span class="s6">&quot;opt&quot;</span><span class="s4">: </span><span class="s1">vars</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">),</span>
                    <span class="s6">&quot;git&quot;</span><span class="s4">: </span><span class="s1">GIT_INFO</span><span class="s4">,  </span><span class="s0"># {remote, branch, commit} if a git repo</span>
                    <span class="s6">&quot;date&quot;</span><span class="s4">: </span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">now</span><span class="s4">().</span><span class="s1">isoformat</span><span class="s4">(),</span>
                <span class="s4">}</span>

                <span class="s0"># Save last, best and delete</span>
                <span class="s1">torch</span><span class="s4">.</span><span class="s1">save</span><span class="s4">(</span><span class="s1">ckpt</span><span class="s4">, </span><span class="s1">last</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">best_fitness </span><span class="s4">== </span><span class="s1">fi</span><span class="s4">:</span>
                    <span class="s1">torch</span><span class="s4">.</span><span class="s1">save</span><span class="s4">(</span><span class="s1">ckpt</span><span class="s4">, </span><span class="s1">best</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">save_period </span><span class="s4">&gt; </span><span class="s5">0 </span><span class="s3">and </span><span class="s1">epoch </span><span class="s4">% </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">save_period </span><span class="s4">== </span><span class="s5">0</span><span class="s4">:</span>
                    <span class="s1">torch</span><span class="s4">.</span><span class="s1">save</span><span class="s4">(</span><span class="s1">ckpt</span><span class="s4">, </span><span class="s1">w </span><span class="s4">/ </span><span class="s6">f&quot;epoch</span><span class="s3">{</span><span class="s1">epoch</span><span class="s3">}</span><span class="s6">.pt&quot;</span><span class="s4">)</span>
                <span class="s3">del </span><span class="s1">ckpt</span>
                <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_model_save&quot;</span><span class="s4">, </span><span class="s1">last</span><span class="s4">, </span><span class="s1">epoch</span><span class="s4">, </span><span class="s1">final_epoch</span><span class="s4">, </span><span class="s1">best_fitness</span><span class="s4">, </span><span class="s1">fi</span><span class="s4">)</span>

        <span class="s0"># EarlyStopping</span>
        <span class="s3">if </span><span class="s1">RANK </span><span class="s4">!= -</span><span class="s5">1</span><span class="s4">:  </span><span class="s0"># if DDP training</span>
            <span class="s1">broadcast_list </span><span class="s4">= [</span><span class="s1">stop </span><span class="s3">if </span><span class="s1">RANK </span><span class="s4">== </span><span class="s5">0 </span><span class="s3">else None</span><span class="s4">]</span>
            <span class="s1">dist</span><span class="s4">.</span><span class="s1">broadcast_object_list</span><span class="s4">(</span><span class="s1">broadcast_list</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)  </span><span class="s0"># broadcast 'stop' to all ranks</span>
            <span class="s3">if </span><span class="s1">RANK </span><span class="s4">!= </span><span class="s5">0</span><span class="s4">:</span>
                <span class="s1">stop </span><span class="s4">= </span><span class="s1">broadcast_list</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
        <span class="s3">if </span><span class="s1">stop</span><span class="s4">:</span>
            <span class="s3">break  </span><span class="s0"># must break all DDP ranks</span>

        <span class="s0"># end epoch ----------------------------------------------------------------------------------------------------</span>
    <span class="s0"># end training -----------------------------------------------------------------------------------------------------</span>
    <span class="s3">if </span><span class="s1">RANK </span><span class="s3">in </span><span class="s4">{-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">}:</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">epoch </span><span class="s4">- </span><span class="s1">start_epoch </span><span class="s4">+ </span><span class="s5">1</span><span class="s3">} </span><span class="s6">epochs completed in </span><span class="s3">{</span><span class="s4">(</span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">() - </span><span class="s1">t0</span><span class="s4">) / </span><span class="s5">3600</span><span class="s3">:</span><span class="s6">.3f</span><span class="s3">} </span><span class="s6">hours.&quot;</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">last</span><span class="s4">, </span><span class="s1">best</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">f</span><span class="s4">.</span><span class="s1">exists</span><span class="s4">():</span>
                <span class="s1">strip_optimizer</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)  </span><span class="s0"># strip optimizers</span>
                <span class="s3">if </span><span class="s1">f </span><span class="s3">is </span><span class="s1">best</span><span class="s4">:</span>
                    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n</span><span class="s6">Validating </span><span class="s3">{</span><span class="s1">f</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
                    <span class="s1">results</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">validate</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span>
                        <span class="s1">data_dict</span><span class="s4">,</span>
                        <span class="s1">batch_size</span><span class="s4">=</span><span class="s1">batch_size </span><span class="s4">// </span><span class="s1">WORLD_SIZE </span><span class="s4">* </span><span class="s5">2</span><span class="s4">,</span>
                        <span class="s1">imgsz</span><span class="s4">=</span><span class="s1">imgsz</span><span class="s4">,</span>
                        <span class="s1">model</span><span class="s4">=</span><span class="s1">attempt_load</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">device</span><span class="s4">).</span><span class="s1">half</span><span class="s4">(),</span>
                        <span class="s1">iou_thres</span><span class="s4">=</span><span class="s5">0.65 </span><span class="s3">if </span><span class="s1">is_coco </span><span class="s3">else </span><span class="s5">0.60</span><span class="s4">,  </span><span class="s0"># best pycocotools at iou 0.65</span>
                        <span class="s1">single_cls</span><span class="s4">=</span><span class="s1">single_cls</span><span class="s4">,</span>
                        <span class="s1">dataloader</span><span class="s4">=</span><span class="s1">val_loader</span><span class="s4">,</span>
                        <span class="s1">save_dir</span><span class="s4">=</span><span class="s1">save_dir</span><span class="s4">,</span>
                        <span class="s1">save_json</span><span class="s4">=</span><span class="s1">is_coco</span><span class="s4">,</span>
                        <span class="s1">verbose</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                        <span class="s1">plots</span><span class="s4">=</span><span class="s1">plots</span><span class="s4">,</span>
                        <span class="s1">callbacks</span><span class="s4">=</span><span class="s1">callbacks</span><span class="s4">,</span>
                        <span class="s1">compute_loss</span><span class="s4">=</span><span class="s1">compute_loss</span><span class="s4">,</span>
                    <span class="s4">)  </span><span class="s0"># val best model with plots</span>
                    <span class="s3">if </span><span class="s1">is_coco</span><span class="s4">:</span>
                        <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_fit_epoch_end&quot;</span><span class="s4">, </span><span class="s1">list</span><span class="s4">(</span><span class="s1">mloss</span><span class="s4">) + </span><span class="s1">list</span><span class="s4">(</span><span class="s1">results</span><span class="s4">) + </span><span class="s1">lr</span><span class="s4">, </span><span class="s1">epoch</span><span class="s4">, </span><span class="s1">best_fitness</span><span class="s4">, </span><span class="s1">fi</span><span class="s4">)</span>

        <span class="s1">callbacks</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;on_train_end&quot;</span><span class="s4">, </span><span class="s1">last</span><span class="s4">, </span><span class="s1">best</span><span class="s4">, </span><span class="s1">epoch</span><span class="s4">, </span><span class="s1">results</span><span class="s4">)</span>

    <span class="s1">torch</span><span class="s4">.</span><span class="s1">cuda</span><span class="s4">.</span><span class="s1">empty_cache</span><span class="s4">()</span>
    <span class="s3">return </span><span class="s1">results</span>


<span class="s3">def </span><span class="s1">parse_opt</span><span class="s4">(</span><span class="s1">known</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
    <span class="s1">parser </span><span class="s4">= </span><span class="s1">argparse</span><span class="s4">.</span><span class="s1">ArgumentParser</span><span class="s4">()</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--weights&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;yolov5s.pt&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;initial weights path&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--cfg&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;model.yaml path&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--data&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;data/coco128.yaml&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;dataset.yaml path&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--hyp&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;data/hyps/hyp.scratch-low.yaml&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;hyperparameters path&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--epochs&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">100</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;total training epochs&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--batch-size&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">16</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;total batch size for all GPUs, -1 for autobatch&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--imgsz&quot;</span><span class="s4">, </span><span class="s6">&quot;--img&quot;</span><span class="s4">, </span><span class="s6">&quot;--img-size&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">640</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;train, val image size (pixels)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--rect&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;rectangular training&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--resume&quot;</span><span class="s4">, </span><span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;?&quot;</span><span class="s4">, </span><span class="s1">const</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;resume most recent training&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--nosave&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;only save final checkpoint&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--noval&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;only validate final epoch&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--noautoanchor&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;disable AutoAnchor&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--noplots&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save no plot files&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--evolve&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;?&quot;</span><span class="s4">, </span><span class="s1">const</span><span class="s4">=</span><span class="s5">300</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;evolve hyperparameters for x generations&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span>
        <span class="s6">&quot;--evolve_population&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;data/hyps&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;location for loading population&quot;</span>
    <span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--resume_evolve&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;resume evolve from last generation&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--bucket&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;gsutil bucket&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--cache&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;?&quot;</span><span class="s4">, </span><span class="s1">const</span><span class="s4">=</span><span class="s6">&quot;ram&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;image --cache ram/disk&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--image-weights&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;use weighted image selection for training&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--device&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;cuda device, i.e. 0 or 0,1,2,3 or cpu&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--multi-scale&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;vary img-size +/- 50%%&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--single-cls&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;train multi-class data as single-class&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--optimizer&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">choices</span><span class="s4">=[</span><span class="s6">&quot;SGD&quot;</span><span class="s4">, </span><span class="s6">&quot;Adam&quot;</span><span class="s4">, </span><span class="s6">&quot;AdamW&quot;</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;SGD&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;optimizer&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--sync-bn&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;use SyncBatchNorm, only available in DDP mode&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--workers&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">8</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;max dataloader workers (per RANK in DDP mode)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--project&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;runs/train&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save to project/name&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--name&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;exp&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;save to project/name&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--exist-ok&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;existing project/name ok, do not increment&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--quad&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;quad dataloader&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--cos-lr&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;cosine LR scheduler&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--label-smoothing&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">float</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">0.0</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;Label smoothing epsilon&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--patience&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">100</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;EarlyStopping patience (epochs without improvement)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--freeze&quot;</span><span class="s4">, </span><span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;+&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;Freeze layers: backbone=10, first3=0 1 2&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--save-period&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;Save checkpoint every x epochs (disabled if &lt; 1)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--seed&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;Global training seed&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--local_rank&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;Automatic DDP Multi-GPU argument, do not modify&quot;</span><span class="s4">)</span>

    <span class="s0"># Logger arguments</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--entity&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;Entity&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--upload_dataset&quot;</span><span class="s4">, </span><span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;?&quot;</span><span class="s4">, </span><span class="s1">const</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">'Upload data, &quot;val&quot; option'</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--bbox_interval&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;Set bounding-box image logging interval&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--artifact_alias&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;latest&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;Version of dataset artifact to use&quot;</span><span class="s4">)</span>

    <span class="s0"># NDJSON logging</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--ndjson-console&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;Log ndjson to console&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--ndjson-file&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;Log ndjson to file&quot;</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse_known_args</span><span class="s4">()[</span><span class="s5">0</span><span class="s4">] </span><span class="s3">if </span><span class="s1">known </span><span class="s3">else </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse_args</span><span class="s4">()</span>


<span class="s3">def </span><span class="s1">main</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">, </span><span class="s1">callbacks</span><span class="s4">=</span><span class="s1">Callbacks</span><span class="s4">()):</span>
    <span class="s0"># Checks</span>
    <span class="s3">if </span><span class="s1">RANK </span><span class="s3">in </span><span class="s4">{-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">}:</span>
        <span class="s1">print_args</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">))</span>
        <span class="s1">check_git_status</span><span class="s4">()</span>
        <span class="s1">check_requirements</span><span class="s4">(</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;requirements.txt&quot;</span><span class="s4">)</span>

    <span class="s0"># Resume (from specified or most recent last.pt)</span>
    <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">resume </span><span class="s3">and not </span><span class="s1">check_comet_resume</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">) </span><span class="s3">and not </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve</span><span class="s4">:</span>
        <span class="s1">last </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">check_file</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">resume</span><span class="s4">) </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">resume</span><span class="s4">, </span><span class="s1">str</span><span class="s4">) </span><span class="s3">else </span><span class="s1">get_latest_run</span><span class="s4">())</span>
        <span class="s1">opt_yaml </span><span class="s4">= </span><span class="s1">last</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">.</span><span class="s1">parent </span><span class="s4">/ </span><span class="s6">&quot;opt.yaml&quot;  </span><span class="s0"># train options yaml</span>
        <span class="s1">opt_data </span><span class="s4">= </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">data  </span><span class="s0"># original dataset</span>
        <span class="s3">if </span><span class="s1">opt_yaml</span><span class="s4">.</span><span class="s1">is_file</span><span class="s4">():</span>
            <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">opt_yaml</span><span class="s4">, </span><span class="s1">errors</span><span class="s4">=</span><span class="s6">&quot;ignore&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
                <span class="s1">d </span><span class="s4">= </span><span class="s1">yaml</span><span class="s4">.</span><span class="s1">safe_load</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">d </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">load</span><span class="s4">(</span><span class="s1">last</span><span class="s4">, </span><span class="s1">map_location</span><span class="s4">=</span><span class="s6">&quot;cpu&quot;</span><span class="s4">)[</span><span class="s6">&quot;opt&quot;</span><span class="s4">]</span>
        <span class="s1">opt </span><span class="s4">= </span><span class="s1">argparse</span><span class="s4">.</span><span class="s1">Namespace</span><span class="s4">(**</span><span class="s1">d</span><span class="s4">)  </span><span class="s0"># replace</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">cfg</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">resume </span><span class="s4">= </span><span class="s6">&quot;&quot;</span><span class="s4">, </span><span class="s1">str</span><span class="s4">(</span><span class="s1">last</span><span class="s4">), </span><span class="s3">True  </span><span class="s0"># reinstate</span>
        <span class="s3">if </span><span class="s1">is_url</span><span class="s4">(</span><span class="s1">opt_data</span><span class="s4">):</span>
            <span class="s1">opt</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= </span><span class="s1">check_file</span><span class="s4">(</span><span class="s1">opt_data</span><span class="s4">)  </span><span class="s0"># avoid HUB resume auth timeout</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">cfg</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">hyp</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">project </span><span class="s4">= (</span>
            <span class="s1">check_file</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">data</span><span class="s4">),</span>
            <span class="s1">check_yaml</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">cfg</span><span class="s4">),</span>
            <span class="s1">check_yaml</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">hyp</span><span class="s4">),</span>
            <span class="s1">str</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights</span><span class="s4">),</span>
            <span class="s1">str</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">project</span><span class="s4">),</span>
        <span class="s4">)  </span><span class="s0"># checks</span>
        <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">cfg</span><span class="s4">) </span><span class="s3">or </span><span class="s1">len</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights</span><span class="s4">), </span><span class="s6">&quot;either --cfg or --weights must be specified&quot;</span>
        <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">project </span><span class="s4">== </span><span class="s1">str</span><span class="s4">(</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;runs/train&quot;</span><span class="s4">):  </span><span class="s0"># if default project name, rename to runs/evolve</span>
                <span class="s1">opt</span><span class="s4">.</span><span class="s1">project </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;runs/evolve&quot;</span><span class="s4">)</span>
            <span class="s1">opt</span><span class="s4">.</span><span class="s1">exist_ok</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">resume </span><span class="s4">= </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">resume</span><span class="s4">, </span><span class="s3">False  </span><span class="s0"># pass resume to exist_ok and disable resume</span>
        <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;cfg&quot;</span><span class="s4">:</span>
            <span class="s1">opt</span><span class="s4">.</span><span class="s1">name </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">cfg</span><span class="s4">).</span><span class="s1">stem  </span><span class="s0"># use model.yaml as name</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">save_dir </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">increment_path</span><span class="s4">(</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">project</span><span class="s4">) / </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">exist_ok</span><span class="s4">=</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">exist_ok</span><span class="s4">))</span>

    <span class="s0"># DDP mode</span>
    <span class="s1">device </span><span class="s4">= </span><span class="s1">select_device</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">device</span><span class="s4">, </span><span class="s1">batch_size</span><span class="s4">=</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">batch_size</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">LOCAL_RANK </span><span class="s4">!= -</span><span class="s5">1</span><span class="s4">:</span>
        <span class="s1">msg </span><span class="s4">= </span><span class="s6">&quot;is not compatible with YOLOv5 Multi-GPU DDP training&quot;</span>
        <span class="s3">assert not </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">image_weights</span><span class="s4">, </span><span class="s6">f&quot;--image-weights </span><span class="s3">{</span><span class="s1">msg</span><span class="s3">}</span><span class="s6">&quot;</span>
        <span class="s3">assert not </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve</span><span class="s4">, </span><span class="s6">f&quot;--evolve </span><span class="s3">{</span><span class="s1">msg</span><span class="s3">}</span><span class="s6">&quot;</span>
        <span class="s3">assert </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">batch_size </span><span class="s4">!= -</span><span class="s5">1</span><span class="s4">, </span><span class="s6">f&quot;AutoBatch with --batch-size -1 </span><span class="s3">{</span><span class="s1">msg</span><span class="s3">}</span><span class="s6">, please pass a valid --batch-size&quot;</span>
        <span class="s3">assert </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">batch_size </span><span class="s4">% </span><span class="s1">WORLD_SIZE </span><span class="s4">== </span><span class="s5">0</span><span class="s4">, </span><span class="s6">f&quot;--batch-size </span><span class="s3">{</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">batch_size</span><span class="s3">} </span><span class="s6">must be multiple of WORLD_SIZE&quot;</span>
        <span class="s3">assert </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cuda</span><span class="s4">.</span><span class="s1">device_count</span><span class="s4">() &gt; </span><span class="s1">LOCAL_RANK</span><span class="s4">, </span><span class="s6">&quot;insufficient CUDA devices for DDP command&quot;</span>
        <span class="s1">torch</span><span class="s4">.</span><span class="s1">cuda</span><span class="s4">.</span><span class="s1">set_device</span><span class="s4">(</span><span class="s1">LOCAL_RANK</span><span class="s4">)</span>
        <span class="s1">device </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">device</span><span class="s4">(</span><span class="s6">&quot;cuda&quot;</span><span class="s4">, </span><span class="s1">LOCAL_RANK</span><span class="s4">)</span>
        <span class="s1">dist</span><span class="s4">.</span><span class="s1">init_process_group</span><span class="s4">(</span>
            <span class="s1">backend</span><span class="s4">=</span><span class="s6">&quot;nccl&quot; </span><span class="s3">if </span><span class="s1">dist</span><span class="s4">.</span><span class="s1">is_nccl_available</span><span class="s4">() </span><span class="s3">else </span><span class="s6">&quot;gloo&quot;</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">=</span><span class="s1">timedelta</span><span class="s4">(</span><span class="s1">seconds</span><span class="s4">=</span><span class="s5">10800</span><span class="s4">)</span>
        <span class="s4">)</span>

    <span class="s0"># Train</span>
    <span class="s3">if not </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve</span><span class="s4">:</span>
        <span class="s1">train</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">hyp</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">, </span><span class="s1">device</span><span class="s4">, </span><span class="s1">callbacks</span><span class="s4">)</span>

    <span class="s0"># Evolve hyperparameters (optional)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s0"># Hyperparameter evolution metadata (including this hyperparameter True-False, lower_limit, upper_limit)</span>
        <span class="s1">meta </span><span class="s4">= {</span>
            <span class="s6">&quot;lr0&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">1e-5</span><span class="s4">, </span><span class="s5">1e-1</span><span class="s4">),  </span><span class="s0"># initial learning rate (SGD=1E-2, Adam=1E-3)</span>
            <span class="s6">&quot;lrf&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.01</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">),  </span><span class="s0"># final OneCycleLR learning rate (lr0 * lrf)</span>
            <span class="s6">&quot;momentum&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.6</span><span class="s4">, </span><span class="s5">0.98</span><span class="s4">),  </span><span class="s0"># SGD momentum/Adam beta1</span>
            <span class="s6">&quot;weight_decay&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.001</span><span class="s4">),  </span><span class="s0"># optimizer weight decay</span>
            <span class="s6">&quot;warmup_epochs&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">5.0</span><span class="s4">),  </span><span class="s0"># warmup epochs (fractions ok)</span>
            <span class="s6">&quot;warmup_momentum&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.95</span><span class="s4">),  </span><span class="s0"># warmup initial momentum</span>
            <span class="s6">&quot;warmup_bias_lr&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.2</span><span class="s4">),  </span><span class="s0"># warmup initial bias lr</span>
            <span class="s6">&quot;box&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.02</span><span class="s4">, </span><span class="s5">0.2</span><span class="s4">),  </span><span class="s0"># box loss gain</span>
            <span class="s6">&quot;cls&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.2</span><span class="s4">, </span><span class="s5">4.0</span><span class="s4">),  </span><span class="s0"># cls loss gain</span>
            <span class="s6">&quot;cls_pw&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">2.0</span><span class="s4">),  </span><span class="s0"># cls BCELoss positive_weight</span>
            <span class="s6">&quot;obj&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.2</span><span class="s4">, </span><span class="s5">4.0</span><span class="s4">),  </span><span class="s0"># obj loss gain (scale with pixels)</span>
            <span class="s6">&quot;obj_pw&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">2.0</span><span class="s4">),  </span><span class="s0"># obj BCELoss positive_weight</span>
            <span class="s6">&quot;iou_t&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.1</span><span class="s4">, </span><span class="s5">0.7</span><span class="s4">),  </span><span class="s0"># IoU training threshold</span>
            <span class="s6">&quot;anchor_t&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">8.0</span><span class="s4">),  </span><span class="s0"># anchor-multiple threshold</span>
            <span class="s6">&quot;anchors&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">10.0</span><span class="s4">),  </span><span class="s0"># anchors per output grid (0 to ignore)</span>
            <span class="s6">&quot;fl_gamma&quot;</span><span class="s4">: (</span><span class="s3">False</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">2.0</span><span class="s4">),  </span><span class="s0"># focal loss gamma (efficientDet default gamma=1.5)</span>
            <span class="s6">&quot;hsv_h&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.1</span><span class="s4">),  </span><span class="s0"># image HSV-Hue augmentation (fraction)</span>
            <span class="s6">&quot;hsv_s&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.9</span><span class="s4">),  </span><span class="s0"># image HSV-Saturation augmentation (fraction)</span>
            <span class="s6">&quot;hsv_v&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.9</span><span class="s4">),  </span><span class="s0"># image HSV-Value augmentation (fraction)</span>
            <span class="s6">&quot;degrees&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">45.0</span><span class="s4">),  </span><span class="s0"># image rotation (+/- deg)</span>
            <span class="s6">&quot;translate&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.9</span><span class="s4">),  </span><span class="s0"># image translation (+/- fraction)</span>
            <span class="s6">&quot;scale&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.9</span><span class="s4">),  </span><span class="s0"># image scale (+/- gain)</span>
            <span class="s6">&quot;shear&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">10.0</span><span class="s4">),  </span><span class="s0"># image shear (+/- deg)</span>
            <span class="s6">&quot;perspective&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">0.001</span><span class="s4">),  </span><span class="s0"># image perspective (+/- fraction), range 0-0.001</span>
            <span class="s6">&quot;flipud&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">),  </span><span class="s0"># image flip up-down (probability)</span>
            <span class="s6">&quot;fliplr&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">),  </span><span class="s0"># image flip left-right (probability)</span>
            <span class="s6">&quot;mosaic&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">),  </span><span class="s0"># image mixup (probability)</span>
            <span class="s6">&quot;mixup&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">),  </span><span class="s0"># image mixup (probability)</span>
            <span class="s6">&quot;copy_paste&quot;</span><span class="s4">: (</span><span class="s3">True</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">),</span>
        <span class="s4">}  </span><span class="s0"># segment copy-paste (probability)</span>

        <span class="s0"># GA configs</span>
        <span class="s1">pop_size </span><span class="s4">= </span><span class="s5">50</span>
        <span class="s1">mutation_rate_min </span><span class="s4">= </span><span class="s5">0.01</span>
        <span class="s1">mutation_rate_max </span><span class="s4">= </span><span class="s5">0.5</span>
        <span class="s1">crossover_rate_min </span><span class="s4">= </span><span class="s5">0.5</span>
        <span class="s1">crossover_rate_max </span><span class="s4">= </span><span class="s5">1</span>
        <span class="s1">min_elite_size </span><span class="s4">= </span><span class="s5">2</span>
        <span class="s1">max_elite_size </span><span class="s4">= </span><span class="s5">5</span>
        <span class="s1">tournament_size_min </span><span class="s4">= </span><span class="s5">2</span>
        <span class="s1">tournament_size_max </span><span class="s4">= </span><span class="s5">10</span>

        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">hyp</span><span class="s4">, </span><span class="s1">errors</span><span class="s4">=</span><span class="s6">&quot;ignore&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">hyp </span><span class="s4">= </span><span class="s1">yaml</span><span class="s4">.</span><span class="s1">safe_load</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)  </span><span class="s0"># load hyps dict</span>
            <span class="s3">if </span><span class="s6">&quot;anchors&quot; </span><span class="s3">not in </span><span class="s1">hyp</span><span class="s4">:  </span><span class="s0"># anchors commented in hyp.yaml</span>
                <span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;anchors&quot;</span><span class="s4">] = </span><span class="s5">3</span>
        <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">noautoanchor</span><span class="s4">:</span>
            <span class="s3">del </span><span class="s1">hyp</span><span class="s4">[</span><span class="s6">&quot;anchors&quot;</span><span class="s4">], </span><span class="s1">meta</span><span class="s4">[</span><span class="s6">&quot;anchors&quot;</span><span class="s4">]</span>
        <span class="s1">opt</span><span class="s4">.</span><span class="s1">noval</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">nosave</span><span class="s4">, </span><span class="s1">save_dir </span><span class="s4">= </span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">save_dir</span><span class="s4">)  </span><span class="s0"># only val/save final epoch</span>
        <span class="s0"># ei = [isinstance(x, (int, float)) for x in hyp.values()]  # evolvable indices</span>
        <span class="s1">evolve_yaml</span><span class="s4">, </span><span class="s1">evolve_csv </span><span class="s4">= </span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;hyp_evolve.yaml&quot;</span><span class="s4">, </span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;evolve.csv&quot;</span>
        <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">bucket</span><span class="s4">:</span>
            <span class="s0"># download evolve.csv if exists</span>
            <span class="s1">subprocess</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span>
                <span class="s4">[</span>
                    <span class="s6">&quot;gsutil&quot;</span><span class="s4">,</span>
                    <span class="s6">&quot;cp&quot;</span><span class="s4">,</span>
                    <span class="s6">f&quot;gs://</span><span class="s3">{</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">bucket</span><span class="s3">}</span><span class="s6">/evolve.csv&quot;</span><span class="s4">,</span>
                    <span class="s1">str</span><span class="s4">(</span><span class="s1">evolve_csv</span><span class="s4">),</span>
                <span class="s4">]</span>
            <span class="s4">)</span>

        <span class="s0"># Delete the items in meta dictionary whose first value is False</span>
        <span class="s1">del_ </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">():</span>
            <span class="s3">if </span><span class="s1">meta</span><span class="s4">[</span><span class="s1">item</span><span class="s4">][</span><span class="s5">0</span><span class="s4">] </span><span class="s3">is False</span><span class="s4">:</span>
                <span class="s1">del_</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">item</span><span class="s4">)</span>
        <span class="s1">hyp_GA </span><span class="s4">= </span><span class="s1">hyp</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()  </span><span class="s0"># Make a copy of hyp dictionary</span>
        <span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">del_</span><span class="s4">:</span>
            <span class="s3">del </span><span class="s1">meta</span><span class="s4">[</span><span class="s1">item</span><span class="s4">]  </span><span class="s0"># Remove the item from meta dictionary</span>
            <span class="s3">del </span><span class="s1">hyp_GA</span><span class="s4">[</span><span class="s1">item</span><span class="s4">]  </span><span class="s0"># Remove the item from hyp_GA dictionary</span>

        <span class="s0"># Set lower_limit and upper_limit arrays to hold the search space boundaries</span>
        <span class="s1">lower_limit </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">meta</span><span class="s4">[</span><span class="s1">k</span><span class="s4">][</span><span class="s5">1</span><span class="s4">] </span><span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">hyp_GA</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">()])</span>
        <span class="s1">upper_limit </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">meta</span><span class="s4">[</span><span class="s1">k</span><span class="s4">][</span><span class="s5">2</span><span class="s4">] </span><span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">hyp_GA</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">()])</span>

        <span class="s0"># Create gene_ranges list to hold the range of values for each gene in the population</span>
        <span class="s1">gene_ranges </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">upper_limit</span><span class="s4">)):</span>
            <span class="s1">gene_ranges</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s1">lower_limit</span><span class="s4">[</span><span class="s1">i</span><span class="s4">], </span><span class="s1">upper_limit</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]))</span>

        <span class="s0"># Initialize the population with initial_values or random values</span>
        <span class="s1">initial_values </span><span class="s4">= []</span>

        <span class="s0"># If resuming evolution from a previous checkpoint</span>
        <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">resume_evolve </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">isfile</span><span class="s4">(</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">resume_evolve</span><span class="s4">), </span><span class="s6">&quot;evolve population path is wrong!&quot;</span>
            <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">resume_evolve</span><span class="s4">, </span><span class="s1">errors</span><span class="s4">=</span><span class="s6">&quot;ignore&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
                <span class="s1">evolve_population </span><span class="s4">= </span><span class="s1">yaml</span><span class="s4">.</span><span class="s1">safe_load</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
                <span class="s3">for </span><span class="s1">value </span><span class="s3">in </span><span class="s1">evolve_population</span><span class="s4">.</span><span class="s1">values</span><span class="s4">():</span>
                    <span class="s1">value </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">value</span><span class="s4">[</span><span class="s1">k</span><span class="s4">] </span><span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">hyp_GA</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">()])</span>
                    <span class="s1">initial_values</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">value</span><span class="s4">))</span>

        <span class="s0"># If not resuming from a previous checkpoint, generate initial values from .yaml files in opt.evolve_population</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">yaml_files </span><span class="s4">= [</span><span class="s1">f </span><span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">os</span><span class="s4">.</span><span class="s1">listdir</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve_population</span><span class="s4">) </span><span class="s3">if </span><span class="s1">f</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span><span class="s6">&quot;.yaml&quot;</span><span class="s4">)]</span>
            <span class="s3">for </span><span class="s1">file_name </span><span class="s3">in </span><span class="s1">yaml_files</span><span class="s4">:</span>
                <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve_population</span><span class="s4">, </span><span class="s1">file_name</span><span class="s4">)) </span><span class="s3">as </span><span class="s1">yaml_file</span><span class="s4">:</span>
                    <span class="s1">value </span><span class="s4">= </span><span class="s1">yaml</span><span class="s4">.</span><span class="s1">safe_load</span><span class="s4">(</span><span class="s1">yaml_file</span><span class="s4">)</span>
                    <span class="s1">value </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">value</span><span class="s4">[</span><span class="s1">k</span><span class="s4">] </span><span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">hyp_GA</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">()])</span>
                    <span class="s1">initial_values</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">value</span><span class="s4">))</span>

        <span class="s0"># Generate random values within the search space for the rest of the population</span>
        <span class="s3">if </span><span class="s1">initial_values </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">population </span><span class="s4">= [</span><span class="s1">generate_individual</span><span class="s4">(</span><span class="s1">gene_ranges</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">hyp_GA</span><span class="s4">)) </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">pop_size</span><span class="s4">)]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">pop_size </span><span class="s4">&gt; </span><span class="s5">1</span><span class="s4">:</span>
                <span class="s1">population </span><span class="s4">= [</span>
                    <span class="s1">generate_individual</span><span class="s4">(</span><span class="s1">gene_ranges</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">hyp_GA</span><span class="s4">)) </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">pop_size </span><span class="s4">- </span><span class="s1">len</span><span class="s4">(</span><span class="s1">initial_values</span><span class="s4">))</span>
                <span class="s4">]</span>
                <span class="s3">for </span><span class="s1">initial_value </span><span class="s3">in </span><span class="s1">initial_values</span><span class="s4">:</span>
                    <span class="s1">population </span><span class="s4">= [</span><span class="s1">initial_value</span><span class="s4">] + </span><span class="s1">population</span>

        <span class="s0"># Run the genetic algorithm for a fixed number of generations</span>
        <span class="s1">list_keys </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">hyp_GA</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">())</span>
        <span class="s3">for </span><span class="s1">generation </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">generation </span><span class="s4">&gt;= </span><span class="s5">1</span><span class="s4">:</span>
                <span class="s1">save_dict </span><span class="s4">= {}</span>
                <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">population</span><span class="s4">)):</span>
                    <span class="s1">little_dict </span><span class="s4">= {}</span>
                    <span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">population</span><span class="s4">[</span><span class="s1">i</span><span class="s4">])):</span>
                        <span class="s1">little_dict</span><span class="s4">[</span><span class="s1">list_keys</span><span class="s4">[</span><span class="s1">j</span><span class="s4">]] = </span><span class="s1">float</span><span class="s4">(</span><span class="s1">population</span><span class="s4">[</span><span class="s1">i</span><span class="s4">][</span><span class="s1">j</span><span class="s4">])</span>
                    <span class="s1">save_dict</span><span class="s4">[</span><span class="s6">&quot;gen&quot; </span><span class="s4">+ </span><span class="s1">str</span><span class="s4">(</span><span class="s1">generation</span><span class="s4">) + </span><span class="s6">&quot;number&quot; </span><span class="s4">+ </span><span class="s1">str</span><span class="s4">(</span><span class="s1">i</span><span class="s4">)] = </span><span class="s1">little_dict</span>

                <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">save_dir </span><span class="s4">/ </span><span class="s6">&quot;evolve_population.yaml&quot;</span><span class="s4">, </span><span class="s6">&quot;w&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">outfile</span><span class="s4">:</span>
                    <span class="s1">yaml</span><span class="s4">.</span><span class="s1">dump</span><span class="s4">(</span><span class="s1">save_dict</span><span class="s4">, </span><span class="s1">outfile</span><span class="s4">, </span><span class="s1">default_flow_style</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

            <span class="s0"># Adaptive elite size</span>
            <span class="s1">elite_size </span><span class="s4">= </span><span class="s1">min_elite_size </span><span class="s4">+ </span><span class="s1">int</span><span class="s4">((</span><span class="s1">max_elite_size </span><span class="s4">- </span><span class="s1">min_elite_size</span><span class="s4">) * (</span><span class="s1">generation </span><span class="s4">/ </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve</span><span class="s4">))</span>
            <span class="s0"># Evaluate the fitness of each individual in the population</span>
            <span class="s1">fitness_scores </span><span class="s4">= []</span>
            <span class="s3">for </span><span class="s1">individual </span><span class="s3">in </span><span class="s1">population</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">hyp_GA</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">(), </span><span class="s1">individual</span><span class="s4">):</span>
                    <span class="s1">hyp_GA</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">value</span>
                <span class="s1">hyp</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">hyp_GA</span><span class="s4">)</span>
                <span class="s1">results </span><span class="s4">= </span><span class="s1">train</span><span class="s4">(</span><span class="s1">hyp</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(), </span><span class="s1">opt</span><span class="s4">, </span><span class="s1">device</span><span class="s4">, </span><span class="s1">callbacks</span><span class="s4">)</span>
                <span class="s1">callbacks </span><span class="s4">= </span><span class="s1">Callbacks</span><span class="s4">()</span>
                <span class="s0"># Write mutation results</span>
                <span class="s1">keys </span><span class="s4">= (</span>
                    <span class="s6">&quot;metrics/precision&quot;</span><span class="s4">,</span>
                    <span class="s6">&quot;metrics/recall&quot;</span><span class="s4">,</span>
                    <span class="s6">&quot;metrics/mAP_0.5&quot;</span><span class="s4">,</span>
                    <span class="s6">&quot;metrics/mAP_0.5:0.95&quot;</span><span class="s4">,</span>
                    <span class="s6">&quot;val/box_loss&quot;</span><span class="s4">,</span>
                    <span class="s6">&quot;val/obj_loss&quot;</span><span class="s4">,</span>
                    <span class="s6">&quot;val/cls_loss&quot;</span><span class="s4">,</span>
                <span class="s4">)</span>
                <span class="s1">print_mutation</span><span class="s4">(</span><span class="s1">keys</span><span class="s4">, </span><span class="s1">results</span><span class="s4">, </span><span class="s1">hyp</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(), </span><span class="s1">save_dir</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">bucket</span><span class="s4">)</span>
                <span class="s1">fitness_scores</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">results</span><span class="s4">[</span><span class="s5">2</span><span class="s4">])</span>

            <span class="s0"># Select the fittest individuals for reproduction using adaptive tournament selection</span>
            <span class="s1">selected_indices </span><span class="s4">= []</span>
            <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">pop_size </span><span class="s4">- </span><span class="s1">elite_size</span><span class="s4">):</span>
                <span class="s0"># Adaptive tournament size</span>
                <span class="s1">tournament_size </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span>
                    <span class="s1">max</span><span class="s4">(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">tournament_size_min</span><span class="s4">),</span>
                    <span class="s1">int</span><span class="s4">(</span><span class="s1">min</span><span class="s4">(</span><span class="s1">tournament_size_max</span><span class="s4">, </span><span class="s1">pop_size</span><span class="s4">) - (</span><span class="s1">generation </span><span class="s4">/ (</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve </span><span class="s4">/ </span><span class="s5">10</span><span class="s4">))),</span>
                <span class="s4">)</span>
                <span class="s0"># Perform tournament selection to choose the best individual</span>
                <span class="s1">tournament_indices </span><span class="s4">= </span><span class="s1">random</span><span class="s4">.</span><span class="s1">sample</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s1">pop_size</span><span class="s4">), </span><span class="s1">tournament_size</span><span class="s4">)</span>
                <span class="s1">tournament_fitness </span><span class="s4">= [</span><span class="s1">fitness_scores</span><span class="s4">[</span><span class="s1">j</span><span class="s4">] </span><span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">tournament_indices</span><span class="s4">]</span>
                <span class="s1">winner_index </span><span class="s4">= </span><span class="s1">tournament_indices</span><span class="s4">[</span><span class="s1">tournament_fitness</span><span class="s4">.</span><span class="s1">index</span><span class="s4">(</span><span class="s1">max</span><span class="s4">(</span><span class="s1">tournament_fitness</span><span class="s4">))]</span>
                <span class="s1">selected_indices</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">winner_index</span><span class="s4">)</span>

            <span class="s0"># Add the elite individuals to the selected indices</span>
            <span class="s1">elite_indices </span><span class="s4">= [</span><span class="s1">i </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">pop_size</span><span class="s4">) </span><span class="s3">if </span><span class="s1">fitness_scores</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">fitness_scores</span><span class="s4">)[-</span><span class="s1">elite_size</span><span class="s4">:]]</span>
            <span class="s1">selected_indices</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">elite_indices</span><span class="s4">)</span>
            <span class="s0"># Create the next generation through crossover and mutation</span>
            <span class="s1">next_generation </span><span class="s4">= []</span>
            <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">pop_size</span><span class="s4">):</span>
                <span class="s1">parent1_index </span><span class="s4">= </span><span class="s1">selected_indices</span><span class="s4">[</span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">pop_size </span><span class="s4">- </span><span class="s5">1</span><span class="s4">)]</span>
                <span class="s1">parent2_index </span><span class="s4">= </span><span class="s1">selected_indices</span><span class="s4">[</span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">pop_size </span><span class="s4">- </span><span class="s5">1</span><span class="s4">)]</span>
                <span class="s0"># Adaptive crossover rate</span>
                <span class="s1">crossover_rate </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span>
                    <span class="s1">crossover_rate_min</span><span class="s4">, </span><span class="s1">min</span><span class="s4">(</span><span class="s1">crossover_rate_max</span><span class="s4">, </span><span class="s1">crossover_rate_max </span><span class="s4">- (</span><span class="s1">generation </span><span class="s4">/ </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve</span><span class="s4">))</span>
                <span class="s4">)</span>
                <span class="s3">if </span><span class="s1">random</span><span class="s4">.</span><span class="s1">uniform</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">) &lt; </span><span class="s1">crossover_rate</span><span class="s4">:</span>
                    <span class="s1">crossover_point </span><span class="s4">= </span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">hyp_GA</span><span class="s4">) - </span><span class="s5">1</span><span class="s4">)</span>
                    <span class="s1">child </span><span class="s4">= </span><span class="s1">population</span><span class="s4">[</span><span class="s1">parent1_index</span><span class="s4">][:</span><span class="s1">crossover_point</span><span class="s4">] + </span><span class="s1">population</span><span class="s4">[</span><span class="s1">parent2_index</span><span class="s4">][</span><span class="s1">crossover_point</span><span class="s4">:]</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">child </span><span class="s4">= </span><span class="s1">population</span><span class="s4">[</span><span class="s1">parent1_index</span><span class="s4">]</span>
                <span class="s0"># Adaptive mutation rate</span>
                <span class="s1">mutation_rate </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span>
                    <span class="s1">mutation_rate_min</span><span class="s4">, </span><span class="s1">min</span><span class="s4">(</span><span class="s1">mutation_rate_max</span><span class="s4">, </span><span class="s1">mutation_rate_max </span><span class="s4">- (</span><span class="s1">generation </span><span class="s4">/ </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve</span><span class="s4">))</span>
                <span class="s4">)</span>
                <span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">hyp_GA</span><span class="s4">)):</span>
                    <span class="s3">if </span><span class="s1">random</span><span class="s4">.</span><span class="s1">uniform</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">) &lt; </span><span class="s1">mutation_rate</span><span class="s4">:</span>
                        <span class="s1">child</span><span class="s4">[</span><span class="s1">j</span><span class="s4">] += </span><span class="s1">random</span><span class="s4">.</span><span class="s1">uniform</span><span class="s4">(-</span><span class="s5">0.1</span><span class="s4">, </span><span class="s5">0.1</span><span class="s4">)</span>
                        <span class="s1">child</span><span class="s4">[</span><span class="s1">j</span><span class="s4">] = </span><span class="s1">min</span><span class="s4">(</span><span class="s1">max</span><span class="s4">(</span><span class="s1">child</span><span class="s4">[</span><span class="s1">j</span><span class="s4">], </span><span class="s1">gene_ranges</span><span class="s4">[</span><span class="s1">j</span><span class="s4">][</span><span class="s5">0</span><span class="s4">]), </span><span class="s1">gene_ranges</span><span class="s4">[</span><span class="s1">j</span><span class="s4">][</span><span class="s5">1</span><span class="s4">])</span>
                <span class="s1">next_generation</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">child</span><span class="s4">)</span>
            <span class="s0"># Replace the old population with the new generation</span>
            <span class="s1">population </span><span class="s4">= </span><span class="s1">next_generation</span>
        <span class="s0"># Print the best solution found</span>
        <span class="s1">best_index </span><span class="s4">= </span><span class="s1">fitness_scores</span><span class="s4">.</span><span class="s1">index</span><span class="s4">(</span><span class="s1">max</span><span class="s4">(</span><span class="s1">fitness_scores</span><span class="s4">))</span>
        <span class="s1">best_individual </span><span class="s4">= </span><span class="s1">population</span><span class="s4">[</span><span class="s1">best_index</span><span class="s4">]</span>
        <span class="s1">print</span><span class="s4">(</span><span class="s6">&quot;Best solution found:&quot;</span><span class="s4">, </span><span class="s1">best_individual</span><span class="s4">)</span>
        <span class="s0"># Plot results</span>
        <span class="s1">plot_evolve</span><span class="s4">(</span><span class="s1">evolve_csv</span><span class="s4">)</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span>
            <span class="s6">f'Hyperparameter evolution finished </span><span class="s3">{</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">evolve</span><span class="s3">} </span><span class="s6">generations</span><span class="s3">\n</span><span class="s6">'</span>
            <span class="s6">f&quot;Results saved to </span><span class="s3">{</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">'bold'</span><span class="s4">, </span><span class="s1">save_dir</span><span class="s4">)</span><span class="s3">}\n</span><span class="s6">&quot;</span>
            <span class="s6">f'Usage example: $ python train.py --hyp </span><span class="s3">{</span><span class="s1">evolve_yaml</span><span class="s3">}</span><span class="s6">'</span>
        <span class="s4">)</span>


<span class="s3">def </span><span class="s1">generate_individual</span><span class="s4">(</span><span class="s1">input_ranges</span><span class="s4">, </span><span class="s1">individual_length</span><span class="s4">):</span>
    <span class="s1">individual </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">individual_length</span><span class="s4">):</span>
        <span class="s1">lower_bound</span><span class="s4">, </span><span class="s1">upper_bound </span><span class="s4">= </span><span class="s1">input_ranges</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
        <span class="s1">individual</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">random</span><span class="s4">.</span><span class="s1">uniform</span><span class="s4">(</span><span class="s1">lower_bound</span><span class="s4">, </span><span class="s1">upper_bound</span><span class="s4">))</span>
    <span class="s3">return </span><span class="s1">individual</span>


<span class="s3">def </span><span class="s1">run</span><span class="s4">(**</span><span class="s1">kwargs</span><span class="s4">):</span>
    <span class="s0"># Usage: import train; train.run(data='coco128.yaml', imgsz=320, weights='yolov5m.pt')</span>
    <span class="s1">opt </span><span class="s4">= </span><span class="s1">parse_opt</span><span class="s4">(</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
        <span class="s1">setattr</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">, </span><span class="s1">k</span><span class="s4">, </span><span class="s1">v</span><span class="s4">)</span>
    <span class="s1">main</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">opt</span>


<span class="s3">if </span><span class="s1">__name__ </span><span class="s4">== </span><span class="s6">&quot;__main__&quot;</span><span class="s4">:</span>
    <span class="s1">opt </span><span class="s4">= </span><span class="s1">parse_opt</span><span class="s4">()</span>
    <span class="s1">main</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">)</span>
</pre>
</body>
</html>