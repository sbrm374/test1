<html>
<head>
<title>export.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
export.py</font>
</center></td></tr></table>
<pre><span class="s0"># YOLOv5 üöÄ by Ultralytics, AGPL-3.0 license</span>
<span class="s2">&quot;&quot;&quot; 
Export a YOLOv5 PyTorch model to other formats. TensorFlow exports authored by https://github.com/zldrobit 
 
Format                      | `export.py --include`         | Model 
---                         | ---                           | --- 
PyTorch                     | -                             | yolov5s.pt 
TorchScript                 | `torchscript`                 | yolov5s.torchscript 
ONNX                        | `onnx`                        | yolov5s.onnx 
OpenVINO                    | `openvino`                    | yolov5s_openvino_model/ 
TensorRT                    | `engine`                      | yolov5s.engine 
CoreML                      | `coreml`                      | yolov5s.mlmodel 
TensorFlow SavedModel       | `saved_model`                 | yolov5s_saved_model/ 
TensorFlow GraphDef         | `pb`                          | yolov5s.pb 
TensorFlow Lite             | `tflite`                      | yolov5s.tflite 
TensorFlow Edge TPU         | `edgetpu`                     | yolov5s_edgetpu.tflite 
TensorFlow.js               | `tfjs`                        | yolov5s_web_model/ 
PaddlePaddle                | `paddle`                      | yolov5s_paddle_model/ 
 
Requirements: 
    $ pip install -r requirements.txt coremltools onnx onnx-simplifier onnxruntime openvino-dev tensorflow-cpu  # CPU 
    $ pip install -r requirements.txt coremltools onnx onnx-simplifier onnxruntime-gpu openvino-dev tensorflow  # GPU 
 
Usage: 
    $ python export.py --weights yolov5s.pt --include torchscript onnx openvino engine coreml tflite ... 
 
Inference: 
    $ python detect.py --weights yolov5s.pt                 # PyTorch 
                                 yolov5s.torchscript        # TorchScript 
                                 yolov5s.onnx               # ONNX Runtime or OpenCV DNN with --dnn 
                                 yolov5s_openvino_model     # OpenVINO 
                                 yolov5s.engine             # TensorRT 
                                 yolov5s.mlmodel            # CoreML (macOS-only) 
                                 yolov5s_saved_model        # TensorFlow SavedModel 
                                 yolov5s.pb                 # TensorFlow GraphDef 
                                 yolov5s.tflite             # TensorFlow Lite 
                                 yolov5s_edgetpu.tflite     # TensorFlow Edge TPU 
                                 yolov5s_paddle_model       # PaddlePaddle 
 
TensorFlow.js: 
    $ cd .. &amp;&amp; git clone https://github.com/zldrobit/tfjs-yolov5-example.git &amp;&amp; cd tfjs-yolov5-example 
    $ npm install 
    $ ln -s ../../yolov5/yolov5s_web_model public/yolov5s_web_model 
    $ npm start 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">argparse</span>
<span class="s3">import </span><span class="s1">contextlib</span>
<span class="s3">import </span><span class="s1">json</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">platform</span>
<span class="s3">import </span><span class="s1">re</span>
<span class="s3">import </span><span class="s1">subprocess</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">import </span><span class="s1">time</span>
<span class="s3">import </span><span class="s1">warnings</span>
<span class="s3">from </span><span class="s1">pathlib </span><span class="s3">import </span><span class="s1">Path</span>

<span class="s3">import </span><span class="s1">pandas </span><span class="s3">as </span><span class="s1">pd</span>
<span class="s3">import </span><span class="s1">torch</span>
<span class="s3">from </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">mobile_optimizer </span><span class="s3">import </span><span class="s1">optimize_for_mobile</span>

<span class="s1">FILE </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">__file__</span><span class="s4">).</span><span class="s1">resolve</span><span class="s4">()</span>
<span class="s1">ROOT </span><span class="s4">= </span><span class="s1">FILE</span><span class="s4">.</span><span class="s1">parents</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]  </span><span class="s0"># YOLOv5 root directory</span>
<span class="s3">if </span><span class="s1">str</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">) </span><span class="s3">not in </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">path</span><span class="s4">:</span>
    <span class="s1">sys</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">))  </span><span class="s0"># add ROOT to PATH</span>
<span class="s3">if </span><span class="s1">platform</span><span class="s4">.</span><span class="s1">system</span><span class="s4">() != </span><span class="s6">&quot;Windows&quot;</span><span class="s4">:</span>
    <span class="s1">ROOT </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">relpath</span><span class="s4">(</span><span class="s1">ROOT</span><span class="s4">, </span><span class="s1">Path</span><span class="s4">.</span><span class="s1">cwd</span><span class="s4">()))  </span><span class="s0"># relative</span>

<span class="s3">from </span><span class="s1">models</span><span class="s4">.</span><span class="s1">experimental </span><span class="s3">import </span><span class="s1">attempt_load</span>
<span class="s3">from </span><span class="s1">models</span><span class="s4">.</span><span class="s1">yolo </span><span class="s3">import </span><span class="s1">ClassificationModel</span><span class="s4">, </span><span class="s1">Detect</span><span class="s4">, </span><span class="s1">DetectionModel</span><span class="s4">, </span><span class="s1">SegmentationModel</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">dataloaders </span><span class="s3">import </span><span class="s1">LoadImages</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">general </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">LOGGER</span><span class="s4">,</span>
    <span class="s1">Profile</span><span class="s4">,</span>
    <span class="s1">check_dataset</span><span class="s4">,</span>
    <span class="s1">check_img_size</span><span class="s4">,</span>
    <span class="s1">check_requirements</span><span class="s4">,</span>
    <span class="s1">check_version</span><span class="s4">,</span>
    <span class="s1">check_yaml</span><span class="s4">,</span>
    <span class="s1">colorstr</span><span class="s4">,</span>
    <span class="s1">file_size</span><span class="s4">,</span>
    <span class="s1">get_default_args</span><span class="s4">,</span>
    <span class="s1">print_args</span><span class="s4">,</span>
    <span class="s1">url2file</span><span class="s4">,</span>
    <span class="s1">yaml_save</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">torch_utils </span><span class="s3">import </span><span class="s1">select_device</span><span class="s4">, </span><span class="s1">smart_inference_mode</span>

<span class="s1">MACOS </span><span class="s4">= </span><span class="s1">platform</span><span class="s4">.</span><span class="s1">system</span><span class="s4">() == </span><span class="s6">&quot;Darwin&quot;  </span><span class="s0"># macOS environment</span>


<span class="s3">class </span><span class="s1">iOSModel</span><span class="s4">(</span><span class="s1">torch</span><span class="s4">.</span><span class="s1">nn</span><span class="s4">.</span><span class="s1">Module</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">()</span>
        <span class="s1">b</span><span class="s4">, </span><span class="s1">c</span><span class="s4">, </span><span class="s1">h</span><span class="s4">, </span><span class="s1">w </span><span class="s4">= </span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape  </span><span class="s0"># batch, channel, height, width</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">model </span><span class="s4">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">nc </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">nc  </span><span class="s0"># number of classes</span>
        <span class="s3">if </span><span class="s1">w </span><span class="s4">== </span><span class="s1">h</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">normalize </span><span class="s4">= </span><span class="s5">1.0 </span><span class="s4">/ </span><span class="s1">w</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">normalize </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">tensor</span><span class="s4">([</span><span class="s5">1.0 </span><span class="s4">/ </span><span class="s1">w</span><span class="s4">, </span><span class="s5">1.0 </span><span class="s4">/ </span><span class="s1">h</span><span class="s4">, </span><span class="s5">1.0 </span><span class="s4">/ </span><span class="s1">w</span><span class="s4">, </span><span class="s5">1.0 </span><span class="s4">/ </span><span class="s1">h</span><span class="s4">])  </span><span class="s0"># broadcast (slower, smaller)</span>
            <span class="s0"># np = model(im)[0].shape[1]  # number of points</span>
            <span class="s0"># self.normalize = torch.tensor([1. / w, 1. / h, 1. / w, 1. / h]).expand(np, 4)  # explicit (faster, larger)</span>

    <span class="s3">def </span><span class="s1">forward</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">x</span><span class="s4">):</span>
        <span class="s1">xywh</span><span class="s4">, </span><span class="s1">conf</span><span class="s4">, </span><span class="s1">cls </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">model</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">squeeze</span><span class="s4">().</span><span class="s1">split</span><span class="s4">((</span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nc</span><span class="s4">), </span><span class="s5">1</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">cls </span><span class="s4">* </span><span class="s1">conf</span><span class="s4">, </span><span class="s1">xywh </span><span class="s4">* </span><span class="s1">self</span><span class="s4">.</span><span class="s1">normalize  </span><span class="s0"># confidence (3780, 80), coordinates (3780, 4)</span>


<span class="s3">def </span><span class="s1">export_formats</span><span class="s4">():</span>
    <span class="s0"># YOLOv5 export formats</span>
    <span class="s1">x </span><span class="s4">= [</span>
        <span class="s4">[</span><span class="s6">&quot;PyTorch&quot;</span><span class="s4">, </span><span class="s6">&quot;-&quot;</span><span class="s4">, </span><span class="s6">&quot;.pt&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;TorchScript&quot;</span><span class="s4">, </span><span class="s6">&quot;torchscript&quot;</span><span class="s4">, </span><span class="s6">&quot;.torchscript&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;ONNX&quot;</span><span class="s4">, </span><span class="s6">&quot;onnx&quot;</span><span class="s4">, </span><span class="s6">&quot;.onnx&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;OpenVINO&quot;</span><span class="s4">, </span><span class="s6">&quot;openvino&quot;</span><span class="s4">, </span><span class="s6">&quot;_openvino_model&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;TensorRT&quot;</span><span class="s4">, </span><span class="s6">&quot;engine&quot;</span><span class="s4">, </span><span class="s6">&quot;.engine&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;CoreML&quot;</span><span class="s4">, </span><span class="s6">&quot;coreml&quot;</span><span class="s4">, </span><span class="s6">&quot;.mlmodel&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;TensorFlow SavedModel&quot;</span><span class="s4">, </span><span class="s6">&quot;saved_model&quot;</span><span class="s4">, </span><span class="s6">&quot;_saved_model&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;TensorFlow GraphDef&quot;</span><span class="s4">, </span><span class="s6">&quot;pb&quot;</span><span class="s4">, </span><span class="s6">&quot;.pb&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;TensorFlow Lite&quot;</span><span class="s4">, </span><span class="s6">&quot;tflite&quot;</span><span class="s4">, </span><span class="s6">&quot;.tflite&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;TensorFlow Edge TPU&quot;</span><span class="s4">, </span><span class="s6">&quot;edgetpu&quot;</span><span class="s4">, </span><span class="s6">&quot;_edgetpu.tflite&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;TensorFlow.js&quot;</span><span class="s4">, </span><span class="s6">&quot;tfjs&quot;</span><span class="s4">, </span><span class="s6">&quot;_web_model&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;PaddlePaddle&quot;</span><span class="s4">, </span><span class="s6">&quot;paddle&quot;</span><span class="s4">, </span><span class="s6">&quot;_paddle_model&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">],</span>
    <span class="s4">]</span>
    <span class="s3">return </span><span class="s1">pd</span><span class="s4">.</span><span class="s1">DataFrame</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">columns</span><span class="s4">=[</span><span class="s6">&quot;Format&quot;</span><span class="s4">, </span><span class="s6">&quot;Argument&quot;</span><span class="s4">, </span><span class="s6">&quot;Suffix&quot;</span><span class="s4">, </span><span class="s6">&quot;CPU&quot;</span><span class="s4">, </span><span class="s6">&quot;GPU&quot;</span><span class="s4">])</span>


<span class="s3">def </span><span class="s1">try_export</span><span class="s4">(</span><span class="s1">inner_func</span><span class="s4">):</span>
    <span class="s0"># YOLOv5 export decorator, i..e @try_export</span>
    <span class="s1">inner_args </span><span class="s4">= </span><span class="s1">get_default_args</span><span class="s4">(</span><span class="s1">inner_func</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">outer_func</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s1">prefix </span><span class="s4">= </span><span class="s1">inner_args</span><span class="s4">[</span><span class="s6">&quot;prefix&quot;</span><span class="s4">]</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">with </span><span class="s1">Profile</span><span class="s4">() </span><span class="s3">as </span><span class="s1">dt</span><span class="s4">:</span>
                <span class="s1">f</span><span class="s4">, </span><span class="s1">model </span><span class="s4">= </span><span class="s1">inner_func</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>
            <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">export success ‚úÖ </span><span class="s3">{</span><span class="s1">dt</span><span class="s4">.</span><span class="s1">t</span><span class="s3">:</span><span class="s6">.1f</span><span class="s3">}</span><span class="s6">s, saved as </span><span class="s3">{</span><span class="s1">f</span><span class="s3">} </span><span class="s6">(</span><span class="s3">{</span><span class="s1">file_size</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span><span class="s3">:</span><span class="s6">.1f</span><span class="s3">} </span><span class="s6">MB)&quot;</span><span class="s4">)</span>
            <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s1">model</span>
        <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">export failure ‚ùå </span><span class="s3">{</span><span class="s1">dt</span><span class="s4">.</span><span class="s1">t</span><span class="s3">:</span><span class="s6">.1f</span><span class="s3">}</span><span class="s6">s: </span><span class="s3">{</span><span class="s1">e</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>
            <span class="s3">return None</span><span class="s4">, </span><span class="s3">None</span>

    <span class="s3">return </span><span class="s1">outer_func</span>


<span class="s4">@</span><span class="s1">try_export</span>
<span class="s3">def </span><span class="s1">export_torchscript</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">optimize</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;TorchScript:&quot;</span><span class="s4">)):</span>
    <span class="s0"># YOLOv5 TorchScript model export</span>
    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting export with torch </span><span class="s3">{</span><span class="s1">torch</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.torchscript&quot;</span><span class="s4">)</span>

    <span class="s1">ts </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">jit</span><span class="s4">.</span><span class="s1">trace</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">strict</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s1">d </span><span class="s4">= {</span><span class="s6">&quot;shape&quot;</span><span class="s4">: </span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, </span><span class="s6">&quot;stride&quot;</span><span class="s4">: </span><span class="s1">int</span><span class="s4">(</span><span class="s1">max</span><span class="s4">(</span><span class="s1">model</span><span class="s4">.</span><span class="s1">stride</span><span class="s4">)), </span><span class="s6">&quot;names&quot;</span><span class="s4">: </span><span class="s1">model</span><span class="s4">.</span><span class="s1">names</span><span class="s4">}</span>
    <span class="s1">extra_files </span><span class="s4">= {</span><span class="s6">&quot;config.txt&quot;</span><span class="s4">: </span><span class="s1">json</span><span class="s4">.</span><span class="s1">dumps</span><span class="s4">(</span><span class="s1">d</span><span class="s4">)}  </span><span class="s0"># torch._C.ExtraFilesMap()</span>
    <span class="s3">if </span><span class="s1">optimize</span><span class="s4">:  </span><span class="s0"># https://pytorch.org/tutorials/recipes/mobile_interpreter.html</span>
        <span class="s1">optimize_for_mobile</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">).</span><span class="s1">_save_for_lite_interpreter</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">f</span><span class="s4">), </span><span class="s1">_extra_files</span><span class="s4">=</span><span class="s1">extra_files</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">ts</span><span class="s4">.</span><span class="s1">save</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">f</span><span class="s4">), </span><span class="s1">_extra_files</span><span class="s4">=</span><span class="s1">extra_files</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s3">None</span>


<span class="s4">@</span><span class="s1">try_export</span>
<span class="s3">def </span><span class="s1">export_onnx</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">opset</span><span class="s4">, </span><span class="s1">dynamic</span><span class="s4">, </span><span class="s1">simplify</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;ONNX:&quot;</span><span class="s4">)):</span>
    <span class="s0"># YOLOv5 ONNX export</span>
    <span class="s1">check_requirements</span><span class="s4">(</span><span class="s6">&quot;onnx&gt;=1.12.0&quot;</span><span class="s4">)</span>
    <span class="s3">import </span><span class="s1">onnx</span>

    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting export with onnx </span><span class="s3">{</span><span class="s1">onnx</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.onnx&quot;</span><span class="s4">))</span>

    <span class="s1">output_names </span><span class="s4">= [</span><span class="s6">&quot;output0&quot;</span><span class="s4">, </span><span class="s6">&quot;output1&quot;</span><span class="s4">] </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">SegmentationModel</span><span class="s4">) </span><span class="s3">else </span><span class="s4">[</span><span class="s6">&quot;output0&quot;</span><span class="s4">]</span>
    <span class="s3">if </span><span class="s1">dynamic</span><span class="s4">:</span>
        <span class="s1">dynamic </span><span class="s4">= {</span><span class="s6">&quot;images&quot;</span><span class="s4">: {</span><span class="s5">0</span><span class="s4">: </span><span class="s6">&quot;batch&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">: </span><span class="s6">&quot;height&quot;</span><span class="s4">, </span><span class="s5">3</span><span class="s4">: </span><span class="s6">&quot;width&quot;</span><span class="s4">}}  </span><span class="s0"># shape(1,3,640,640)</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">SegmentationModel</span><span class="s4">):</span>
            <span class="s1">dynamic</span><span class="s4">[</span><span class="s6">&quot;output0&quot;</span><span class="s4">] = {</span><span class="s5">0</span><span class="s4">: </span><span class="s6">&quot;batch&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">: </span><span class="s6">&quot;anchors&quot;</span><span class="s4">}  </span><span class="s0"># shape(1,25200,85)</span>
            <span class="s1">dynamic</span><span class="s4">[</span><span class="s6">&quot;output1&quot;</span><span class="s4">] = {</span><span class="s5">0</span><span class="s4">: </span><span class="s6">&quot;batch&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">: </span><span class="s6">&quot;mask_height&quot;</span><span class="s4">, </span><span class="s5">3</span><span class="s4">: </span><span class="s6">&quot;mask_width&quot;</span><span class="s4">}  </span><span class="s0"># shape(1,32,160,160)</span>
        <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">DetectionModel</span><span class="s4">):</span>
            <span class="s1">dynamic</span><span class="s4">[</span><span class="s6">&quot;output0&quot;</span><span class="s4">] = {</span><span class="s5">0</span><span class="s4">: </span><span class="s6">&quot;batch&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">: </span><span class="s6">&quot;anchors&quot;</span><span class="s4">}  </span><span class="s0"># shape(1,25200,85)</span>

    <span class="s1">torch</span><span class="s4">.</span><span class="s1">onnx</span><span class="s4">.</span><span class="s1">export</span><span class="s4">(</span>
        <span class="s1">model</span><span class="s4">.</span><span class="s1">cpu</span><span class="s4">() </span><span class="s3">if </span><span class="s1">dynamic </span><span class="s3">else </span><span class="s1">model</span><span class="s4">,  </span><span class="s0"># --dynamic only compatible with cpu</span>
        <span class="s1">im</span><span class="s4">.</span><span class="s1">cpu</span><span class="s4">() </span><span class="s3">if </span><span class="s1">dynamic </span><span class="s3">else </span><span class="s1">im</span><span class="s4">,</span>
        <span class="s1">f</span><span class="s4">,</span>
        <span class="s1">verbose</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">opset_version</span><span class="s4">=</span><span class="s1">opset</span><span class="s4">,</span>
        <span class="s1">do_constant_folding</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,  </span><span class="s0"># WARNING: DNN inference with torch&gt;=1.12 may require do_constant_folding=False</span>
        <span class="s1">input_names</span><span class="s4">=[</span><span class="s6">&quot;images&quot;</span><span class="s4">],</span>
        <span class="s1">output_names</span><span class="s4">=</span><span class="s1">output_names</span><span class="s4">,</span>
        <span class="s1">dynamic_axes</span><span class="s4">=</span><span class="s1">dynamic </span><span class="s3">or None</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s0"># Checks</span>
    <span class="s1">model_onnx </span><span class="s4">= </span><span class="s1">onnx</span><span class="s4">.</span><span class="s1">load</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)  </span><span class="s0"># load onnx model</span>
    <span class="s1">onnx</span><span class="s4">.</span><span class="s1">checker</span><span class="s4">.</span><span class="s1">check_model</span><span class="s4">(</span><span class="s1">model_onnx</span><span class="s4">)  </span><span class="s0"># check onnx model</span>

    <span class="s0"># Metadata</span>
    <span class="s1">d </span><span class="s4">= {</span><span class="s6">&quot;stride&quot;</span><span class="s4">: </span><span class="s1">int</span><span class="s4">(</span><span class="s1">max</span><span class="s4">(</span><span class="s1">model</span><span class="s4">.</span><span class="s1">stride</span><span class="s4">)), </span><span class="s6">&quot;names&quot;</span><span class="s4">: </span><span class="s1">model</span><span class="s4">.</span><span class="s1">names</span><span class="s4">}</span>
    <span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">d</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
        <span class="s1">meta </span><span class="s4">= </span><span class="s1">model_onnx</span><span class="s4">.</span><span class="s1">metadata_props</span><span class="s4">.</span><span class="s1">add</span><span class="s4">()</span>
        <span class="s1">meta</span><span class="s4">.</span><span class="s1">key</span><span class="s4">, </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">value </span><span class="s4">= </span><span class="s1">k</span><span class="s4">, </span><span class="s1">str</span><span class="s4">(</span><span class="s1">v</span><span class="s4">)</span>
    <span class="s1">onnx</span><span class="s4">.</span><span class="s1">save</span><span class="s4">(</span><span class="s1">model_onnx</span><span class="s4">, </span><span class="s1">f</span><span class="s4">)</span>

    <span class="s0"># Simplify</span>
    <span class="s3">if </span><span class="s1">simplify</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">cuda </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cuda</span><span class="s4">.</span><span class="s1">is_available</span><span class="s4">()</span>
            <span class="s1">check_requirements</span><span class="s4">((</span><span class="s6">&quot;onnxruntime-gpu&quot; </span><span class="s3">if </span><span class="s1">cuda </span><span class="s3">else </span><span class="s6">&quot;onnxruntime&quot;</span><span class="s4">, </span><span class="s6">&quot;onnx-simplifier&gt;=0.4.1&quot;</span><span class="s4">))</span>
            <span class="s3">import </span><span class="s1">onnxsim</span>

            <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">simplifying with onnx-simplifier </span><span class="s3">{</span><span class="s1">onnxsim</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
            <span class="s1">model_onnx</span><span class="s4">, </span><span class="s1">check </span><span class="s4">= </span><span class="s1">onnxsim</span><span class="s4">.</span><span class="s1">simplify</span><span class="s4">(</span><span class="s1">model_onnx</span><span class="s4">)</span>
            <span class="s3">assert </span><span class="s1">check</span><span class="s4">, </span><span class="s6">&quot;assert check failed&quot;</span>
            <span class="s1">onnx</span><span class="s4">.</span><span class="s1">save</span><span class="s4">(</span><span class="s1">model_onnx</span><span class="s4">, </span><span class="s1">f</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">simplifier failure: </span><span class="s3">{</span><span class="s1">e</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s1">model_onnx</span>


<span class="s4">@</span><span class="s1">try_export</span>
<span class="s3">def </span><span class="s1">export_openvino</span><span class="s4">(</span><span class="s1">file</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">, </span><span class="s1">half</span><span class="s4">, </span><span class="s1">int8</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;OpenVINO:&quot;</span><span class="s4">)):</span>
    <span class="s0"># YOLOv5 OpenVINO export</span>
    <span class="s1">check_requirements</span><span class="s4">(</span><span class="s6">&quot;openvino-dev&gt;=2023.0&quot;</span><span class="s4">)  </span><span class="s0"># requires openvino-dev: https://pypi.org/project/openvino-dev/</span>
    <span class="s3">import </span><span class="s1">openvino</span><span class="s4">.</span><span class="s1">runtime </span><span class="s3">as </span><span class="s1">ov  </span><span class="s0"># noqa</span>
    <span class="s3">from </span><span class="s1">openvino</span><span class="s4">.</span><span class="s1">tools </span><span class="s3">import </span><span class="s1">mo  </span><span class="s0"># noqa</span>

    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting export with openvino </span><span class="s3">{</span><span class="s1">ov</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">file</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s1">file</span><span class="s4">.</span><span class="s1">suffix</span><span class="s4">, </span><span class="s6">f&quot;_openvino_model</span><span class="s3">{</span><span class="s1">os</span><span class="s4">.</span><span class="s1">sep</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>
    <span class="s1">f_onnx </span><span class="s4">= </span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.onnx&quot;</span><span class="s4">)</span>
    <span class="s1">f_ov </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">f</span><span class="s4">) / </span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.xml&quot;</span><span class="s4">).</span><span class="s1">name</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">int8</span><span class="s4">:</span>
        <span class="s1">check_requirements</span><span class="s4">(</span><span class="s6">&quot;nncf&gt;=2.4.0&quot;</span><span class="s4">)  </span><span class="s0"># requires at least version 2.4.0 to use the post-training quantization</span>
        <span class="s3">import </span><span class="s1">nncf</span>
        <span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
        <span class="s3">from </span><span class="s1">openvino</span><span class="s4">.</span><span class="s1">runtime </span><span class="s3">import </span><span class="s1">Core</span>

        <span class="s3">from </span><span class="s1">utils</span><span class="s4">.</span><span class="s1">dataloaders </span><span class="s3">import </span><span class="s1">create_dataloader</span>

        <span class="s1">core </span><span class="s4">= </span><span class="s1">Core</span><span class="s4">()</span>
        <span class="s1">onnx_model </span><span class="s4">= </span><span class="s1">core</span><span class="s4">.</span><span class="s1">read_model</span><span class="s4">(</span><span class="s1">f_onnx</span><span class="s4">)  </span><span class="s0"># export</span>

        <span class="s3">def </span><span class="s1">prepare_input_tensor</span><span class="s4">(</span><span class="s1">image</span><span class="s4">: </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ndarray</span><span class="s4">):</span>
            <span class="s1">input_tensor </span><span class="s4">= </span><span class="s1">image</span><span class="s4">.</span><span class="s1">astype</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">float32</span><span class="s4">)  </span><span class="s0"># uint8 to fp16/32</span>
            <span class="s1">input_tensor </span><span class="s4">/= </span><span class="s5">255.0  </span><span class="s0"># 0 - 255 to 0.0 - 1.0</span>

            <span class="s3">if </span><span class="s1">input_tensor</span><span class="s4">.</span><span class="s1">ndim </span><span class="s4">== </span><span class="s5">3</span><span class="s4">:</span>
                <span class="s1">input_tensor </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">expand_dims</span><span class="s4">(</span><span class="s1">input_tensor</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)</span>
            <span class="s3">return </span><span class="s1">input_tensor</span>

        <span class="s3">def </span><span class="s1">gen_dataloader</span><span class="s4">(</span><span class="s1">yaml_path</span><span class="s4">, </span><span class="s1">task</span><span class="s4">=</span><span class="s6">&quot;train&quot;</span><span class="s4">, </span><span class="s1">imgsz</span><span class="s4">=</span><span class="s5">640</span><span class="s4">, </span><span class="s1">workers</span><span class="s4">=</span><span class="s5">4</span><span class="s4">):</span>
            <span class="s1">data_yaml </span><span class="s4">= </span><span class="s1">check_yaml</span><span class="s4">(</span><span class="s1">yaml_path</span><span class="s4">)</span>
            <span class="s1">data </span><span class="s4">= </span><span class="s1">check_dataset</span><span class="s4">(</span><span class="s1">data_yaml</span><span class="s4">)</span>
            <span class="s1">dataloader </span><span class="s4">= </span><span class="s1">create_dataloader</span><span class="s4">(</span>
                <span class="s1">data</span><span class="s4">[</span><span class="s1">task</span><span class="s4">], </span><span class="s1">imgsz</span><span class="s4">=</span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">batch_size</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">stride</span><span class="s4">=</span><span class="s5">32</span><span class="s4">, </span><span class="s1">pad</span><span class="s4">=</span><span class="s5">0.5</span><span class="s4">, </span><span class="s1">single_cls</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">rect</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">workers</span><span class="s4">=</span><span class="s1">workers</span>
            <span class="s4">)[</span><span class="s5">0</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">dataloader</span>

        <span class="s0"># noqa: F811</span>

        <span class="s3">def </span><span class="s1">transform_fn</span><span class="s4">(</span><span class="s1">data_item</span><span class="s4">):</span>
            <span class="s2">&quot;&quot;&quot; 
            Quantization transform function. 
 
            Extracts and preprocess input data from dataloader item for quantization. 
            Parameters: 
               data_item: Tuple with data item produced by DataLoader during iteration 
            Returns: 
                input_tensor: Input data for quantization 
            &quot;&quot;&quot;</span>
            <span class="s1">img </span><span class="s4">= </span><span class="s1">data_item</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">numpy</span><span class="s4">()</span>
            <span class="s1">input_tensor </span><span class="s4">= </span><span class="s1">prepare_input_tensor</span><span class="s4">(</span><span class="s1">img</span><span class="s4">)</span>
            <span class="s3">return </span><span class="s1">input_tensor</span>

        <span class="s1">ds </span><span class="s4">= </span><span class="s1">gen_dataloader</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)</span>
        <span class="s1">quantization_dataset </span><span class="s4">= </span><span class="s1">nncf</span><span class="s4">.</span><span class="s1">Dataset</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">, </span><span class="s1">transform_fn</span><span class="s4">)</span>
        <span class="s1">ov_model </span><span class="s4">= </span><span class="s1">nncf</span><span class="s4">.</span><span class="s1">quantize</span><span class="s4">(</span><span class="s1">onnx_model</span><span class="s4">, </span><span class="s1">quantization_dataset</span><span class="s4">, </span><span class="s1">preset</span><span class="s4">=</span><span class="s1">nncf</span><span class="s4">.</span><span class="s1">QuantizationPreset</span><span class="s4">.</span><span class="s1">MIXED</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">ov_model </span><span class="s4">= </span><span class="s1">mo</span><span class="s4">.</span><span class="s1">convert_model</span><span class="s4">(</span><span class="s1">f_onnx</span><span class="s4">, </span><span class="s1">model_name</span><span class="s4">=</span><span class="s1">file</span><span class="s4">.</span><span class="s1">stem</span><span class="s4">, </span><span class="s1">framework</span><span class="s4">=</span><span class="s6">&quot;onnx&quot;</span><span class="s4">, </span><span class="s1">compress_to_fp16</span><span class="s4">=</span><span class="s1">half</span><span class="s4">)  </span><span class="s0"># export</span>

    <span class="s1">ov</span><span class="s4">.</span><span class="s1">serialize</span><span class="s4">(</span><span class="s1">ov_model</span><span class="s4">, </span><span class="s1">f_ov</span><span class="s4">)  </span><span class="s0"># save</span>
    <span class="s1">yaml_save</span><span class="s4">(</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">f</span><span class="s4">) / </span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.yaml&quot;</span><span class="s4">).</span><span class="s1">name</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">)  </span><span class="s0"># add metadata.yaml</span>
    <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s3">None</span>


<span class="s4">@</span><span class="s1">try_export</span>
<span class="s3">def </span><span class="s1">export_paddle</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;PaddlePaddle:&quot;</span><span class="s4">)):</span>
    <span class="s0"># YOLOv5 Paddle export</span>
    <span class="s1">check_requirements</span><span class="s4">((</span><span class="s6">&quot;paddlepaddle&quot;</span><span class="s4">, </span><span class="s6">&quot;x2paddle&quot;</span><span class="s4">))</span>
    <span class="s3">import </span><span class="s1">x2paddle</span>
    <span class="s3">from </span><span class="s1">x2paddle</span><span class="s4">.</span><span class="s1">convert </span><span class="s3">import </span><span class="s1">pytorch2paddle</span>

    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting export with X2Paddle </span><span class="s3">{</span><span class="s1">x2paddle</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">file</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;.pt&quot;</span><span class="s4">, </span><span class="s6">f&quot;_paddle_model</span><span class="s3">{</span><span class="s1">os</span><span class="s4">.</span><span class="s1">sep</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>

    <span class="s1">pytorch2paddle</span><span class="s4">(</span><span class="s1">module</span><span class="s4">=</span><span class="s1">model</span><span class="s4">, </span><span class="s1">save_dir</span><span class="s4">=</span><span class="s1">f</span><span class="s4">, </span><span class="s1">jit_type</span><span class="s4">=</span><span class="s6">&quot;trace&quot;</span><span class="s4">, </span><span class="s1">input_examples</span><span class="s4">=[</span><span class="s1">im</span><span class="s4">])  </span><span class="s0"># export</span>
    <span class="s1">yaml_save</span><span class="s4">(</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">f</span><span class="s4">) / </span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.yaml&quot;</span><span class="s4">).</span><span class="s1">name</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">)  </span><span class="s0"># add metadata.yaml</span>
    <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s3">None</span>


<span class="s4">@</span><span class="s1">try_export</span>
<span class="s3">def </span><span class="s1">export_coreml</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">int8</span><span class="s4">, </span><span class="s1">half</span><span class="s4">, </span><span class="s1">nms</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;CoreML:&quot;</span><span class="s4">)):</span>
    <span class="s0"># YOLOv5 CoreML export</span>
    <span class="s1">check_requirements</span><span class="s4">(</span><span class="s6">&quot;coremltools&quot;</span><span class="s4">)</span>
    <span class="s3">import </span><span class="s1">coremltools </span><span class="s3">as </span><span class="s1">ct</span>

    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting export with coremltools </span><span class="s3">{</span><span class="s1">ct</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.mlmodel&quot;</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">nms</span><span class="s4">:</span>
        <span class="s1">model </span><span class="s4">= </span><span class="s1">iOSModel</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">)</span>
    <span class="s1">ts </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">jit</span><span class="s4">.</span><span class="s1">trace</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">strict</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)  </span><span class="s0"># TorchScript model</span>
    <span class="s1">ct_model </span><span class="s4">= </span><span class="s1">ct</span><span class="s4">.</span><span class="s1">convert</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">, </span><span class="s1">inputs</span><span class="s4">=[</span><span class="s1">ct</span><span class="s4">.</span><span class="s1">ImageType</span><span class="s4">(</span><span class="s6">&quot;image&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=</span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">scale</span><span class="s4">=</span><span class="s5">1 </span><span class="s4">/ </span><span class="s5">255</span><span class="s4">, </span><span class="s1">bias</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])])</span>
    <span class="s1">bits</span><span class="s4">, </span><span class="s1">mode </span><span class="s4">= (</span><span class="s5">8</span><span class="s4">, </span><span class="s6">&quot;kmeans_lut&quot;</span><span class="s4">) </span><span class="s3">if </span><span class="s1">int8 </span><span class="s3">else </span><span class="s4">(</span><span class="s5">16</span><span class="s4">, </span><span class="s6">&quot;linear&quot;</span><span class="s4">) </span><span class="s3">if </span><span class="s1">half </span><span class="s3">else </span><span class="s4">(</span><span class="s5">32</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">bits </span><span class="s4">&lt; </span><span class="s5">32</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">MACOS</span><span class="s4">:  </span><span class="s0"># quantization only supported on macOS</span>
            <span class="s3">with </span><span class="s1">warnings</span><span class="s4">.</span><span class="s1">catch_warnings</span><span class="s4">():</span>
                <span class="s1">warnings</span><span class="s4">.</span><span class="s1">filterwarnings</span><span class="s4">(</span><span class="s6">&quot;ignore&quot;</span><span class="s4">, </span><span class="s1">category</span><span class="s4">=</span><span class="s1">DeprecationWarning</span><span class="s4">)  </span><span class="s0"># suppress numpy==1.20 float warning</span>
                <span class="s1">ct_model </span><span class="s4">= </span><span class="s1">ct</span><span class="s4">.</span><span class="s1">models</span><span class="s4">.</span><span class="s1">neural_network</span><span class="s4">.</span><span class="s1">quantization_utils</span><span class="s4">.</span><span class="s1">quantize_weights</span><span class="s4">(</span><span class="s1">ct_model</span><span class="s4">, </span><span class="s1">bits</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">quantization only supported on macOS, skipping...&quot;</span><span class="s4">)</span>
    <span class="s1">ct_model</span><span class="s4">.</span><span class="s1">save</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s1">ct_model</span>


<span class="s4">@</span><span class="s1">try_export</span>
<span class="s3">def </span><span class="s1">export_engine</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">half</span><span class="s4">, </span><span class="s1">dynamic</span><span class="s4">, </span><span class="s1">simplify</span><span class="s4">, </span><span class="s1">workspace</span><span class="s4">=</span><span class="s5">4</span><span class="s4">, </span><span class="s1">verbose</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;TensorRT:&quot;</span><span class="s4">)):</span>
    <span class="s0"># YOLOv5 TensorRT export https://developer.nvidia.com/tensorrt</span>
    <span class="s3">assert </span><span class="s1">im</span><span class="s4">.</span><span class="s1">device</span><span class="s4">.</span><span class="s1">type </span><span class="s4">!= </span><span class="s6">&quot;cpu&quot;</span><span class="s4">, </span><span class="s6">&quot;export running on CPU but must be on GPU, i.e. `python export.py --device 0`&quot;</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s3">import </span><span class="s1">tensorrt </span><span class="s3">as </span><span class="s1">trt</span>
    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">platform</span><span class="s4">.</span><span class="s1">system</span><span class="s4">() == </span><span class="s6">&quot;Linux&quot;</span><span class="s4">:</span>
            <span class="s1">check_requirements</span><span class="s4">(</span><span class="s6">&quot;nvidia-tensorrt&quot;</span><span class="s4">, </span><span class="s1">cmds</span><span class="s4">=</span><span class="s6">&quot;-U --index-url https://pypi.ngc.nvidia.com&quot;</span><span class="s4">)</span>
        <span class="s3">import </span><span class="s1">tensorrt </span><span class="s3">as </span><span class="s1">trt</span>

    <span class="s3">if </span><span class="s1">trt</span><span class="s4">.</span><span class="s1">__version__</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] == </span><span class="s6">&quot;7&quot;</span><span class="s4">:  </span><span class="s0"># TensorRT 7 handling https://github.com/ultralytics/yolov5/issues/6012</span>
        <span class="s1">grid </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">model</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">anchor_grid</span>
        <span class="s1">model</span><span class="s4">.</span><span class="s1">model</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">anchor_grid </span><span class="s4">= [</span><span class="s1">a</span><span class="s4">[..., :</span><span class="s5">1</span><span class="s4">, :</span><span class="s5">1</span><span class="s4">, :] </span><span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">grid</span><span class="s4">]</span>
        <span class="s1">export_onnx</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s1">dynamic</span><span class="s4">, </span><span class="s1">simplify</span><span class="s4">)  </span><span class="s0"># opset 12</span>
        <span class="s1">model</span><span class="s4">.</span><span class="s1">model</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">anchor_grid </span><span class="s4">= </span><span class="s1">grid</span>
    <span class="s3">else</span><span class="s4">:  </span><span class="s0"># TensorRT &gt;= 8</span>
        <span class="s1">check_version</span><span class="s4">(</span><span class="s1">trt</span><span class="s4">.</span><span class="s1">__version__</span><span class="s4">, </span><span class="s6">&quot;8.0.0&quot;</span><span class="s4">, </span><span class="s1">hard</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)  </span><span class="s0"># require tensorrt&gt;=8.0.0</span>
        <span class="s1">export_onnx</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s1">dynamic</span><span class="s4">, </span><span class="s1">simplify</span><span class="s4">)  </span><span class="s0"># opset 12</span>
    <span class="s1">onnx </span><span class="s4">= </span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.onnx&quot;</span><span class="s4">)</span>

    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting export with TensorRT </span><span class="s3">{</span><span class="s1">trt</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">onnx</span><span class="s4">.</span><span class="s1">exists</span><span class="s4">(), </span><span class="s6">f&quot;failed to export ONNX file: </span><span class="s3">{</span><span class="s1">onnx</span><span class="s3">}</span><span class="s6">&quot;</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.engine&quot;</span><span class="s4">)  </span><span class="s0"># TensorRT engine file</span>
    <span class="s1">logger </span><span class="s4">= </span><span class="s1">trt</span><span class="s4">.</span><span class="s1">Logger</span><span class="s4">(</span><span class="s1">trt</span><span class="s4">.</span><span class="s1">Logger</span><span class="s4">.</span><span class="s1">INFO</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">verbose</span><span class="s4">:</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">min_severity </span><span class="s4">= </span><span class="s1">trt</span><span class="s4">.</span><span class="s1">Logger</span><span class="s4">.</span><span class="s1">Severity</span><span class="s4">.</span><span class="s1">VERBOSE</span>

    <span class="s1">builder </span><span class="s4">= </span><span class="s1">trt</span><span class="s4">.</span><span class="s1">Builder</span><span class="s4">(</span><span class="s1">logger</span><span class="s4">)</span>
    <span class="s1">config </span><span class="s4">= </span><span class="s1">builder</span><span class="s4">.</span><span class="s1">create_builder_config</span><span class="s4">()</span>
    <span class="s1">config</span><span class="s4">.</span><span class="s1">max_workspace_size </span><span class="s4">= </span><span class="s1">workspace </span><span class="s4">* </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">30</span>
    <span class="s0"># config.set_memory_pool_limit(trt.MemoryPoolType.WORKSPACE, workspace &lt;&lt; 30)  # fix TRT 8.4 deprecation notice</span>

    <span class="s1">flag </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s1">int</span><span class="s4">(</span><span class="s1">trt</span><span class="s4">.</span><span class="s1">NetworkDefinitionCreationFlag</span><span class="s4">.</span><span class="s1">EXPLICIT_BATCH</span><span class="s4">)</span>
    <span class="s1">network </span><span class="s4">= </span><span class="s1">builder</span><span class="s4">.</span><span class="s1">create_network</span><span class="s4">(</span><span class="s1">flag</span><span class="s4">)</span>
    <span class="s1">parser </span><span class="s4">= </span><span class="s1">trt</span><span class="s4">.</span><span class="s1">OnnxParser</span><span class="s4">(</span><span class="s1">network</span><span class="s4">, </span><span class="s1">logger</span><span class="s4">)</span>
    <span class="s3">if not </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse_from_file</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">onnx</span><span class="s4">)):</span>
        <span class="s3">raise </span><span class="s1">RuntimeError</span><span class="s4">(</span><span class="s6">f&quot;failed to load ONNX file: </span><span class="s3">{</span><span class="s1">onnx</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>

    <span class="s1">inputs </span><span class="s4">= [</span><span class="s1">network</span><span class="s4">.</span><span class="s1">get_input</span><span class="s4">(</span><span class="s1">i</span><span class="s4">) </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">network</span><span class="s4">.</span><span class="s1">num_inputs</span><span class="s4">)]</span>
    <span class="s1">outputs </span><span class="s4">= [</span><span class="s1">network</span><span class="s4">.</span><span class="s1">get_output</span><span class="s4">(</span><span class="s1">i</span><span class="s4">) </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">network</span><span class="s4">.</span><span class="s1">num_outputs</span><span class="s4">)]</span>
    <span class="s3">for </span><span class="s1">inp </span><span class="s3">in </span><span class="s1">inputs</span><span class="s4">:</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f'</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">input &quot;</span><span class="s3">{</span><span class="s1">inp</span><span class="s4">.</span><span class="s1">name</span><span class="s3">}</span><span class="s6">&quot; with shape</span><span class="s3">{</span><span class="s1">inp</span><span class="s4">.</span><span class="s1">shape</span><span class="s3">} {</span><span class="s1">inp</span><span class="s4">.</span><span class="s1">dtype</span><span class="s3">}</span><span class="s6">'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">out </span><span class="s3">in </span><span class="s1">outputs</span><span class="s4">:</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f'</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">output &quot;</span><span class="s3">{</span><span class="s1">out</span><span class="s4">.</span><span class="s1">name</span><span class="s3">}</span><span class="s6">&quot; with shape</span><span class="s3">{</span><span class="s1">out</span><span class="s4">.</span><span class="s1">shape</span><span class="s3">} {</span><span class="s1">out</span><span class="s4">.</span><span class="s1">dtype</span><span class="s3">}</span><span class="s6">'</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">dynamic</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] &lt;= </span><span class="s5">1</span><span class="s4">:</span>
            <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">warning</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">WARNING ‚ö†Ô∏è --dynamic model requires maximum --batch-size argument&quot;</span><span class="s4">)</span>
        <span class="s1">profile </span><span class="s4">= </span><span class="s1">builder</span><span class="s4">.</span><span class="s1">create_optimization_profile</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">inp </span><span class="s3">in </span><span class="s1">inputs</span><span class="s4">:</span>
            <span class="s1">profile</span><span class="s4">.</span><span class="s1">set_shape</span><span class="s4">(</span><span class="s1">inp</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, (</span><span class="s5">1</span><span class="s4">, *</span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:]), (</span><span class="s1">max</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] // </span><span class="s5">2</span><span class="s4">), *</span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:]), </span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">)</span>
        <span class="s1">config</span><span class="s4">.</span><span class="s1">add_optimization_profile</span><span class="s4">(</span><span class="s1">profile</span><span class="s4">)</span>

    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">building FP</span><span class="s3">{</span><span class="s5">16 </span><span class="s3">if </span><span class="s1">builder</span><span class="s4">.</span><span class="s1">platform_has_fast_fp16 </span><span class="s3">and </span><span class="s1">half </span><span class="s3">else </span><span class="s5">32</span><span class="s3">} </span><span class="s6">engine as </span><span class="s3">{</span><span class="s1">f</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">builder</span><span class="s4">.</span><span class="s1">platform_has_fast_fp16 </span><span class="s3">and </span><span class="s1">half</span><span class="s4">:</span>
        <span class="s1">config</span><span class="s4">.</span><span class="s1">set_flag</span><span class="s4">(</span><span class="s1">trt</span><span class="s4">.</span><span class="s1">BuilderFlag</span><span class="s4">.</span><span class="s1">FP16</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">builder</span><span class="s4">.</span><span class="s1">build_engine</span><span class="s4">(</span><span class="s1">network</span><span class="s4">, </span><span class="s1">config</span><span class="s4">) </span><span class="s3">as </span><span class="s1">engine</span><span class="s4">, </span><span class="s1">open</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s6">&quot;wb&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">t</span><span class="s4">:</span>
        <span class="s1">t</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s1">engine</span><span class="s4">.</span><span class="s1">serialize</span><span class="s4">())</span>
    <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s3">None</span>


<span class="s4">@</span><span class="s1">try_export</span>
<span class="s3">def </span><span class="s1">export_saved_model</span><span class="s4">(</span>
    <span class="s1">model</span><span class="s4">,</span>
    <span class="s1">im</span><span class="s4">,</span>
    <span class="s1">file</span><span class="s4">,</span>
    <span class="s1">dynamic</span><span class="s4">,</span>
    <span class="s1">tf_nms</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">agnostic_nms</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">topk_per_class</span><span class="s4">=</span><span class="s5">100</span><span class="s4">,</span>
    <span class="s1">topk_all</span><span class="s4">=</span><span class="s5">100</span><span class="s4">,</span>
    <span class="s1">iou_thres</span><span class="s4">=</span><span class="s5">0.45</span><span class="s4">,</span>
    <span class="s1">conf_thres</span><span class="s4">=</span><span class="s5">0.25</span><span class="s4">,</span>
    <span class="s1">keras</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;TensorFlow SavedModel:&quot;</span><span class="s4">),</span>
<span class="s4">):</span>
    <span class="s0"># YOLOv5 TensorFlow SavedModel export</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s3">import </span><span class="s1">tensorflow </span><span class="s3">as </span><span class="s1">tf</span>
    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
        <span class="s1">check_requirements</span><span class="s4">(</span><span class="s6">f&quot;tensorflow</span><span class="s3">{</span><span class="s6">'' </span><span class="s3">if </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">cuda</span><span class="s4">.</span><span class="s1">is_available</span><span class="s4">() </span><span class="s3">else </span><span class="s6">'-macos' </span><span class="s3">if </span><span class="s1">MACOS </span><span class="s3">else </span><span class="s6">'-cpu'</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>
        <span class="s3">import </span><span class="s1">tensorflow </span><span class="s3">as </span><span class="s1">tf</span>
    <span class="s3">from </span><span class="s1">tensorflow</span><span class="s4">.</span><span class="s1">python</span><span class="s4">.</span><span class="s1">framework</span><span class="s4">.</span><span class="s1">convert_to_constants </span><span class="s3">import </span><span class="s1">convert_variables_to_constants_v2</span>

    <span class="s3">from </span><span class="s1">models</span><span class="s4">.</span><span class="s1">tf </span><span class="s3">import </span><span class="s1">TFModel</span>

    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting export with tensorflow </span><span class="s3">{</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">__version__ </span><span class="s4">&gt; </span><span class="s6">&quot;2.13.1&quot;</span><span class="s4">:</span>
        <span class="s1">helper_url </span><span class="s4">= </span><span class="s6">&quot;https://github.com/ultralytics/yolov5/issues/12489&quot;</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span>
            <span class="s6">f&quot;WARNING ‚ö†Ô∏è using Tensorflow </span><span class="s3">{</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">} </span><span class="s6">&gt; 2.13.1 might cause issue when exporting the model to tflite </span><span class="s3">{</span><span class="s1">helper_url</span><span class="s3">}</span><span class="s6">&quot;</span>
        <span class="s4">)  </span><span class="s0"># handling issue https://github.com/ultralytics/yolov5/issues/12489</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">file</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;.pt&quot;</span><span class="s4">, </span><span class="s6">&quot;_saved_model&quot;</span><span class="s4">)</span>
    <span class="s1">batch_size</span><span class="s4">, </span><span class="s1">ch</span><span class="s4">, *</span><span class="s1">imgsz </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">)  </span><span class="s0"># BCHW</span>

    <span class="s1">tf_model </span><span class="s4">= </span><span class="s1">TFModel</span><span class="s4">(</span><span class="s1">cfg</span><span class="s4">=</span><span class="s1">model</span><span class="s4">.</span><span class="s1">yaml</span><span class="s4">, </span><span class="s1">model</span><span class="s4">=</span><span class="s1">model</span><span class="s4">, </span><span class="s1">nc</span><span class="s4">=</span><span class="s1">model</span><span class="s4">.</span><span class="s1">nc</span><span class="s4">, </span><span class="s1">imgsz</span><span class="s4">=</span><span class="s1">imgsz</span><span class="s4">)</span>
    <span class="s1">im </span><span class="s4">= </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">((</span><span class="s1">batch_size</span><span class="s4">, *</span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">ch</span><span class="s4">))  </span><span class="s0"># BHWC order for TensorFlow</span>
    <span class="s1">_ </span><span class="s4">= </span><span class="s1">tf_model</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">im</span><span class="s4">, </span><span class="s1">tf_nms</span><span class="s4">, </span><span class="s1">agnostic_nms</span><span class="s4">, </span><span class="s1">topk_per_class</span><span class="s4">, </span><span class="s1">topk_all</span><span class="s4">, </span><span class="s1">iou_thres</span><span class="s4">, </span><span class="s1">conf_thres</span><span class="s4">)</span>
    <span class="s1">inputs </span><span class="s4">= </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">keras</span><span class="s4">.</span><span class="s1">Input</span><span class="s4">(</span><span class="s1">shape</span><span class="s4">=(*</span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">ch</span><span class="s4">), </span><span class="s1">batch_size</span><span class="s4">=</span><span class="s3">None if </span><span class="s1">dynamic </span><span class="s3">else </span><span class="s1">batch_size</span><span class="s4">)</span>
    <span class="s1">outputs </span><span class="s4">= </span><span class="s1">tf_model</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">inputs</span><span class="s4">, </span><span class="s1">tf_nms</span><span class="s4">, </span><span class="s1">agnostic_nms</span><span class="s4">, </span><span class="s1">topk_per_class</span><span class="s4">, </span><span class="s1">topk_all</span><span class="s4">, </span><span class="s1">iou_thres</span><span class="s4">, </span><span class="s1">conf_thres</span><span class="s4">)</span>
    <span class="s1">keras_model </span><span class="s4">= </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">keras</span><span class="s4">.</span><span class="s1">Model</span><span class="s4">(</span><span class="s1">inputs</span><span class="s4">=</span><span class="s1">inputs</span><span class="s4">, </span><span class="s1">outputs</span><span class="s4">=</span><span class="s1">outputs</span><span class="s4">)</span>
    <span class="s1">keras_model</span><span class="s4">.</span><span class="s1">trainable </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">keras_model</span><span class="s4">.</span><span class="s1">summary</span><span class="s4">()</span>
    <span class="s3">if </span><span class="s1">keras</span><span class="s4">:</span>
        <span class="s1">keras_model</span><span class="s4">.</span><span class="s1">save</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">save_format</span><span class="s4">=</span><span class="s6">&quot;tf&quot;</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">spec </span><span class="s4">= </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">TensorSpec</span><span class="s4">(</span><span class="s1">keras_model</span><span class="s4">.</span><span class="s1">inputs</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">keras_model</span><span class="s4">.</span><span class="s1">inputs</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">dtype</span><span class="s4">)</span>
        <span class="s1">m </span><span class="s4">= </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">function</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">: </span><span class="s1">keras_model</span><span class="s4">(</span><span class="s1">x</span><span class="s4">))  </span><span class="s0"># full model</span>
        <span class="s1">m </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">get_concrete_function</span><span class="s4">(</span><span class="s1">spec</span><span class="s4">)</span>
        <span class="s1">frozen_func </span><span class="s4">= </span><span class="s1">convert_variables_to_constants_v2</span><span class="s4">(</span><span class="s1">m</span><span class="s4">)</span>
        <span class="s1">tfm </span><span class="s4">= </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">Module</span><span class="s4">()</span>
        <span class="s1">tfm</span><span class="s4">.</span><span class="s1">__call__ </span><span class="s4">= </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">function</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">: </span><span class="s1">frozen_func</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)[:</span><span class="s5">4</span><span class="s4">] </span><span class="s3">if </span><span class="s1">tf_nms </span><span class="s3">else </span><span class="s1">frozen_func</span><span class="s4">(</span><span class="s1">x</span><span class="s4">), [</span><span class="s1">spec</span><span class="s4">])</span>
        <span class="s1">tfm</span><span class="s4">.</span><span class="s1">__call__</span><span class="s4">(</span><span class="s1">im</span><span class="s4">)</span>
        <span class="s1">tf</span><span class="s4">.</span><span class="s1">saved_model</span><span class="s4">.</span><span class="s1">save</span><span class="s4">(</span>
            <span class="s1">tfm</span><span class="s4">,</span>
            <span class="s1">f</span><span class="s4">,</span>
            <span class="s1">options</span><span class="s4">=</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">saved_model</span><span class="s4">.</span><span class="s1">SaveOptions</span><span class="s4">(</span><span class="s1">experimental_custom_gradients</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">check_version</span><span class="s4">(</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">__version__</span><span class="s4">, </span><span class="s6">&quot;2.6&quot;</span><span class="s4">)</span>
            <span class="s3">else </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">saved_model</span><span class="s4">.</span><span class="s1">SaveOptions</span><span class="s4">(),</span>
        <span class="s4">)</span>
    <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s1">keras_model</span>


<span class="s4">@</span><span class="s1">try_export</span>
<span class="s3">def </span><span class="s1">export_pb</span><span class="s4">(</span><span class="s1">keras_model</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;TensorFlow GraphDef:&quot;</span><span class="s4">)):</span>
    <span class="s0"># YOLOv5 TensorFlow GraphDef *.pb export https://github.com/leimao/Frozen_Graph_TensorFlow</span>
    <span class="s3">import </span><span class="s1">tensorflow </span><span class="s3">as </span><span class="s1">tf</span>
    <span class="s3">from </span><span class="s1">tensorflow</span><span class="s4">.</span><span class="s1">python</span><span class="s4">.</span><span class="s1">framework</span><span class="s4">.</span><span class="s1">convert_to_constants </span><span class="s3">import </span><span class="s1">convert_variables_to_constants_v2</span>

    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting export with tensorflow </span><span class="s3">{</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.pb&quot;</span><span class="s4">)</span>

    <span class="s1">m </span><span class="s4">= </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">function</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">: </span><span class="s1">keras_model</span><span class="s4">(</span><span class="s1">x</span><span class="s4">))  </span><span class="s0"># full model</span>
    <span class="s1">m </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">get_concrete_function</span><span class="s4">(</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">TensorSpec</span><span class="s4">(</span><span class="s1">keras_model</span><span class="s4">.</span><span class="s1">inputs</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">keras_model</span><span class="s4">.</span><span class="s1">inputs</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">dtype</span><span class="s4">))</span>
    <span class="s1">frozen_func </span><span class="s4">= </span><span class="s1">convert_variables_to_constants_v2</span><span class="s4">(</span><span class="s1">m</span><span class="s4">)</span>
    <span class="s1">frozen_func</span><span class="s4">.</span><span class="s1">graph</span><span class="s4">.</span><span class="s1">as_graph_def</span><span class="s4">()</span>
    <span class="s1">tf</span><span class="s4">.</span><span class="s1">io</span><span class="s4">.</span><span class="s1">write_graph</span><span class="s4">(</span><span class="s1">graph_or_graph_def</span><span class="s4">=</span><span class="s1">frozen_func</span><span class="s4">.</span><span class="s1">graph</span><span class="s4">, </span><span class="s1">logdir</span><span class="s4">=</span><span class="s1">str</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">), </span><span class="s1">name</span><span class="s4">=</span><span class="s1">f</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">as_text</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s3">None</span>


<span class="s4">@</span><span class="s1">try_export</span>
<span class="s3">def </span><span class="s1">export_tflite</span><span class="s4">(</span>
    <span class="s1">keras_model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">int8</span><span class="s4">, </span><span class="s1">per_tensor</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">nms</span><span class="s4">, </span><span class="s1">agnostic_nms</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;TensorFlow Lite:&quot;</span><span class="s4">)</span>
<span class="s4">):</span>
    <span class="s0"># YOLOv5 TensorFlow Lite export</span>
    <span class="s3">import </span><span class="s1">tensorflow </span><span class="s3">as </span><span class="s1">tf</span>

    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting export with tensorflow </span><span class="s3">{</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s1">batch_size</span><span class="s4">, </span><span class="s1">ch</span><span class="s4">, *</span><span class="s1">imgsz </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">)  </span><span class="s0"># BCHW</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">file</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;.pt&quot;</span><span class="s4">, </span><span class="s6">&quot;-fp16.tflite&quot;</span><span class="s4">)</span>

    <span class="s1">converter </span><span class="s4">= </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">lite</span><span class="s4">.</span><span class="s1">TFLiteConverter</span><span class="s4">.</span><span class="s1">from_keras_model</span><span class="s4">(</span><span class="s1">keras_model</span><span class="s4">)</span>
    <span class="s1">converter</span><span class="s4">.</span><span class="s1">target_spec</span><span class="s4">.</span><span class="s1">supported_ops </span><span class="s4">= [</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">lite</span><span class="s4">.</span><span class="s1">OpsSet</span><span class="s4">.</span><span class="s1">TFLITE_BUILTINS</span><span class="s4">]</span>
    <span class="s1">converter</span><span class="s4">.</span><span class="s1">target_spec</span><span class="s4">.</span><span class="s1">supported_types </span><span class="s4">= [</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">float16</span><span class="s4">]</span>
    <span class="s1">converter</span><span class="s4">.</span><span class="s1">optimizations </span><span class="s4">= [</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">lite</span><span class="s4">.</span><span class="s1">Optimize</span><span class="s4">.</span><span class="s1">DEFAULT</span><span class="s4">]</span>
    <span class="s3">if </span><span class="s1">int8</span><span class="s4">:</span>
        <span class="s3">from </span><span class="s1">models</span><span class="s4">.</span><span class="s1">tf </span><span class="s3">import </span><span class="s1">representative_dataset_gen</span>

        <span class="s1">dataset </span><span class="s4">= </span><span class="s1">LoadImages</span><span class="s4">(</span><span class="s1">check_dataset</span><span class="s4">(</span><span class="s1">check_yaml</span><span class="s4">(</span><span class="s1">data</span><span class="s4">))[</span><span class="s6">&quot;train&quot;</span><span class="s4">], </span><span class="s1">img_size</span><span class="s4">=</span><span class="s1">imgsz</span><span class="s4">, </span><span class="s1">auto</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">converter</span><span class="s4">.</span><span class="s1">representative_dataset </span><span class="s4">= </span><span class="s3">lambda</span><span class="s4">: </span><span class="s1">representative_dataset_gen</span><span class="s4">(</span><span class="s1">dataset</span><span class="s4">, </span><span class="s1">ncalib</span><span class="s4">=</span><span class="s5">100</span><span class="s4">)</span>
        <span class="s1">converter</span><span class="s4">.</span><span class="s1">target_spec</span><span class="s4">.</span><span class="s1">supported_ops </span><span class="s4">= [</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">lite</span><span class="s4">.</span><span class="s1">OpsSet</span><span class="s4">.</span><span class="s1">TFLITE_BUILTINS_INT8</span><span class="s4">]</span>
        <span class="s1">converter</span><span class="s4">.</span><span class="s1">target_spec</span><span class="s4">.</span><span class="s1">supported_types </span><span class="s4">= []</span>
        <span class="s1">converter</span><span class="s4">.</span><span class="s1">inference_input_type </span><span class="s4">= </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">uint8  </span><span class="s0"># or tf.int8</span>
        <span class="s1">converter</span><span class="s4">.</span><span class="s1">inference_output_type </span><span class="s4">= </span><span class="s1">tf</span><span class="s4">.</span><span class="s1">uint8  </span><span class="s0"># or tf.int8</span>
        <span class="s1">converter</span><span class="s4">.</span><span class="s1">experimental_new_quantizer </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s3">if </span><span class="s1">per_tensor</span><span class="s4">:</span>
            <span class="s1">converter</span><span class="s4">.</span><span class="s1">_experimental_disable_per_channel </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">file</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;.pt&quot;</span><span class="s4">, </span><span class="s6">&quot;-int8.tflite&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">nms </span><span class="s3">or </span><span class="s1">agnostic_nms</span><span class="s4">:</span>
        <span class="s1">converter</span><span class="s4">.</span><span class="s1">target_spec</span><span class="s4">.</span><span class="s1">supported_ops</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">tf</span><span class="s4">.</span><span class="s1">lite</span><span class="s4">.</span><span class="s1">OpsSet</span><span class="s4">.</span><span class="s1">SELECT_TF_OPS</span><span class="s4">)</span>

    <span class="s1">tflite_model </span><span class="s4">= </span><span class="s1">converter</span><span class="s4">.</span><span class="s1">convert</span><span class="s4">()</span>
    <span class="s1">open</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s6">&quot;wb&quot;</span><span class="s4">).</span><span class="s1">write</span><span class="s4">(</span><span class="s1">tflite_model</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s3">None</span>


<span class="s4">@</span><span class="s1">try_export</span>
<span class="s3">def </span><span class="s1">export_edgetpu</span><span class="s4">(</span><span class="s1">file</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;Edge TPU:&quot;</span><span class="s4">)):</span>
    <span class="s0"># YOLOv5 Edge TPU export https://coral.ai/docs/edgetpu/models-intro/</span>
    <span class="s1">cmd </span><span class="s4">= </span><span class="s6">&quot;edgetpu_compiler --version&quot;</span>
    <span class="s1">help_url </span><span class="s4">= </span><span class="s6">&quot;https://coral.ai/docs/edgetpu/compiler/&quot;</span>
    <span class="s3">assert </span><span class="s1">platform</span><span class="s4">.</span><span class="s1">system</span><span class="s4">() == </span><span class="s6">&quot;Linux&quot;</span><span class="s4">, </span><span class="s6">f&quot;export only supported on Linux. See </span><span class="s3">{</span><span class="s1">help_url</span><span class="s3">}</span><span class="s6">&quot;</span>
    <span class="s3">if </span><span class="s1">subprocess</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">cmd</span><span class="s3">} </span><span class="s6">&gt; /dev/null 2&gt;&amp;1&quot;</span><span class="s4">, </span><span class="s1">shell</span><span class="s4">=</span><span class="s3">True</span><span class="s4">).</span><span class="s1">returncode </span><span class="s4">!= </span><span class="s5">0</span><span class="s4">:</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">export requires Edge TPU compiler. Attempting install from </span><span class="s3">{</span><span class="s1">help_url</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>
        <span class="s1">sudo </span><span class="s4">= </span><span class="s1">subprocess</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s6">&quot;sudo --version &gt;/dev/null&quot;</span><span class="s4">, </span><span class="s1">shell</span><span class="s4">=</span><span class="s3">True</span><span class="s4">).</span><span class="s1">returncode </span><span class="s4">== </span><span class="s5">0  </span><span class="s0"># sudo installed on system</span>
        <span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s4">(</span>
            <span class="s6">&quot;curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -&quot;</span><span class="s4">,</span>
            <span class="s6">'echo &quot;deb https://packages.cloud.google.com/apt coral-edgetpu-stable main&quot; | sudo tee /etc/apt/sources.list.d/coral-edgetpu.list'</span><span class="s4">,</span>
            <span class="s6">&quot;sudo apt-get update&quot;</span><span class="s4">,</span>
            <span class="s6">&quot;sudo apt-get install edgetpu-compiler&quot;</span><span class="s4">,</span>
        <span class="s4">):</span>
            <span class="s1">subprocess</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s1">c </span><span class="s3">if </span><span class="s1">sudo </span><span class="s3">else </span><span class="s1">c</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;sudo &quot;</span><span class="s4">, </span><span class="s6">&quot;&quot;</span><span class="s4">), </span><span class="s1">shell</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">check</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">ver </span><span class="s4">= </span><span class="s1">subprocess</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span><span class="s1">cmd</span><span class="s4">, </span><span class="s1">shell</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">capture_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">check</span><span class="s4">=</span><span class="s3">True</span><span class="s4">).</span><span class="s1">stdout</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">().</span><span class="s1">split</span><span class="s4">()[-</span><span class="s5">1</span><span class="s4">]</span>

    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting export with Edge TPU compiler </span><span class="s3">{</span><span class="s1">ver</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">file</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;.pt&quot;</span><span class="s4">, </span><span class="s6">&quot;-int8_edgetpu.tflite&quot;</span><span class="s4">)  </span><span class="s0"># Edge TPU model</span>
    <span class="s1">f_tfl </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">file</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;.pt&quot;</span><span class="s4">, </span><span class="s6">&quot;-int8.tflite&quot;</span><span class="s4">)  </span><span class="s0"># TFLite model</span>

    <span class="s1">subprocess</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span>
        <span class="s4">[</span>
            <span class="s6">&quot;edgetpu_compiler&quot;</span><span class="s4">,</span>
            <span class="s6">&quot;-s&quot;</span><span class="s4">,</span>
            <span class="s6">&quot;-d&quot;</span><span class="s4">,</span>
            <span class="s6">&quot;-k&quot;</span><span class="s4">,</span>
            <span class="s6">&quot;10&quot;</span><span class="s4">,</span>
            <span class="s6">&quot;--out_dir&quot;</span><span class="s4">,</span>
            <span class="s1">str</span><span class="s4">(</span><span class="s1">file</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">),</span>
            <span class="s1">f_tfl</span><span class="s4">,</span>
        <span class="s4">],</span>
        <span class="s1">check</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s3">None</span>


<span class="s4">@</span><span class="s1">try_export</span>
<span class="s3">def </span><span class="s1">export_tfjs</span><span class="s4">(</span><span class="s1">file</span><span class="s4">, </span><span class="s1">int8</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;TensorFlow.js:&quot;</span><span class="s4">)):</span>
    <span class="s0"># YOLOv5 TensorFlow.js export</span>
    <span class="s1">check_requirements</span><span class="s4">(</span><span class="s6">&quot;tensorflowjs&quot;</span><span class="s4">)</span>
    <span class="s3">import </span><span class="s1">tensorflowjs </span><span class="s3">as </span><span class="s1">tfjs</span>

    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting export with tensorflowjs </span><span class="s3">{</span><span class="s1">tfjs</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">file</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;.pt&quot;</span><span class="s4">, </span><span class="s6">&quot;_web_model&quot;</span><span class="s4">)  </span><span class="s0"># js dir</span>
    <span class="s1">f_pb </span><span class="s4">= </span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.pb&quot;</span><span class="s4">)  </span><span class="s0"># *.pb path</span>
    <span class="s1">f_json </span><span class="s4">= </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">f</span><span class="s3">}</span><span class="s6">/model.json&quot;  </span><span class="s0"># *.json path</span>

    <span class="s1">args </span><span class="s4">= [</span>
        <span class="s6">&quot;tensorflowjs_converter&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;--input_format=tf_frozen_model&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;--quantize_uint8&quot; </span><span class="s3">if </span><span class="s1">int8 </span><span class="s3">else </span><span class="s6">&quot;&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;--output_node_names=Identity,Identity_1,Identity_2,Identity_3&quot;</span><span class="s4">,</span>
        <span class="s1">str</span><span class="s4">(</span><span class="s1">f_pb</span><span class="s4">),</span>
        <span class="s1">str</span><span class="s4">(</span><span class="s1">f</span><span class="s4">),</span>
    <span class="s4">]</span>
    <span class="s1">subprocess</span><span class="s4">.</span><span class="s1">run</span><span class="s4">([</span><span class="s1">arg </span><span class="s3">for </span><span class="s1">arg </span><span class="s3">in </span><span class="s1">args </span><span class="s3">if </span><span class="s1">arg</span><span class="s4">], </span><span class="s1">check</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s1">json </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">f_json</span><span class="s4">).</span><span class="s1">read_text</span><span class="s4">()</span>
    <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">f_json</span><span class="s4">, </span><span class="s6">&quot;w&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">j</span><span class="s4">:  </span><span class="s0"># sort JSON Identity_* in ascending order</span>
        <span class="s1">subst </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">sub</span><span class="s4">(</span>
            <span class="s6">r'{&quot;outputs&quot;: {&quot;Identity.?.?&quot;: {&quot;name&quot;: &quot;Identity.?.?&quot;}, '</span>
            <span class="s6">r'&quot;Identity.?.?&quot;: {&quot;name&quot;: &quot;Identity.?.?&quot;}, '</span>
            <span class="s6">r'&quot;Identity.?.?&quot;: {&quot;name&quot;: &quot;Identity.?.?&quot;}, '</span>
            <span class="s6">r'&quot;Identity.?.?&quot;: {&quot;name&quot;: &quot;Identity.?.?&quot;}}}'</span><span class="s4">,</span>
            <span class="s6">r'{&quot;outputs&quot;: {&quot;Identity&quot;: {&quot;name&quot;: &quot;Identity&quot;}, '</span>
            <span class="s6">r'&quot;Identity_1&quot;: {&quot;name&quot;: &quot;Identity_1&quot;}, '</span>
            <span class="s6">r'&quot;Identity_2&quot;: {&quot;name&quot;: &quot;Identity_2&quot;}, '</span>
            <span class="s6">r'&quot;Identity_3&quot;: {&quot;name&quot;: &quot;Identity_3&quot;}}}'</span><span class="s4">,</span>
            <span class="s1">json</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s1">j</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s1">subst</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">f</span><span class="s4">, </span><span class="s3">None</span>


<span class="s3">def </span><span class="s1">add_tflite_metadata</span><span class="s4">(</span><span class="s1">file</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">, </span><span class="s1">num_outputs</span><span class="s4">):</span>
    <span class="s0"># Add metadata to *.tflite models per https://www.tensorflow.org/lite/models/convert/metadata</span>
    <span class="s3">with </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">suppress</span><span class="s4">(</span><span class="s1">ImportError</span><span class="s4">):</span>
        <span class="s0"># check_requirements('tflite_support')</span>
        <span class="s3">from </span><span class="s1">tflite_support </span><span class="s3">import </span><span class="s1">flatbuffers</span>
        <span class="s3">from </span><span class="s1">tflite_support </span><span class="s3">import </span><span class="s1">metadata </span><span class="s3">as </span><span class="s1">_metadata</span>
        <span class="s3">from </span><span class="s1">tflite_support </span><span class="s3">import </span><span class="s1">metadata_schema_py_generated </span><span class="s3">as </span><span class="s1">_metadata_fb</span>

        <span class="s1">tmp_file </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s6">&quot;/tmp/meta.txt&quot;</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">tmp_file</span><span class="s4">, </span><span class="s6">&quot;w&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">meta_f</span><span class="s4">:</span>
            <span class="s1">meta_f</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">metadata</span><span class="s4">))</span>

        <span class="s1">model_meta </span><span class="s4">= </span><span class="s1">_metadata_fb</span><span class="s4">.</span><span class="s1">ModelMetadataT</span><span class="s4">()</span>
        <span class="s1">label_file </span><span class="s4">= </span><span class="s1">_metadata_fb</span><span class="s4">.</span><span class="s1">AssociatedFileT</span><span class="s4">()</span>
        <span class="s1">label_file</span><span class="s4">.</span><span class="s1">name </span><span class="s4">= </span><span class="s1">tmp_file</span><span class="s4">.</span><span class="s1">name</span>
        <span class="s1">model_meta</span><span class="s4">.</span><span class="s1">associatedFiles </span><span class="s4">= [</span><span class="s1">label_file</span><span class="s4">]</span>

        <span class="s1">subgraph </span><span class="s4">= </span><span class="s1">_metadata_fb</span><span class="s4">.</span><span class="s1">SubGraphMetadataT</span><span class="s4">()</span>
        <span class="s1">subgraph</span><span class="s4">.</span><span class="s1">inputTensorMetadata </span><span class="s4">= [</span><span class="s1">_metadata_fb</span><span class="s4">.</span><span class="s1">TensorMetadataT</span><span class="s4">()]</span>
        <span class="s1">subgraph</span><span class="s4">.</span><span class="s1">outputTensorMetadata </span><span class="s4">= [</span><span class="s1">_metadata_fb</span><span class="s4">.</span><span class="s1">TensorMetadataT</span><span class="s4">()] * </span><span class="s1">num_outputs</span>
        <span class="s1">model_meta</span><span class="s4">.</span><span class="s1">subgraphMetadata </span><span class="s4">= [</span><span class="s1">subgraph</span><span class="s4">]</span>

        <span class="s1">b </span><span class="s4">= </span><span class="s1">flatbuffers</span><span class="s4">.</span><span class="s1">Builder</span><span class="s4">(</span><span class="s5">0</span><span class="s4">)</span>
        <span class="s1">b</span><span class="s4">.</span><span class="s1">Finish</span><span class="s4">(</span><span class="s1">model_meta</span><span class="s4">.</span><span class="s1">Pack</span><span class="s4">(</span><span class="s1">b</span><span class="s4">), </span><span class="s1">_metadata</span><span class="s4">.</span><span class="s1">MetadataPopulator</span><span class="s4">.</span><span class="s1">METADATA_FILE_IDENTIFIER</span><span class="s4">)</span>
        <span class="s1">metadata_buf </span><span class="s4">= </span><span class="s1">b</span><span class="s4">.</span><span class="s1">Output</span><span class="s4">()</span>

        <span class="s1">populator </span><span class="s4">= </span><span class="s1">_metadata</span><span class="s4">.</span><span class="s1">MetadataPopulator</span><span class="s4">.</span><span class="s1">with_model_file</span><span class="s4">(</span><span class="s1">file</span><span class="s4">)</span>
        <span class="s1">populator</span><span class="s4">.</span><span class="s1">load_metadata_buffer</span><span class="s4">(</span><span class="s1">metadata_buf</span><span class="s4">)</span>
        <span class="s1">populator</span><span class="s4">.</span><span class="s1">load_associated_files</span><span class="s4">([</span><span class="s1">str</span><span class="s4">(</span><span class="s1">tmp_file</span><span class="s4">)])</span>
        <span class="s1">populator</span><span class="s4">.</span><span class="s1">populate</span><span class="s4">()</span>
        <span class="s1">tmp_file</span><span class="s4">.</span><span class="s1">unlink</span><span class="s4">()</span>


<span class="s3">def </span><span class="s1">pipeline_coreml</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">names</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">&quot;CoreML Pipeline:&quot;</span><span class="s4">)):</span>
    <span class="s0"># YOLOv5 CoreML pipeline</span>
    <span class="s3">import </span><span class="s1">coremltools </span><span class="s3">as </span><span class="s1">ct</span>
    <span class="s3">from </span><span class="s1">PIL </span><span class="s3">import </span><span class="s1">Image</span>

    <span class="s1">print</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">starting pipeline with coremltools </span><span class="s3">{</span><span class="s1">ct</span><span class="s4">.</span><span class="s1">__version__</span><span class="s3">}</span><span class="s6">...&quot;</span><span class="s4">)</span>
    <span class="s1">batch_size</span><span class="s4">, </span><span class="s1">ch</span><span class="s4">, </span><span class="s1">h</span><span class="s4">, </span><span class="s1">w </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">im</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">)  </span><span class="s0"># BCHW</span>
    <span class="s1">t </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>

    <span class="s0"># YOLOv5 Output shapes</span>
    <span class="s1">spec </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">get_spec</span><span class="s4">()</span>
    <span class="s1">out0</span><span class="s4">, </span><span class="s1">out1 </span><span class="s4">= </span><span class="s1">iter</span><span class="s4">(</span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">output</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">platform</span><span class="s4">.</span><span class="s1">system</span><span class="s4">() == </span><span class="s6">&quot;Darwin&quot;</span><span class="s4">:</span>
        <span class="s1">img </span><span class="s4">= </span><span class="s1">Image</span><span class="s4">.</span><span class="s1">new</span><span class="s4">(</span><span class="s6">&quot;RGB&quot;</span><span class="s4">, (</span><span class="s1">w</span><span class="s4">, </span><span class="s1">h</span><span class="s4">))  </span><span class="s0"># img(192 width, 320 height)</span>
        <span class="s0"># img = torch.zeros((*opt.img_size, 3)).numpy()  # img size(320,192,3) iDetection</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">({</span><span class="s6">&quot;image&quot;</span><span class="s4">: </span><span class="s1">img</span><span class="s4">})</span>
        <span class="s1">out0_shape</span><span class="s4">, </span><span class="s1">out1_shape </span><span class="s4">= </span><span class="s1">out</span><span class="s4">[</span><span class="s1">out0</span><span class="s4">.</span><span class="s1">name</span><span class="s4">].</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">out</span><span class="s4">[</span><span class="s1">out1</span><span class="s4">.</span><span class="s1">name</span><span class="s4">].</span><span class="s1">shape</span>
    <span class="s3">else</span><span class="s4">:  </span><span class="s0"># linux and windows can not run model.predict(), get sizes from pytorch output y</span>
        <span class="s1">s </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">y</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">shape</span><span class="s4">)</span>
        <span class="s1">out0_shape</span><span class="s4">, </span><span class="s1">out1_shape </span><span class="s4">= (</span><span class="s1">s</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], </span><span class="s1">s</span><span class="s4">[</span><span class="s5">2</span><span class="s4">] - </span><span class="s5">5</span><span class="s4">), (</span><span class="s1">s</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], </span><span class="s5">4</span><span class="s4">)  </span><span class="s0"># (3780, 80), (3780, 4)</span>

    <span class="s0"># Checks</span>
    <span class="s1">nx</span><span class="s4">, </span><span class="s1">ny </span><span class="s4">= </span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">input</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">type</span><span class="s4">.</span><span class="s1">imageType</span><span class="s4">.</span><span class="s1">width</span><span class="s4">, </span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">input</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">type</span><span class="s4">.</span><span class="s1">imageType</span><span class="s4">.</span><span class="s1">height</span>
    <span class="s1">na</span><span class="s4">, </span><span class="s1">nc </span><span class="s4">= </span><span class="s1">out0_shape</span>
    <span class="s0"># na, nc = out0.type.multiArrayType.shape  # number anchors, classes</span>
    <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">names</span><span class="s4">) == </span><span class="s1">nc</span><span class="s4">, </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">len</span><span class="s4">(</span><span class="s1">names</span><span class="s4">)</span><span class="s3">} </span><span class="s6">names found for nc=</span><span class="s3">{</span><span class="s1">nc</span><span class="s3">}</span><span class="s6">&quot;  </span><span class="s0"># check</span>

    <span class="s0"># Define output shapes (missing)</span>
    <span class="s1">out0</span><span class="s4">.</span><span class="s1">type</span><span class="s4">.</span><span class="s1">multiArrayType</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[:] = </span><span class="s1">out0_shape  </span><span class="s0"># (3780, 80)</span>
    <span class="s1">out1</span><span class="s4">.</span><span class="s1">type</span><span class="s4">.</span><span class="s1">multiArrayType</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[:] = </span><span class="s1">out1_shape  </span><span class="s0"># (3780, 4)</span>
    <span class="s0"># spec.neuralNetwork.preprocessing[0].featureName = '0'</span>

    <span class="s0"># Flexible input shapes</span>
    <span class="s0"># from coremltools.models.neural_network import flexible_shape_utils</span>
    <span class="s0"># s = [] # shapes</span>
    <span class="s0"># s.append(flexible_shape_utils.NeuralNetworkImageSize(320, 192))</span>
    <span class="s0"># s.append(flexible_shape_utils.NeuralNetworkImageSize(640, 384))  # (height, width)</span>
    <span class="s0"># flexible_shape_utils.add_enumerated_image_sizes(spec, feature_name='image', sizes=s)</span>
    <span class="s0"># r = flexible_shape_utils.NeuralNetworkImageSizeRange()  # shape ranges</span>
    <span class="s0"># r.add_height_range((192, 640))</span>
    <span class="s0"># r.add_width_range((192, 640))</span>
    <span class="s0"># flexible_shape_utils.update_image_size_range(spec, feature_name='image', size_range=r)</span>

    <span class="s0"># Print</span>
    <span class="s1">print</span><span class="s4">(</span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">)</span>

    <span class="s0"># Model from spec</span>
    <span class="s1">model </span><span class="s4">= </span><span class="s1">ct</span><span class="s4">.</span><span class="s1">models</span><span class="s4">.</span><span class="s1">MLModel</span><span class="s4">(</span><span class="s1">spec</span><span class="s4">)</span>

    <span class="s0"># 3. Create NMS protobuf</span>
    <span class="s1">nms_spec </span><span class="s4">= </span><span class="s1">ct</span><span class="s4">.</span><span class="s1">proto</span><span class="s4">.</span><span class="s1">Model_pb2</span><span class="s4">.</span><span class="s1">Model</span><span class="s4">()</span>
    <span class="s1">nms_spec</span><span class="s4">.</span><span class="s1">specificationVersion </span><span class="s4">= </span><span class="s5">5</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s5">2</span><span class="s4">):</span>
        <span class="s1">decoder_output </span><span class="s4">= </span><span class="s1">model</span><span class="s4">.</span><span class="s1">_spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">output</span><span class="s4">[</span><span class="s1">i</span><span class="s4">].</span><span class="s1">SerializeToString</span><span class="s4">()</span>
        <span class="s1">nms_spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">input</span><span class="s4">.</span><span class="s1">add</span><span class="s4">()</span>
        <span class="s1">nms_spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">input</span><span class="s4">[</span><span class="s1">i</span><span class="s4">].</span><span class="s1">ParseFromString</span><span class="s4">(</span><span class="s1">decoder_output</span><span class="s4">)</span>
        <span class="s1">nms_spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">output</span><span class="s4">.</span><span class="s1">add</span><span class="s4">()</span>
        <span class="s1">nms_spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">output</span><span class="s4">[</span><span class="s1">i</span><span class="s4">].</span><span class="s1">ParseFromString</span><span class="s4">(</span><span class="s1">decoder_output</span><span class="s4">)</span>

    <span class="s1">nms_spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">output</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">name </span><span class="s4">= </span><span class="s6">&quot;confidence&quot;</span>
    <span class="s1">nms_spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">output</span><span class="s4">[</span><span class="s5">1</span><span class="s4">].</span><span class="s1">name </span><span class="s4">= </span><span class="s6">&quot;coordinates&quot;</span>

    <span class="s1">output_sizes </span><span class="s4">= [</span><span class="s1">nc</span><span class="s4">, </span><span class="s5">4</span><span class="s4">]</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s5">2</span><span class="s4">):</span>
        <span class="s1">ma_type </span><span class="s4">= </span><span class="s1">nms_spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">output</span><span class="s4">[</span><span class="s1">i</span><span class="s4">].</span><span class="s1">type</span><span class="s4">.</span><span class="s1">multiArrayType</span>
        <span class="s1">ma_type</span><span class="s4">.</span><span class="s1">shapeRange</span><span class="s4">.</span><span class="s1">sizeRanges</span><span class="s4">.</span><span class="s1">add</span><span class="s4">()</span>
        <span class="s1">ma_type</span><span class="s4">.</span><span class="s1">shapeRange</span><span class="s4">.</span><span class="s1">sizeRanges</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">lowerBound </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">ma_type</span><span class="s4">.</span><span class="s1">shapeRange</span><span class="s4">.</span><span class="s1">sizeRanges</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">upperBound </span><span class="s4">= -</span><span class="s5">1</span>
        <span class="s1">ma_type</span><span class="s4">.</span><span class="s1">shapeRange</span><span class="s4">.</span><span class="s1">sizeRanges</span><span class="s4">.</span><span class="s1">add</span><span class="s4">()</span>
        <span class="s1">ma_type</span><span class="s4">.</span><span class="s1">shapeRange</span><span class="s4">.</span><span class="s1">sizeRanges</span><span class="s4">[</span><span class="s5">1</span><span class="s4">].</span><span class="s1">lowerBound </span><span class="s4">= </span><span class="s1">output_sizes</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
        <span class="s1">ma_type</span><span class="s4">.</span><span class="s1">shapeRange</span><span class="s4">.</span><span class="s1">sizeRanges</span><span class="s4">[</span><span class="s5">1</span><span class="s4">].</span><span class="s1">upperBound </span><span class="s4">= </span><span class="s1">output_sizes</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
        <span class="s3">del </span><span class="s1">ma_type</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[:]</span>

    <span class="s1">nms </span><span class="s4">= </span><span class="s1">nms_spec</span><span class="s4">.</span><span class="s1">nonMaximumSuppression</span>
    <span class="s1">nms</span><span class="s4">.</span><span class="s1">confidenceInputFeatureName </span><span class="s4">= </span><span class="s1">out0</span><span class="s4">.</span><span class="s1">name  </span><span class="s0"># 1x507x80</span>
    <span class="s1">nms</span><span class="s4">.</span><span class="s1">coordinatesInputFeatureName </span><span class="s4">= </span><span class="s1">out1</span><span class="s4">.</span><span class="s1">name  </span><span class="s0"># 1x507x4</span>
    <span class="s1">nms</span><span class="s4">.</span><span class="s1">confidenceOutputFeatureName </span><span class="s4">= </span><span class="s6">&quot;confidence&quot;</span>
    <span class="s1">nms</span><span class="s4">.</span><span class="s1">coordinatesOutputFeatureName </span><span class="s4">= </span><span class="s6">&quot;coordinates&quot;</span>
    <span class="s1">nms</span><span class="s4">.</span><span class="s1">iouThresholdInputFeatureName </span><span class="s4">= </span><span class="s6">&quot;iouThreshold&quot;</span>
    <span class="s1">nms</span><span class="s4">.</span><span class="s1">confidenceThresholdInputFeatureName </span><span class="s4">= </span><span class="s6">&quot;confidenceThreshold&quot;</span>
    <span class="s1">nms</span><span class="s4">.</span><span class="s1">iouThreshold </span><span class="s4">= </span><span class="s5">0.45</span>
    <span class="s1">nms</span><span class="s4">.</span><span class="s1">confidenceThreshold </span><span class="s4">= </span><span class="s5">0.25</span>
    <span class="s1">nms</span><span class="s4">.</span><span class="s1">pickTop</span><span class="s4">.</span><span class="s1">perClass </span><span class="s4">= </span><span class="s3">True</span>
    <span class="s1">nms</span><span class="s4">.</span><span class="s1">stringClassLabels</span><span class="s4">.</span><span class="s1">vector</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">names</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>
    <span class="s1">nms_model </span><span class="s4">= </span><span class="s1">ct</span><span class="s4">.</span><span class="s1">models</span><span class="s4">.</span><span class="s1">MLModel</span><span class="s4">(</span><span class="s1">nms_spec</span><span class="s4">)</span>

    <span class="s0"># 4. Pipeline models together</span>
    <span class="s1">pipeline </span><span class="s4">= </span><span class="s1">ct</span><span class="s4">.</span><span class="s1">models</span><span class="s4">.</span><span class="s1">pipeline</span><span class="s4">.</span><span class="s1">Pipeline</span><span class="s4">(</span>
        <span class="s1">input_features</span><span class="s4">=[</span>
            <span class="s4">(</span><span class="s6">&quot;image&quot;</span><span class="s4">, </span><span class="s1">ct</span><span class="s4">.</span><span class="s1">models</span><span class="s4">.</span><span class="s1">datatypes</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">(</span><span class="s5">3</span><span class="s4">, </span><span class="s1">ny</span><span class="s4">, </span><span class="s1">nx</span><span class="s4">)),</span>
            <span class="s4">(</span><span class="s6">&quot;iouThreshold&quot;</span><span class="s4">, </span><span class="s1">ct</span><span class="s4">.</span><span class="s1">models</span><span class="s4">.</span><span class="s1">datatypes</span><span class="s4">.</span><span class="s1">Double</span><span class="s4">()),</span>
            <span class="s4">(</span><span class="s6">&quot;confidenceThreshold&quot;</span><span class="s4">, </span><span class="s1">ct</span><span class="s4">.</span><span class="s1">models</span><span class="s4">.</span><span class="s1">datatypes</span><span class="s4">.</span><span class="s1">Double</span><span class="s4">()),</span>
        <span class="s4">],</span>
        <span class="s1">output_features</span><span class="s4">=[</span><span class="s6">&quot;confidence&quot;</span><span class="s4">, </span><span class="s6">&quot;coordinates&quot;</span><span class="s4">],</span>
    <span class="s4">)</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">add_model</span><span class="s4">(</span><span class="s1">model</span><span class="s4">)</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">add_model</span><span class="s4">(</span><span class="s1">nms_model</span><span class="s4">)</span>

    <span class="s0"># Correct datatypes</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">input</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">ParseFromString</span><span class="s4">(</span><span class="s1">model</span><span class="s4">.</span><span class="s1">_spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">input</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">SerializeToString</span><span class="s4">())</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">output</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">ParseFromString</span><span class="s4">(</span><span class="s1">nms_model</span><span class="s4">.</span><span class="s1">_spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">output</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">SerializeToString</span><span class="s4">())</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">output</span><span class="s4">[</span><span class="s5">1</span><span class="s4">].</span><span class="s1">ParseFromString</span><span class="s4">(</span><span class="s1">nms_model</span><span class="s4">.</span><span class="s1">_spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">output</span><span class="s4">[</span><span class="s5">1</span><span class="s4">].</span><span class="s1">SerializeToString</span><span class="s4">())</span>

    <span class="s0"># Update metadata</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">spec</span><span class="s4">.</span><span class="s1">specificationVersion </span><span class="s4">= </span><span class="s5">5</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">metadata</span><span class="s4">.</span><span class="s1">versionString </span><span class="s4">= </span><span class="s6">&quot;https://github.com/ultralytics/yolov5&quot;</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">metadata</span><span class="s4">.</span><span class="s1">shortDescription </span><span class="s4">= </span><span class="s6">&quot;https://github.com/ultralytics/yolov5&quot;</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">metadata</span><span class="s4">.</span><span class="s1">author </span><span class="s4">= </span><span class="s6">&quot;glenn.jocher@ultralytics.com&quot;</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">metadata</span><span class="s4">.</span><span class="s1">license </span><span class="s4">= </span><span class="s6">&quot;https://github.com/ultralytics/yolov5/blob/master/LICENSE&quot;</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">spec</span><span class="s4">.</span><span class="s1">description</span><span class="s4">.</span><span class="s1">metadata</span><span class="s4">.</span><span class="s1">userDefined</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span>
        <span class="s4">{</span>
            <span class="s6">&quot;classes&quot;</span><span class="s4">: </span><span class="s6">&quot;,&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">names</span><span class="s4">.</span><span class="s1">values</span><span class="s4">()),</span>
            <span class="s6">&quot;iou_threshold&quot;</span><span class="s4">: </span><span class="s1">str</span><span class="s4">(</span><span class="s1">nms</span><span class="s4">.</span><span class="s1">iouThreshold</span><span class="s4">),</span>
            <span class="s6">&quot;confidence_threshold&quot;</span><span class="s4">: </span><span class="s1">str</span><span class="s4">(</span><span class="s1">nms</span><span class="s4">.</span><span class="s1">confidenceThreshold</span><span class="s4">),</span>
        <span class="s4">}</span>
    <span class="s4">)</span>

    <span class="s0"># Save the model</span>
    <span class="s1">f </span><span class="s4">= </span><span class="s1">file</span><span class="s4">.</span><span class="s1">with_suffix</span><span class="s4">(</span><span class="s6">&quot;.mlmodel&quot;</span><span class="s4">)  </span><span class="s0"># filename</span>
    <span class="s1">model </span><span class="s4">= </span><span class="s1">ct</span><span class="s4">.</span><span class="s1">models</span><span class="s4">.</span><span class="s1">MLModel</span><span class="s4">(</span><span class="s1">pipeline</span><span class="s4">.</span><span class="s1">spec</span><span class="s4">)</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">input_description</span><span class="s4">[</span><span class="s6">&quot;image&quot;</span><span class="s4">] = </span><span class="s6">&quot;Input image&quot;</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">input_description</span><span class="s4">[</span><span class="s6">&quot;iouThreshold&quot;</span><span class="s4">] = </span><span class="s6">f&quot;(optional) IOU Threshold override (default: </span><span class="s3">{</span><span class="s1">nms</span><span class="s4">.</span><span class="s1">iouThreshold</span><span class="s3">}</span><span class="s6">)&quot;</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">input_description</span><span class="s4">[</span>
        <span class="s6">&quot;confidenceThreshold&quot;</span>
    <span class="s4">] = </span><span class="s6">f&quot;(optional) Confidence Threshold override (default: </span><span class="s3">{</span><span class="s1">nms</span><span class="s4">.</span><span class="s1">confidenceThreshold</span><span class="s3">}</span><span class="s6">)&quot;</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">output_description</span><span class="s4">[</span><span class="s6">&quot;confidence&quot;</span><span class="s4">] = </span><span class="s6">'Boxes √ó Class confidence (see user-defined metadata &quot;classes&quot;)'</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">output_description</span><span class="s4">[</span><span class="s6">&quot;coordinates&quot;</span><span class="s4">] = </span><span class="s6">&quot;Boxes √ó [x, y, width, height] (relative to image size)&quot;</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">save</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)  </span><span class="s0"># pipelined</span>
    <span class="s1">print</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">} </span><span class="s6">pipeline success (</span><span class="s3">{</span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">() - </span><span class="s1">t</span><span class="s3">:</span><span class="s6">.2f</span><span class="s3">}</span><span class="s6">s), saved as </span><span class="s3">{</span><span class="s1">f</span><span class="s3">} </span><span class="s6">(</span><span class="s3">{</span><span class="s1">file_size</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span><span class="s3">:</span><span class="s6">.1f</span><span class="s3">} </span><span class="s6">MB)&quot;</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">smart_inference_mode</span><span class="s4">()</span>
<span class="s3">def </span><span class="s1">run</span><span class="s4">(</span>
    <span class="s1">data</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;data/coco128.yaml&quot;</span><span class="s4">,  </span><span class="s0"># 'dataset.yaml path'</span>
    <span class="s1">weights</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;yolov5s.pt&quot;</span><span class="s4">,  </span><span class="s0"># weights path</span>
    <span class="s1">imgsz</span><span class="s4">=(</span><span class="s5">640</span><span class="s4">, </span><span class="s5">640</span><span class="s4">),  </span><span class="s0"># image (height, width)</span>
    <span class="s1">batch_size</span><span class="s4">=</span><span class="s5">1</span><span class="s4">,  </span><span class="s0"># batch size</span>
    <span class="s1">device</span><span class="s4">=</span><span class="s6">&quot;cpu&quot;</span><span class="s4">,  </span><span class="s0"># cuda device, i.e. 0 or 0,1,2,3 or cpu</span>
    <span class="s1">include</span><span class="s4">=(</span><span class="s6">&quot;torchscript&quot;</span><span class="s4">, </span><span class="s6">&quot;onnx&quot;</span><span class="s4">),  </span><span class="s0"># include formats</span>
    <span class="s1">half</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># FP16 half-precision export</span>
    <span class="s1">inplace</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># set YOLOv5 Detect() inplace=True</span>
    <span class="s1">keras</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># use Keras</span>
    <span class="s1">optimize</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># TorchScript: optimize for mobile</span>
    <span class="s1">int8</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># CoreML/TF INT8 quantization</span>
    <span class="s1">per_tensor</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># TF per tensor quantization</span>
    <span class="s1">dynamic</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># ONNX/TF/TensorRT: dynamic axes</span>
    <span class="s1">simplify</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># ONNX: simplify model</span>
    <span class="s1">opset</span><span class="s4">=</span><span class="s5">12</span><span class="s4">,  </span><span class="s0"># ONNX: opset version</span>
    <span class="s1">verbose</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># TensorRT: verbose log</span>
    <span class="s1">workspace</span><span class="s4">=</span><span class="s5">4</span><span class="s4">,  </span><span class="s0"># TensorRT: workspace size (GB)</span>
    <span class="s1">nms</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># TF: add NMS to model</span>
    <span class="s1">agnostic_nms</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># TF: add agnostic NMS to model</span>
    <span class="s1">topk_per_class</span><span class="s4">=</span><span class="s5">100</span><span class="s4">,  </span><span class="s0"># TF.js NMS: topk per class to keep</span>
    <span class="s1">topk_all</span><span class="s4">=</span><span class="s5">100</span><span class="s4">,  </span><span class="s0"># TF.js NMS: topk for all classes to keep</span>
    <span class="s1">iou_thres</span><span class="s4">=</span><span class="s5">0.45</span><span class="s4">,  </span><span class="s0"># TF.js NMS: IoU threshold</span>
    <span class="s1">conf_thres</span><span class="s4">=</span><span class="s5">0.25</span><span class="s4">,  </span><span class="s0"># TF.js NMS: confidence threshold</span>
<span class="s4">):</span>
    <span class="s1">t </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
    <span class="s1">include </span><span class="s4">= [</span><span class="s1">x</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">() </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">include</span><span class="s4">]  </span><span class="s0"># to lowercase</span>
    <span class="s1">fmts </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">export_formats</span><span class="s4">()[</span><span class="s6">&quot;Argument&quot;</span><span class="s4">][</span><span class="s5">1</span><span class="s4">:])  </span><span class="s0"># --include arguments</span>
    <span class="s1">flags </span><span class="s4">= [</span><span class="s1">x </span><span class="s3">in </span><span class="s1">include </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">fmts</span><span class="s4">]</span>
    <span class="s3">assert </span><span class="s1">sum</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">) == </span><span class="s1">len</span><span class="s4">(</span><span class="s1">include</span><span class="s4">), </span><span class="s6">f&quot;ERROR: Invalid --include </span><span class="s3">{</span><span class="s1">include</span><span class="s3">}</span><span class="s6">, valid --include arguments are </span><span class="s3">{</span><span class="s1">fmts</span><span class="s3">}</span><span class="s6">&quot;</span>
    <span class="s1">jit</span><span class="s4">, </span><span class="s1">onnx</span><span class="s4">, </span><span class="s1">xml</span><span class="s4">, </span><span class="s1">engine</span><span class="s4">, </span><span class="s1">coreml</span><span class="s4">, </span><span class="s1">saved_model</span><span class="s4">, </span><span class="s1">pb</span><span class="s4">, </span><span class="s1">tflite</span><span class="s4">, </span><span class="s1">edgetpu</span><span class="s4">, </span><span class="s1">tfjs</span><span class="s4">, </span><span class="s1">paddle </span><span class="s4">= </span><span class="s1">flags  </span><span class="s0"># export booleans</span>
    <span class="s1">file </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s1">url2file</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">) </span><span class="s3">if </span><span class="s1">str</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">).</span><span class="s1">startswith</span><span class="s4">((</span><span class="s6">&quot;http:/&quot;</span><span class="s4">, </span><span class="s6">&quot;https:/&quot;</span><span class="s4">)) </span><span class="s3">else </span><span class="s1">weights</span><span class="s4">)  </span><span class="s0"># PyTorch weights</span>

    <span class="s0"># Load PyTorch model</span>
    <span class="s1">device </span><span class="s4">= </span><span class="s1">select_device</span><span class="s4">(</span><span class="s1">device</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">half</span><span class="s4">:</span>
        <span class="s3">assert </span><span class="s1">device</span><span class="s4">.</span><span class="s1">type </span><span class="s4">!= </span><span class="s6">&quot;cpu&quot; </span><span class="s3">or </span><span class="s1">coreml</span><span class="s4">, </span><span class="s6">&quot;--half only compatible with GPU export, i.e. use --device 0&quot;</span>
        <span class="s3">assert not </span><span class="s1">dynamic</span><span class="s4">, </span><span class="s6">&quot;--half not compatible with --dynamic, i.e. use either --half or --dynamic but not both&quot;</span>
    <span class="s1">model </span><span class="s4">= </span><span class="s1">attempt_load</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">, </span><span class="s1">device</span><span class="s4">=</span><span class="s1">device</span><span class="s4">, </span><span class="s1">inplace</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">fuse</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)  </span><span class="s0"># load FP32 model</span>

    <span class="s0"># Checks</span>
    <span class="s1">imgsz </span><span class="s4">*= </span><span class="s5">2 </span><span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">imgsz</span><span class="s4">) == </span><span class="s5">1 </span><span class="s3">else </span><span class="s5">1  </span><span class="s0"># expand</span>
    <span class="s3">if </span><span class="s1">optimize</span><span class="s4">:</span>
        <span class="s3">assert </span><span class="s1">device</span><span class="s4">.</span><span class="s1">type </span><span class="s4">== </span><span class="s6">&quot;cpu&quot;</span><span class="s4">, </span><span class="s6">&quot;--optimize not compatible with cuda devices, i.e. use --device cpu&quot;</span>

    <span class="s0"># Input</span>
    <span class="s1">gs </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">max</span><span class="s4">(</span><span class="s1">model</span><span class="s4">.</span><span class="s1">stride</span><span class="s4">))  </span><span class="s0"># grid size (max stride)</span>
    <span class="s1">imgsz </span><span class="s4">= [</span><span class="s1">check_img_size</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">gs</span><span class="s4">) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">imgsz</span><span class="s4">]  </span><span class="s0"># verify img_size are gs-multiples</span>
    <span class="s1">im </span><span class="s4">= </span><span class="s1">torch</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">(</span><span class="s1">batch_size</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, *</span><span class="s1">imgsz</span><span class="s4">).</span><span class="s1">to</span><span class="s4">(</span><span class="s1">device</span><span class="s4">)  </span><span class="s0"># image size(1,3,320,192) BCHW iDetection</span>

    <span class="s0"># Update model</span>
    <span class="s1">model</span><span class="s4">.</span><span class="s1">eval</span><span class="s4">()</span>
    <span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">m </span><span class="s3">in </span><span class="s1">model</span><span class="s4">.</span><span class="s1">named_modules</span><span class="s4">():</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">m</span><span class="s4">, </span><span class="s1">Detect</span><span class="s4">):</span>
            <span class="s1">m</span><span class="s4">.</span><span class="s1">inplace </span><span class="s4">= </span><span class="s1">inplace</span>
            <span class="s1">m</span><span class="s4">.</span><span class="s1">dynamic </span><span class="s4">= </span><span class="s1">dynamic</span>
            <span class="s1">m</span><span class="s4">.</span><span class="s1">export </span><span class="s4">= </span><span class="s3">True</span>

    <span class="s3">for </span><span class="s1">_ </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s5">2</span><span class="s4">):</span>
        <span class="s1">y </span><span class="s4">= </span><span class="s1">model</span><span class="s4">(</span><span class="s1">im</span><span class="s4">)  </span><span class="s0"># dry runs</span>
    <span class="s3">if </span><span class="s1">half </span><span class="s3">and not </span><span class="s1">coreml</span><span class="s4">:</span>
        <span class="s1">im</span><span class="s4">, </span><span class="s1">model </span><span class="s4">= </span><span class="s1">im</span><span class="s4">.</span><span class="s1">half</span><span class="s4">(), </span><span class="s1">model</span><span class="s4">.</span><span class="s1">half</span><span class="s4">()  </span><span class="s0"># to FP16</span>
    <span class="s1">shape </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">((</span><span class="s1">y</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">) </span><span class="s3">else </span><span class="s1">y</span><span class="s4">).</span><span class="s1">shape</span><span class="s4">)  </span><span class="s0"># model output shape</span>
    <span class="s1">metadata </span><span class="s4">= {</span><span class="s6">&quot;stride&quot;</span><span class="s4">: </span><span class="s1">int</span><span class="s4">(</span><span class="s1">max</span><span class="s4">(</span><span class="s1">model</span><span class="s4">.</span><span class="s1">stride</span><span class="s4">)), </span><span class="s6">&quot;names&quot;</span><span class="s4">: </span><span class="s1">model</span><span class="s4">.</span><span class="s1">names</span><span class="s4">}  </span><span class="s0"># model metadata</span>
    <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">\n{</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">'PyTorch:'</span><span class="s4">)</span><span class="s3">} </span><span class="s6">starting from </span><span class="s3">{</span><span class="s1">file</span><span class="s3">} </span><span class="s6">with output shape </span><span class="s3">{</span><span class="s1">shape</span><span class="s3">} </span><span class="s6">(</span><span class="s3">{</span><span class="s1">file_size</span><span class="s4">(</span><span class="s1">file</span><span class="s4">)</span><span class="s3">:</span><span class="s6">.1f</span><span class="s3">} </span><span class="s6">MB)&quot;</span><span class="s4">)</span>

    <span class="s0"># Exports</span>
    <span class="s1">f </span><span class="s4">= [</span><span class="s6">&quot;&quot;</span><span class="s4">] * </span><span class="s1">len</span><span class="s4">(</span><span class="s1">fmts</span><span class="s4">)  </span><span class="s0"># exported filenames</span>
    <span class="s1">warnings</span><span class="s4">.</span><span class="s1">filterwarnings</span><span class="s4">(</span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;ignore&quot;</span><span class="s4">, </span><span class="s1">category</span><span class="s4">=</span><span class="s1">torch</span><span class="s4">.</span><span class="s1">jit</span><span class="s4">.</span><span class="s1">TracerWarning</span><span class="s4">)  </span><span class="s0"># suppress TracerWarning</span>
    <span class="s3">if </span><span class="s1">jit</span><span class="s4">:  </span><span class="s0"># TorchScript</span>
        <span class="s1">f</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">export_torchscript</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">optimize</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">engine</span><span class="s4">:  </span><span class="s0"># TensorRT required before ONNX</span>
        <span class="s1">f</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">export_engine</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">half</span><span class="s4">, </span><span class="s1">dynamic</span><span class="s4">, </span><span class="s1">simplify</span><span class="s4">, </span><span class="s1">workspace</span><span class="s4">, </span><span class="s1">verbose</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">onnx </span><span class="s3">or </span><span class="s1">xml</span><span class="s4">:  </span><span class="s0"># OpenVINO requires ONNX</span>
        <span class="s1">f</span><span class="s4">[</span><span class="s5">2</span><span class="s4">], </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">export_onnx</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">opset</span><span class="s4">, </span><span class="s1">dynamic</span><span class="s4">, </span><span class="s1">simplify</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">xml</span><span class="s4">:  </span><span class="s0"># OpenVINO</span>
        <span class="s1">f</span><span class="s4">[</span><span class="s5">3</span><span class="s4">], </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">export_openvino</span><span class="s4">(</span><span class="s1">file</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">, </span><span class="s1">half</span><span class="s4">, </span><span class="s1">int8</span><span class="s4">, </span><span class="s1">data</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">coreml</span><span class="s4">:  </span><span class="s0"># CoreML</span>
        <span class="s1">f</span><span class="s4">[</span><span class="s5">4</span><span class="s4">], </span><span class="s1">ct_model </span><span class="s4">= </span><span class="s1">export_coreml</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">int8</span><span class="s4">, </span><span class="s1">half</span><span class="s4">, </span><span class="s1">nms</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">nms</span><span class="s4">:</span>
            <span class="s1">pipeline_coreml</span><span class="s4">(</span><span class="s1">ct_model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">model</span><span class="s4">.</span><span class="s1">names</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">any</span><span class="s4">((</span><span class="s1">saved_model</span><span class="s4">, </span><span class="s1">pb</span><span class="s4">, </span><span class="s1">tflite</span><span class="s4">, </span><span class="s1">edgetpu</span><span class="s4">, </span><span class="s1">tfjs</span><span class="s4">)):  </span><span class="s0"># TensorFlow formats</span>
        <span class="s3">assert not </span><span class="s1">tflite </span><span class="s3">or not </span><span class="s1">tfjs</span><span class="s4">, </span><span class="s6">&quot;TFLite and TF.js models must be exported separately, please pass only one type.&quot;</span>
        <span class="s3">assert not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">ClassificationModel</span><span class="s4">), </span><span class="s6">&quot;ClassificationModel export to TF formats not yet supported.&quot;</span>
        <span class="s1">f</span><span class="s4">[</span><span class="s5">5</span><span class="s4">], </span><span class="s1">s_model </span><span class="s4">= </span><span class="s1">export_saved_model</span><span class="s4">(</span>
            <span class="s1">model</span><span class="s4">.</span><span class="s1">cpu</span><span class="s4">(),</span>
            <span class="s1">im</span><span class="s4">,</span>
            <span class="s1">file</span><span class="s4">,</span>
            <span class="s1">dynamic</span><span class="s4">,</span>
            <span class="s1">tf_nms</span><span class="s4">=</span><span class="s1">nms </span><span class="s3">or </span><span class="s1">agnostic_nms </span><span class="s3">or </span><span class="s1">tfjs</span><span class="s4">,</span>
            <span class="s1">agnostic_nms</span><span class="s4">=</span><span class="s1">agnostic_nms </span><span class="s3">or </span><span class="s1">tfjs</span><span class="s4">,</span>
            <span class="s1">topk_per_class</span><span class="s4">=</span><span class="s1">topk_per_class</span><span class="s4">,</span>
            <span class="s1">topk_all</span><span class="s4">=</span><span class="s1">topk_all</span><span class="s4">,</span>
            <span class="s1">iou_thres</span><span class="s4">=</span><span class="s1">iou_thres</span><span class="s4">,</span>
            <span class="s1">conf_thres</span><span class="s4">=</span><span class="s1">conf_thres</span><span class="s4">,</span>
            <span class="s1">keras</span><span class="s4">=</span><span class="s1">keras</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s3">if </span><span class="s1">pb </span><span class="s3">or </span><span class="s1">tfjs</span><span class="s4">:  </span><span class="s0"># pb prerequisite to tfjs</span>
            <span class="s1">f</span><span class="s4">[</span><span class="s5">6</span><span class="s4">], </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">export_pb</span><span class="s4">(</span><span class="s1">s_model</span><span class="s4">, </span><span class="s1">file</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">tflite </span><span class="s3">or </span><span class="s1">edgetpu</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">[</span><span class="s5">7</span><span class="s4">], </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">export_tflite</span><span class="s4">(</span>
                <span class="s1">s_model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">int8 </span><span class="s3">or </span><span class="s1">edgetpu</span><span class="s4">, </span><span class="s1">per_tensor</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">data</span><span class="s4">, </span><span class="s1">nms</span><span class="s4">=</span><span class="s1">nms</span><span class="s4">, </span><span class="s1">agnostic_nms</span><span class="s4">=</span><span class="s1">agnostic_nms</span>
            <span class="s4">)</span>
            <span class="s3">if </span><span class="s1">edgetpu</span><span class="s4">:</span>
                <span class="s1">f</span><span class="s4">[</span><span class="s5">8</span><span class="s4">], </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">export_edgetpu</span><span class="s4">(</span><span class="s1">file</span><span class="s4">)</span>
            <span class="s1">add_tflite_metadata</span><span class="s4">(</span><span class="s1">f</span><span class="s4">[</span><span class="s5">8</span><span class="s4">] </span><span class="s3">or </span><span class="s1">f</span><span class="s4">[</span><span class="s5">7</span><span class="s4">], </span><span class="s1">metadata</span><span class="s4">, </span><span class="s1">num_outputs</span><span class="s4">=</span><span class="s1">len</span><span class="s4">(</span><span class="s1">s_model</span><span class="s4">.</span><span class="s1">outputs</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">tfjs</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">[</span><span class="s5">9</span><span class="s4">], </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">export_tfjs</span><span class="s4">(</span><span class="s1">file</span><span class="s4">, </span><span class="s1">int8</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">paddle</span><span class="s4">:  </span><span class="s0"># PaddlePaddle</span>
        <span class="s1">f</span><span class="s4">[</span><span class="s5">10</span><span class="s4">], </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">export_paddle</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">im</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">)</span>

    <span class="s0"># Finish</span>
    <span class="s1">f </span><span class="s4">= [</span><span class="s1">str</span><span class="s4">(</span><span class="s1">x</span><span class="s4">) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">f </span><span class="s3">if </span><span class="s1">x</span><span class="s4">]  </span><span class="s0"># filter out '' and None</span>
    <span class="s3">if </span><span class="s1">any</span><span class="s4">(</span><span class="s1">f</span><span class="s4">):</span>
        <span class="s1">cls</span><span class="s4">, </span><span class="s1">det</span><span class="s4">, </span><span class="s1">seg </span><span class="s4">= (</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">model</span><span class="s4">, </span><span class="s1">x</span><span class="s4">) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s4">(</span><span class="s1">ClassificationModel</span><span class="s4">, </span><span class="s1">DetectionModel</span><span class="s4">, </span><span class="s1">SegmentationModel</span><span class="s4">))  </span><span class="s0"># type</span>
        <span class="s1">det </span><span class="s4">&amp;= </span><span class="s3">not </span><span class="s1">seg  </span><span class="s0"># segmentation models inherit from SegmentationModel(DetectionModel)</span>
        <span class="s1">dir </span><span class="s4">= </span><span class="s1">Path</span><span class="s4">(</span><span class="s6">&quot;segment&quot; </span><span class="s3">if </span><span class="s1">seg </span><span class="s3">else </span><span class="s6">&quot;classify&quot; </span><span class="s3">if </span><span class="s1">cls </span><span class="s3">else </span><span class="s6">&quot;&quot;</span><span class="s4">)</span>
        <span class="s1">h </span><span class="s4">= </span><span class="s6">&quot;--half&quot; </span><span class="s3">if </span><span class="s1">half </span><span class="s3">else </span><span class="s6">&quot;&quot;  </span><span class="s0"># --half FP16 inference arg</span>
        <span class="s1">s </span><span class="s4">= (</span>
            <span class="s6">&quot;# WARNING ‚ö†Ô∏è ClassificationModel not yet supported for PyTorch Hub AutoShape inference&quot;</span>
            <span class="s3">if </span><span class="s1">cls</span>
            <span class="s3">else </span><span class="s6">&quot;# WARNING ‚ö†Ô∏è SegmentationModel not yet supported for PyTorch Hub AutoShape inference&quot;</span>
            <span class="s3">if </span><span class="s1">seg</span>
            <span class="s3">else </span><span class="s6">&quot;&quot;</span>
        <span class="s4">)</span>
        <span class="s1">LOGGER</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span>
            <span class="s6">f'</span><span class="s3">\n</span><span class="s6">Export complete (</span><span class="s3">{</span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">() - </span><span class="s1">t</span><span class="s3">:</span><span class="s6">.1f</span><span class="s3">}</span><span class="s6">s)'</span>
            <span class="s6">f&quot;</span><span class="s3">\n</span><span class="s6">Results saved to </span><span class="s3">{</span><span class="s1">colorstr</span><span class="s4">(</span><span class="s6">'bold'</span><span class="s4">, </span><span class="s1">file</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">.</span><span class="s1">resolve</span><span class="s4">())</span><span class="s3">}</span><span class="s6">&quot;</span>
            <span class="s6">f&quot;</span><span class="s3">\n</span><span class="s6">Detect:          python </span><span class="s3">{</span><span class="s1">dir </span><span class="s4">/ (</span><span class="s6">'detect.py' </span><span class="s3">if </span><span class="s1">det </span><span class="s3">else </span><span class="s6">'predict.py'</span><span class="s4">)</span><span class="s3">} </span><span class="s6">--weights </span><span class="s3">{</span><span class="s1">f</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">]</span><span class="s3">} {</span><span class="s1">h</span><span class="s3">}</span><span class="s6">&quot;</span>
            <span class="s6">f&quot;</span><span class="s3">\n</span><span class="s6">Validate:        python </span><span class="s3">{</span><span class="s1">dir </span><span class="s4">/ </span><span class="s6">'val.py'</span><span class="s3">} </span><span class="s6">--weights </span><span class="s3">{</span><span class="s1">f</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">]</span><span class="s3">} {</span><span class="s1">h</span><span class="s3">}</span><span class="s6">&quot;</span>
            <span class="s6">f&quot;</span><span class="s3">\n</span><span class="s6">PyTorch Hub:     model = torch.hub.load('ultralytics/yolov5', 'custom', '</span><span class="s3">{</span><span class="s1">f</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">]</span><span class="s3">}</span><span class="s6">')  </span><span class="s3">{</span><span class="s1">s</span><span class="s3">}</span><span class="s6">&quot;</span>
            <span class="s6">f'</span><span class="s3">\n</span><span class="s6">Visualize:       https://netron.app'</span>
        <span class="s4">)</span>
    <span class="s3">return </span><span class="s1">f  </span><span class="s0"># return list of exported files/dirs</span>


<span class="s3">def </span><span class="s1">parse_opt</span><span class="s4">(</span><span class="s1">known</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
    <span class="s1">parser </span><span class="s4">= </span><span class="s1">argparse</span><span class="s4">.</span><span class="s1">ArgumentParser</span><span class="s4">()</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--data&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;data/coco128.yaml&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;dataset.yaml path&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--weights&quot;</span><span class="s4">, </span><span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;+&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">ROOT </span><span class="s4">/ </span><span class="s6">&quot;yolov5s.pt&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;model.pt path(s)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--imgsz&quot;</span><span class="s4">, </span><span class="s6">&quot;--img&quot;</span><span class="s4">, </span><span class="s6">&quot;--img-size&quot;</span><span class="s4">, </span><span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;+&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=[</span><span class="s5">640</span><span class="s4">, </span><span class="s5">640</span><span class="s4">], </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;image (h, w)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--batch-size&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;batch size&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--device&quot;</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">&quot;cpu&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;cuda device, i.e. 0 or 0,1,2,3 or cpu&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--half&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;FP16 half-precision export&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--inplace&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;set YOLOv5 Detect() inplace=True&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--keras&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;TF: use Keras&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--optimize&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;TorchScript: optimize for mobile&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--int8&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;CoreML/TF/OpenVINO INT8 quantization&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--per-tensor&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;TF per-tensor quantization&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--dynamic&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;ONNX/TF/TensorRT: dynamic axes&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--simplify&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;ONNX: simplify model&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--opset&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">17</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;ONNX: opset version&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--verbose&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;TensorRT: verbose log&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--workspace&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">4</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;TensorRT: workspace size (GB)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--nms&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;TF: add NMS to model&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--agnostic-nms&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s6">&quot;store_true&quot;</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;TF: add agnostic NMS to model&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--topk-per-class&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">100</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;TF.js NMS: topk per class to keep&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--topk-all&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">100</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;TF.js NMS: topk for all classes to keep&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--iou-thres&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">float</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">0.45</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;TF.js NMS: IoU threshold&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span><span class="s6">&quot;--conf-thres&quot;</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s1">float</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">0.25</span><span class="s4">, </span><span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;TF.js NMS: confidence threshold&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span>
        <span class="s6">&quot;--include&quot;</span><span class="s4">,</span>
        <span class="s1">nargs</span><span class="s4">=</span><span class="s6">&quot;+&quot;</span><span class="s4">,</span>
        <span class="s1">default</span><span class="s4">=[</span><span class="s6">&quot;torchscript&quot;</span><span class="s4">],</span>
        <span class="s1">help</span><span class="s4">=</span><span class="s6">&quot;torchscript, onnx, openvino, engine, coreml, saved_model, pb, tflite, edgetpu, tfjs, paddle&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">opt </span><span class="s4">= </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse_known_args</span><span class="s4">()[</span><span class="s5">0</span><span class="s4">] </span><span class="s3">if </span><span class="s1">known </span><span class="s3">else </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse_args</span><span class="s4">()</span>
    <span class="s1">print_args</span><span class="s4">(</span><span class="s1">vars</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">))</span>
    <span class="s3">return </span><span class="s1">opt</span>


<span class="s3">def </span><span class="s1">main</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">):</span>
    <span class="s3">for </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights </span><span class="s3">in </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights</span><span class="s4">, </span><span class="s1">list</span><span class="s4">) </span><span class="s3">else </span><span class="s4">[</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">weights</span><span class="s4">]:</span>
        <span class="s1">run</span><span class="s4">(**</span><span class="s1">vars</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">))</span>


<span class="s3">if </span><span class="s1">__name__ </span><span class="s4">== </span><span class="s6">&quot;__main__&quot;</span><span class="s4">:</span>
    <span class="s1">opt </span><span class="s4">= </span><span class="s1">parse_opt</span><span class="s4">()</span>
    <span class="s1">main</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">)</span>
</pre>
</body>
</html>